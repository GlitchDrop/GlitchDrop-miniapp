<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>GLITCH DROP — Mini App</title>

  <style>
    :root{
      --bg-top:#0c1822; --bg-bot:#0e2230; --grid:rgba(255,255,255,.035); --grid-gap:34px;
      --panel:#0a0f1e; --panel2:#0a0d19; --card:#0e1330; --card2:#0b0f26;
      --neon-cyan:#16f1ff; --neon-pink:#ff3ed0; --neon-yellow:#ffe47a;
      --text:#e8efff; --muted:#9fb2d9; --border:rgba(120,180,255,.25);
      --shadow-strong:0 20px 60px rgba(10,20,60,.55), 0 0 60px rgba(22,241,255,.08);
      --shadow-soft:0 10px 30px rgba(10,20,60,.35);
      --radius:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif}
    html{scroll-behavior:smooth; scrollbar-gutter: stable;}
    body{ color:var(--text); overflow-x:hidden; background:#0e1b25; overflow-y:scroll; }
    .cyber-bg{
      position:fixed; inset:0; z-index:0; pointer-events:none;
      background:
        linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bot) 100%),
        repeating-linear-gradient(0deg,  var(--grid) 0 1px,  transparent 1px var(--grid-gap)),
        repeating-linear-gradient(90deg, var(--grid) 0 1px,  transparent 1px var(--grid-gap));
      background-blend-mode: normal, overlay, overlay;
    }

    .app{min-height:100%;display:flex;flex-direction:column;position:relative;z-index:1}

    .topbar{
      position:sticky; top:0; z-index:30;
      display:flex; align-items:center; gap:12px;
      padding:12px 14px;
      background:linear-gradient(180deg,rgba(8,14,36,.72),rgba(6,10,26,.62));
      border-bottom:1px solid var(--border);
      backdrop-filter:blur(10px);
      box-shadow:var(--shadow-soft);
    }
    .avatar{ width:42px; height:42px; border-radius:50%; border:2px solid rgba(22,241,255,.55); box-shadow:0 0 18px rgba(22,241,255,.28), 0 0 28px rgba(255,62,208,.18); object-fit:cover; background:linear-gradient(135deg, rgba(22,241,255,.15), rgba(255,62,208,.15)); }
    .avatar.hidden{ display:none; }
    .avatar-fallback{ width:42px; height:42px; border-radius:12px; display:grid; place-items:center; background:linear-gradient(135deg, rgba(22,241,255,.18), rgba(255,62,208,.18)); border:1px solid var(--border); font-weight:900; letter-spacing:.5px; color:#081121; text-shadow:0 0 12px rgba(22,241,255,.7); }
    .brand{position:relative; font-weight:900; line-height:1; letter-spacing:1px}
    .brand .glitch{ font-size:22px; color:#cfe6ff; position:relative; display:inline-block; text-shadow:0 0 24px rgba(22,241,255,.55), 0 0 24px rgba(255,62,208,.35); }
    .brand .glitch::before,.brand .glitch::after{ content:attr(data-text); position:absolute; left:0; top:0; width:100%; overflow:hidden; }
    .brand .glitch::before{ transform:translateX(1px); color:var(--neon-cyan); opacity:.9; text-shadow:0 0 10px rgba(22,241,255,.8); animation:glitch 3s infinite ease-in-out;}
    .brand .glitch::after { transform:translateX(-1px); color:var(--neon-pink); opacity:.8; text-shadow:0 0 10px rgba(255,62,208,.8); animation:glitch 2.6s infinite ease-in-out reverse;}
    @keyframes glitch{ 0%,100%{clip-path:inset(0 0 0 0)} 10%{clip-path:inset(0 0 65% 0)} 20%{clip-path:inset(0 0 0 0)} 30%{clip-path:inset(40% 0 0 0)} 45%{clip-path:inset(0 0 0 0)} 60%{clip-path:inset(0 0 75% 0)} 80%{clip-path:inset(20% 0 10% 0)} }
    .grow{flex:1}

    .pill{
      display:flex; align-items:center; gap:10px; padding:8px 12px;
      border-radius:999px; border:1px solid var(--border);
      background:linear-gradient(135deg, rgba(22,241,255,.1), rgba(138,92,255,.12));
      box-shadow:0 0 18px rgba(22,241,255,.12) inset;
      font-weight:900; color:#cfe6ff;
    }
    /* базовый размер иконок */
    .pill img{width:18px; height:18px; display:block; object-fit:cover; border-radius:4px}
    /* единый увеличенный размер для обеих пилюль */
    .pill--lg{ padding:10px 14px; }
    .pill--lg img{ width:24px; height:24px; }

    .chipbar{
      position:sticky; top:64px; z-index:25;
      display:flex; gap:10px; padding:10px 14px; overflow-x:auto;
      background:linear-gradient(180deg,rgba(8,14,36,.72),rgba(6,10,26,.62));
      border-bottom:1px solid var(--border);
      backdrop-filter:blur(10px);
    }
    .chipbar::-webkit-scrollbar{display:none}
    .chip{
      padding:10px 14px; border-radius:999px; white-space:nowrap; cursor:pointer;
      border:1px solid var(--border); color:#9fb2d9; font-weight:800; user-select:none;
      background:linear-gradient(135deg, rgba(15,20,48,.7), rgba(12,16,38,.7));
      transition:transform .15s, box-shadow .15s, color .15s, background .2s, border-color .2s;
    }
    .chip:hover{ transform:translateY(-1px); box-shadow:0 8px 22px rgba(22,241,255,.12)}
    .chip.active{ color:#081121 !important; background:linear-gradient(135deg, var(--neon-cyan), var(--neon-pink)) !important; border-color:transparent !important; box-shadow:0 6px 28px rgba(22,241,255,.35), 0 0 44px rgba(255,62,208,.25) !important; }

    .content{flex:1; padding:16px; max-width:1100px; margin:0 auto; width:100%}
    h2.section{ margin:20px 0 12px; text-align:center; font-size:13px; letter-spacing:2px; opacity:.95; color:#d7e6ff; text-shadow:0 0 16px rgba(22,241,255,.25); scroll-margin-top:130px; }
    .grid{display:grid; grid-template-columns:repeat(2,1fr); gap:14px}

    /* ====== CARD кейса (без флипа) ====== */
    .card{ position:relative; background:linear-gradient(180deg, rgba(20,26,62,.55), rgba(14,18,40,.6)); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow-strong); padding:12px; display:flex; flex-direction:column; gap:10px; overflow:hidden; cursor:pointer; }
    .card::before{ content:""; position:absolute; inset:-2px; background:conic-gradient(from 200deg, transparent, rgba(22,241,255,.18), transparent 30%, rgba(255,62,208,.18), transparent 55%); filter:blur(14px); opacity:.35; z-index:0; }
    .inner{position:relative; z-index:1}
    .thumb{
      height:160px; border-radius:14px; border:1px dashed rgba(180,210,255,.35);
      background: radial-gradient(120px 80px at 20% 20%, rgba(22,241,255,.12), transparent 60%), radial-gradient(120px 80px at 80% 80%, rgba(255,62,208,.10), transparent 60%), linear-gradient(180deg,#0c1230,#0a1028);
      display:grid; place-items:center; color:#a9c2ff; font-size:12px; text-transform:uppercase; letter-spacing:1px;
      overflow:hidden;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .name{font-weight:900; letter-spacing:.3px}
    .desc{font-size:12px; color:#9fb2d9}
    .price{font-weight:900; color:var(--neon-yellow); text-shadow:0 0 12px rgba(255,228,122,.25)}

    .tabbar{ position:sticky; bottom:0; z-index:24; background:linear-gradient(180deg,rgba(8,14,36,.72),rgba(6,10,26,.62)); border-top:1px solid var(--border); backdrop-filter:blur(10px); display:grid; grid-template-columns:repeat(5,1fr); padding:8px 6px }
    .tab{display:flex; flex-direction:column; align-items:center; gap:4px; padding:6px 2px; color:#9fb2d9; font-size:12px; font-weight:800}
    .tab.active{color:#e8efff}
    .ico{font-size:18px; text-shadow:0 0 10px rgba(22,241,255,.3)}

    .backtop{ position:fixed; right:14px; bottom:90px; z-index:50; padding:9px 12px; border-radius:12px; font-weight:900; font-size:12px; letter-spacing:.3px; border:1px solid rgba(22,241,255,.45); color:#081121; background:linear-gradient(135deg, var(--neon-cyan), var(--neon-pink)); box-shadow:0 10px 28px rgba(22,241,255,.35), 0 0 36px rgba(255,62,208,.25); opacity:0; pointer-events:none; transform:translateY(8px); transition:opacity .2s, transform .2s; }
    .backtop.show{opacity:1; pointer-events:auto; transform:translateY(0)}

    /* ===== DETAIL VIEW ===== */
    .detail{
      position:fixed; inset:0; z-index:60; display:none; flex-direction:column;
      background:
        linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bot) 100%),
        repeating-linear-gradient(0deg,  var(--grid) 0 1px,  transparent 1px var(--grid-gap)),
        repeating-linear-gradient(90deg, var(--grid) 0 1px,  transparent 1px var(--grid-gap));
      background-blend-mode: normal, overlay, overlay;
      overflow:auto;
    }
    .detail.show{ display:flex; }
    .d-topbar{ position:sticky; top:0; z-index:61; display:flex; align-items:center; gap:10px; padding:10px 14px; background:linear-gradient(180deg,rgba(8,14,36,.82),rgba(6,10,26,.7)); border-bottom:1px solid var(--border); backdrop-filter:blur(10px); }
    .btn-back{ appearance:none; border:1px solid var(--border); background:transparent; color:var(--text); padding:8px 12px; border-radius:12px; font-weight:900; cursor:pointer; }
    .d-title{font-weight:900}
    .d-body{padding:16px; max-width:1100px; margin:0 auto; width:100%}
    .d-hero{display:grid; grid-template-columns:1fr; gap:14px; margin-bottom:10px;}
    .d-thumb{ min-height:200px; height:auto; border-radius:16px; border:1px dashed rgba(180,210,255,.35);
      background: radial-gradient(160px 110px at 20% 20%, rgba(22,241,255,.12), transparent 60%), radial-gradient(160px 110px at 80% 80%, rgba(255,62,208,.10), transparent 60%), linear-gradient(180deg,#0c1230,#0a1028);
      display:grid; place-items:center; color:#a9c2ff; text-transform:uppercase; letter-spacing:1px; }
    .d-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn-spin{ appearance:none; border:none; cursor:pointer; padding:12px 18px; border-radius:14px; font-weight:900; color:#081121; background:linear-gradient(135deg,#ffe28a,#ffc13a); box-shadow:0 10px 28px rgba(255,209,102,.35), 0 0 30px rgba(255,209,102,.25); }

    .panel{ margin-top:14px; padding:12px; border:1px solid var(--border); border-radius:16px; background:linear-gradient(180deg, rgba(20,26,62,.55), rgba(14,18,40,.6)); }
    .panel h3{margin:0 0 10px; text-align:center}
    .switch{display:flex; align-items:center; gap:10px; font-weight:800}
    .toggle{ width:46px; height:26px; border-radius:999px; position:relative; background:#2a314a; border:1px solid var(--border); cursor:pointer; }
    .toggle::after{ content:""; position:absolute; top:2px; left:2px; width:22px; height:22px; border-radius:50%; background:#fff; transition:transform .18s; }
    .toggle.active{ background:#19e6ff; } .toggle.active::after{ transform:translateX(20px); }
    .qty{display:flex; gap:10px; justify-content:center}
    .qty .q{ min-width:44px; height:40px; border-radius:12px; display:grid; place-items:center; cursor:pointer; border:1px solid var(--border); background:rgba(15,20,48,.6); font-weight:900; }
    .qty .q.active{ outline:2px solid var(--neon-cyan); color:#081121; background:linear-gradient(135deg,var(--neon-cyan),var(--neon-pink)); border-color:transparent }

    .subhead{margin:18px 0 10px; text-align:center; font-weight:900; letter-spacing:1.2px}

    /* ====== LOOT GRID с флипом ====== */
    .loot-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}

    .loot{
      position:relative; width:100%; aspect-ratio:1/1;
      perspective:900px;
      border-radius:14px;
    }
    .loot-inner{
      position:relative; width:100%; height:100%;
      transform-style:preserve-3d;
      transition:transform .45s cubic-bezier(.2,.7,.2,1);
      border-radius:14px;
    }
    .loot.flipped .loot-inner{ transform:rotateY(180deg); }

    .loot-face{
      position:absolute; inset:0;
      border-radius:14px;
      border:1px dashed rgba(180,210,255,.35);
      overflow:hidden;
      backface-visibility:hidden; -webkit-backface-visibility:hidden;
      display:grid; place-items:center;
      background: linear-gradient(180deg,#0c1230,#0a1028);
      color:#a9c2ff; font-size:12px; letter-spacing:1px; text-transform:uppercase;
    }
    .loot-front img{ width:100%; height:100%; object-fit:cover; display:block; }
    .loot-back{
      transform:rotateY(180deg);
      background:
        linear-gradient(180deg, rgba(12,18,48,.88), rgba(8,14,36,.9)),
        radial-gradient(600px 200px at 50% 110%, rgba(22,241,255,.12), transparent 60%),
        radial-gradient(600px 200px at 50% -10%, rgba(255,62,208,.10), transparent 60%);
      padding:12px;
      gap:8px;
    }

    /* «как на скрине» */
    .lb-stats{ width:100%; }
    .lb-stars, .lb-ton{
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      line-height:1.05;
      letter-spacing:.2px;
    }
    .lb-stars{
      font-size:20px;
      color:var(--neon-yellow);
      margin-bottom:4px;
      text-shadow:0 0 12px rgba(255,228,122,.25);
    }
    .lb-ton{
      font-size:18px;
      color:#79c6ff;
      text-shadow:0 0 12px rgba(22,241,255,.22);
    }

/* подсветка выигрыша без трансформаций */
.slice.win{
  outline:2px solid var(--neon-cyan);
  box-shadow:0 0 30px rgba(22,241,255,.28), inset 0 0 14px rgba(22,241,255,.12);
  animation:win-glow 900ms ease-out 1;
}

/* мягкий импульс свечения */
@keyframes win-glow{
  0%   { box-shadow:0 0 0 rgba(22,241,255,0), inset 0 0 0 rgba(22,241,255,0); }
  25%  { box-shadow:0 0 34px rgba(22,241,255,.35), inset 0 0 16px rgba(22,241,255,.14); }
  60%  { box-shadow:0 0 26px rgba(22,241,255,.28), inset 0 0 14px rgba(22,241,255,.12); }
  100% { box-shadow:0 0 30px rgba(22,241,255,.28), inset 0 0 14px rgba(22,241,255,.12); }
}

/* === ФИКС ДЛЯ ДЛИННОГО НИКА === */
.brand{
  flex: 0 1 38vw;           /* коридор для ника */
  min-width: 120px;
  max-width: 420px;
  overflow: hidden;
  display: flex;
  align-items: center;
}

.brand .glitch{
  display: inline-block;
  white-space: nowrap;
  transform-origin: left center;
  will-change: transform;
}

.topbar .pill{ flex: 0 0 auto; }

/* Чуть лучше рендер шрифта при скейле */
.brand .glitch{
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}


  </style>

<style>

.hide { display: none !important; }

/* CTA-кнопки: не ломаем layout, скрываем через visibility */
.spin-cta{
  visibility: hidden;         /* невидимы, но место занято */
  display: inline-flex;       /* фиксированный тип отображения */
  align-items: center;
  gap: 8px;
}
.spin-cta.show{
  visibility: visible;        /* показываем без изменения размеров родителя */
}


/* === 3D барабан (фронтально, одна ячейка) === */
:root{
  /* размеры можно менять из JS */
  --reel-slice-w: 210px;
  --reel-slice-h: 128px;
  --reel-min-h:   360px;
}

.drum-wrap{
  position:relative;
  width:100%;
  height:100%;
  min-height: var(--reel-min-h);
  display:grid; place-items:center;
  perspective: 1200px;
}

.drum-stage{
  position:relative;
  width:min(560px, 92%);
  height:100%;
  border-radius:16px;
  border:1px solid var(--border);
  background:linear-gradient(180deg,#0c1230,#0a1028);
  box-shadow:inset 0 0 24px rgba(22,241,255,.12);
  overflow:hidden;
}

/* фронтально, без наклона */
.drum-tilt{
  position:absolute; inset:18px;
  transform-style:preserve-3d;
}

.drum{
  position:absolute; left:50%; top:50%;
  transform-style:preserve-3d;
  will-change:transform;
}

/* «вкладки» барабана */
.slice{
  position:absolute; left:50%; top:50%;
  width: var(--reel-slice-w);
  height: var(--reel-slice-h);
  margin: calc(-1 * var(--reel-slice-h) / 2) calc(-1 * var(--reel-slice-w) / 2);
  border-radius:14px;
  border:1px dashed rgba(180,210,255,.35);
  background:
    radial-gradient(120px 80px at 20% 20%, rgba(22,241,255,.10), transparent 60%),
    radial-gradient(120px 80px at 80% 80%, rgba(255,62,208,.08), transparent 60%),
    linear-gradient(180deg,#0b1030,#0a1028);
  box-shadow:0 8px 26px rgba(10,20,60,.35);
  display:grid; grid-template-rows:1fr auto; align-items:center; justify-items:center;
  overflow:hidden;
  backface-visibility:hidden; -webkit-backface-visibility:hidden;
}

.slice .meta{
  width:100%; padding:8px 10px;
  font-weight:900; letter-spacing:.3px; font-size:12px; color:#a9c2ff;
  display:flex; align-items:center; justify-content:space-between;
}
.slice .value{
  color:var(--neon-yellow); text-shadow:0 0 12px rgba(255,228,122,.25);
  font-weight:900; font-size:14px;
}

/* центральная линия выигрыша */
.drum-pointer{
  position:absolute; left:0; right:0; top:50%;
  transform:translateY(-50%); height:2px;
  background:linear-gradient(90deg, transparent, var(--neon-cyan), var(--neon-pink), transparent);
  box-shadow:0 0 14px rgba(22,241,255,.45), 0 0 20px rgba(255,62,208,.25);
  pointer-events:none;
}

/* лёгкая виньетка для глубины */
.drum-stage:before, .drum-stage:after{
  content:""; position:absolute; left:0; right:0; height:22%;
  pointer-events:none; z-index:5;
  background:linear-gradient(180deg, rgba(8,14,36,.8), transparent);
}
.drum-stage:after{ bottom:0; top:auto; transform:rotate(180deg); }

/* 🔧 КВАДРАТНАЯ РАМА ДЛЯ КАРТИНКИ В БАРАБАНЕ */
.slice .img{
  position: relative;
  aspect-ratio: 1 / 1;
  width: 100%;
  height: auto;
  padding: 0;
  border-bottom: 1px solid var(--border);
  background: radial-gradient(80px 60px at 50% 50%, rgba(22,241,255,.10), transparent 60%);
  overflow: hidden;
  box-sizing: border-box;
}

/* 🔧 КАРТИНКА ВСЕГДА ЦЕЛИКОМ ВНУТРИ 1:1 РАМЫ */
.slice .img img{
  position: absolute;
  inset: 8px;
  width: calc(100% - 16px);
  height: calc(100% - 16px);
  object-fit: contain;
  display: block;
  max-width: none;
  max-height: none;
  border-radius: 12px;
} /* ← вот этой скобки не хватало */

/* === Оверрайды ТОЛЬКО для барабана === */
.drum .slice {
  grid-template-rows: 1fr;
}

/* рамка 1:1 + центрирование */
.drum .slice .img{
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  padding: 0;
  aspect-ratio: 1 / 1;
  overflow: hidden;
  border-bottom: none;
  background: radial-gradient(80px 60px at 50% 50%, rgba(22,241,255,.10), transparent 60%);
}

/* картинка по центру, без обрезания краёв */
.drum .slice .img img{
  position: static !important;
  inset: auto !important;
  width: 88%;
  height: 88%;
  object-fit: contain;
  border-radius: 12px;
  display: block;
}

/* ===== DROP MODAL ===== */
.modal{
  position:fixed; inset:0; z-index:90;   /* выше detail */
  display:none; align-items:center; justify-content:center;
}
.modal.show{ display:flex; }
.modal::before{
  content:""; position:absolute; inset:0;
  background:linear-gradient(180deg, rgba(8,14,36,.75), rgba(6,10,26,.85));
  backdrop-filter: blur(8px);
  /* блокируем взаимодействие с фоном */
}

.modal-card{
  position:relative; z-index:1;
  width:min(520px, 92%); padding:16px;
  border-radius:20px; border:1px solid var(--border);
  background:linear-gradient(180deg, rgba(20,26,62,.75), rgba(14,18,40,.88));
  box-shadow: var(--shadow-strong);
  animation: modal-pop .22s cubic-bezier(.2,.7,.2,1) both;
}
@keyframes modal-pop{
  from{ transform:translateY(12px) scale(.98); opacity:0 }
  to  { transform:translateY(0)    scale(1);    opacity:1 }
}

.modal-title{
  text-align:center; font-weight:900; letter-spacing:.8px;
  margin-bottom:12px; color:#d7e6ff; text-shadow:0 0 16px rgba(22,241,255,.25);
}

.modal-image{
  width:100%; aspect-ratio:1/1; border-radius:16px;
  border:1px dashed rgba(180,210,255,.35);
  background:
    radial-gradient(120px 80px at 50% 50%, rgba(22,241,255,.10), transparent 60%),
    linear-gradient(180deg,#0b1030,#0a1028);
  display:grid; place-items:center; overflow:hidden; margin-bottom:12px;
}
.modal-image img{
  width:88%; height:88%; object-fit:contain; border-radius:12px; display:block;
}

.modal-actions{
  display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
}
.modal-actions .btn{
  appearance:none; cursor:pointer; border:none;
  padding:12px 18px; border-radius:14px; font-weight:900;
  box-shadow:var(--shadow-soft);
}
.modal-actions .btn.keep{
  color:#081121; background:linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
  border:1px solid transparent;
}
.modal-actions .btn.sell{
  color:#e8efff; background:linear-gradient(135deg, rgba(15,20,48,.9), rgba(12,16,38,.9));
  border:1px solid var(--border);
}


</style>

</head>
<body>
  <div class="cyber-bg"></div>

  <div class="app" id="top">
    <div class="topbar">
      <img id="userAvatar" class="avatar hidden" alt="avatar">
      <div id="avatarFallback" class="avatar-fallback">GD</div>
      <div class="brand"><span id="userName" class="glitch" data-text="GLITCH&nbsp;DROP">GLITCH&nbsp;DROP</span></div>
      <div class="grow"></div>

      <!-- Пилюля ГЛИТЧ-ТОКЕН слева -->
      <div class="pill pill--lg" title="Глитч-токен">
        <img src="assets/images/20251005_0825_Яркое неоновое сияние_remix_01k6sd902pf03ah1w3cpkr66jz.png" alt="глитч-токен">
        <span class="num" id="bonus">50</span>
      </div>

      <!-- Пилюля со ЗВЕЗДОЙ справа (такой же размер) -->
      <div class="pill pill--lg">
        <img src="assets/images/звезда.png" alt="звезда">
        <span class="num" id="stars">120</span>
      </div>
    </div>

    <div class="chipbar" id="chipbar"><div class="chip active" data-target="#top">Все</div></div>
    <div class="content" id="content"></div>

    <nav class="tabbar">
      <div class="tab"><div class="ico">🏆</div>Конкурсы</div>
      <div class="tab"><div class="ico">⚡</div>Апгрейд</div>
      <div class="tab active"><div class="ico">🎁</div>Кейсы</div>
      <div class="tab"><div class="ico">👥</div>Друзья</div>
      <div class="tab"><div class="ico">👤</div>Профиль</div>
    </nav>
  </div>

  <!-- DETAIL VIEW -->
  <div id="detail" class="detail" aria-hidden="true">
    <div class="d-topbar">
      <button id="backBtn" class="btn-back">← Назад</button>
      <div class="d-title" id="detailTitle">Кейс</div>
      <div class="grow"></div>
    </div>
    <div class="d-body">
      <div class="d-hero">
        <div id="detailThumb" class="d-thumb">Заглушка</div>
        <div class="d-actions">
  <button class="btn-spin" id="spinStartBtn">КРУТИТЬ</button>
  <div class="pill"><span>Цена:</span><span class="num" id="detailPrice">—</span></div>
</div>

</div> <!-- закрывает .d-hero -->
<div class="subhead">СОДЕРЖИМОЕ КЕЙСА</div>
<div id="lootGrid" class="loot-grid"></div>
<div style="height:40px"></div>

<!-- DROP MODAL -->
<div id="dropModal" class="modal" aria-hidden="true" aria-modal="true" role="dialog">
  <div class="modal-card" role="document">
    <div class="modal-title">ПРЕДМЕТ ПОЛУЧЕН</div>
    <div class="modal-image">
      <img id="dropImg" alt="Выпавший предмет">
    </div>
    <div class="modal-actions">
      <button id="keepBtn" class="btn keep">ОСТАВИТЬ</button>
      <button id="sellBtn" class="btn sell">ПРОДАТЬ</button>
    </div>
  </div>
</div>


  <button id="backTop" class="backtop" aria-label="Вверх">ВВЕРХ ↑</button>



  <script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
// ====== ДАННЫЕ ======
const LOOT_SETS = { /* <-- твои массивы, оставляю как есть */ 
  cheap_1:[ "assets/images/20251003_1635_Прозрачный фон_remix_01k6n4frmwe74ry17r7gszk6ef.png",
    "assets/images/20251003_1629_Прозрачный фон_remix_01k6n43z74eq3ve8a9rcx44f02.png",
    "assets/images/20251003_1627_Прозрачный Фон_remix_01k6n416bkeassbn7rx8a17bdt.png",
    "assets/images/20251003_1626_Прозрачный Фон_remix_01k6n3y428frhrwqy0rqfwq9n5.png",
    "assets/images/20251003_1624_Прозрачный фон_remix_01k6n3v1nbffkrc39mm720d2gm.png",
    "assets/images/20251008_1905_Прозрачный фон_remix_01k72913cgfyy90e2abb8t2dft.png",
    "assets/images/20251003_1632_Прозрачный фон_remix_01k6n49ebnfssrvwq0605g9bkx.png",
    "assets/images/20251003_1621_Прозрачный фон_remix_01k6n3p2hwf4fbk1r0rqbvdc5d.png",
    "assets/images/20251003_1620_Прозрачный фон_remix_01k6n3k7yrey7864fgc944j33p.png",
    "assets/images/20251003_1618_Прозрачный фон_remix_01k6n3fv8bej7813hnthjyags5.png",
    "assets/images/20251003_1616_Сердце с бантом_remix_01k6n3czjze6paj61x9g5r7ab3.png"
  ],
  cheap_2:["assets/images/снупп дог.png","assets/images/20251003_1635_Прозрачный фон_remix_01k6n4frmwe74ry17r7gszk6ef.png","assets/images/20251003_1627_Прозрачный Фон_remix_01k6n416bkeassbn7rx8a17bdt.png","assets/images/20251003_1629_Прозрачный фон_remix_01k6n43z74eq3ve8a9rcx44f02.png","assets/images/20251003_1626_Прозрачный Фон_remix_01k6n3y428frhrwqy0rqfwq9n5.png","assets/images/20251003_1632_Прозрачный фон_remix_01k6n49ebnfssrvwq0605g9bkx.png","assets/images/20251003_1624_Прозрачный фон_remix_01k6n3v1nbffkrc39mm720d2gm.png","assets/images/20251008_1905_Прозрачный фон_remix_01k72913cgfyy90e2abb8t2dft.png","assets/images/20251003_1620_Прозрачный фон_remix_01k6n3k7yrey7864fgc944j33p.png","assets/images/20251003_1616_Сердце с бантом_remix_01k6n3czjze6paj61x9g5r7ab3.png","assets/images/20251003_1618_Прозрачный фон_remix_01k6n3fv8bej7813hnthjyags5.png"],
  cheap_3:["assets/images/kniga.png","assets/images/klever.png","assets/images/20251003_1635_Прозрачный фон_remix_01k6n4frmwe74ry17r7gszk6ef.png","assets/images/20251003_1627_Прозрачный Фон_remix_01k6n416bkeassbn7rx8a17bdt.png","assets/images/20251003_1629_Прозрачный фон_remix_01k6n43z74eq3ve8a9rcx44f02.png","assets/images/20251003_1624_Прозрачный фон_remix_01k6n3v1nbffkrc39mm720d2gm.png","assets/images/20251008_1905_Прозрачный фон_remix_01k72913cgfyy90e2abb8t2dft.png","assets/images/20251003_1621_Прозрачный фон_remix_01k6n3p2hwf4fbk1r0rqbvdc5d.png","assets/images/20251003_1620_Прозрачный фон_remix_01k6n3k7yrey7864fgc944j33p.png","assets/images/20251003_1618_Прозрачный фон_remix_01k6n3fv8bej7813hnthjyags5.png","assets/images/20251003_1616_Сердце с бантом_remix_01k6n3czjze6paj61x9g5r7ab3.png"],
  cheap_4:["","","","","","","","","","",""],
  nft_1:["","","","","","","","","","",""],
  nft_2:["","","","","","","","","","",""],
  nft_3:["","","","","","","","","","",""],
  nft_4:["","","","","","","","","","",""],
  exclusive_1:["","","","","","","","","","",""],
  exclusive_2:["","","","","","","","","","",""],
  exclusive_3:["","","","","","","","","","",""],
  exclusive_4:["","","","","","","","","","",""],
  standard_1:["","","","","","","","","","",""],
  standard_2:["","","","","","","","","","",""],
  standard_3:["","","","","","","","","","",""],
  standard_4:["","","","","","","","","","",""],
  gold_1:["","","","","","","","","","",""],
  gold_2:["","","","","","","","","","",""],
  gold_3:["","","","","","","","","","",""],
  gold_4:["","","","","","","","","","",""],
  allornothing_1:["","","","","","","","","","",""],
  allornothing_2:["","","","","","","","","","",""],
  allornothing_3:["","","","","","","","","","",""],
  allornothing_4:["","","","","","","","","","",""],
  expensive_1:["","","","","","","","","","",""],
  expensive_2:["","","","","","","","","","",""],
  expensive_3:["","","","","","","","","","",""],
  expensive_4:["","","","","","","","","","",""],
};

const CHEAP_BACK_TEXT = {
  cheap_1: Array(11).fill({stars:"174000/", ton:"870"}),
  cheap_2: Array(11).fill({stars:"174000/", ton:"870"}),
  cheap_3: Array(11).fill({stars:"174000/", ton:"870"}),
  cheap_4: Array(11).fill({stars:"174000/", ton:"870"}),
};

const CASE_THUMBS = {
  free:["assets/images/20251006_1323_Изумрудный кейс_remix_01k6wgnp9kfc7t5tsc54yag55g.png","assets/images/20251006_1250_Энергичный Глитч Кейс_remix_01k6wes6ykf1rtbax6cajjgpae.png","assets/images/20251006_1340_Жёлтый Глитч Дроп_remix_01k6whmtz7e3d8ejjj7vz9dt6z.png","assets/images/case 10 000.png"],
  cheap:["assets/images/20251010_1652_Золотой Кубок_remix_01k7767y0he76bx0bzxsakmpd4.png","","",""],
  nft:["assets/images/ChatGPT Image 5 окт. 2025 г., 10_33_06.png","assets/images/ChatGPT Image 5 окт. 2025 г., 11_26_19.png","assets/images/NFT 3.png","assets/images/20251005_1527_Зелёная призрачная тыква_remix_01k6t5bwrrfxet6r4vzrkgra3k.png"],
  exclusive:["assets/images/20251005_1639_Новогодняя змея_remix_01k6t9fz7mevwt1beaq5bxehc4.png","assets/images/20251005_1703_Фен с розовой лентой_remix_01k6tavjk3fq8brq0e5fr8hycw.png","assets/images/20251005_1718_Стильный школьный рюкзак_simple_compose_01k6tbpyfyedkb0r4qcr8r6p8m.png","assets/images/20251005_1752_Радужные Губы и Пузыри_remix_01k6tdn1ebem893yskvv82bpgz.png"],
  standard:["","","",""],
  gold:["","","",""],
  allornothing:["","","",""],
  expensive:["","","",""],
};

const sections = [
  { id:'free',        title:'БЕСПЛАТНЫЕ КЕЙСЫ',  items:4, price:'БЕСПЛАТНО',
    descs:['Бонус за промокод','Ежедневный бонус','За подписку','За пополнение'] },
  { id:'cheap',       title:'ДЕШЁВЫЕ КЕЙСЫ',     items:4, price:['50 ⭐','250 ⭐','500 ⭐','1500 ⭐'] },
  { id:'nft',         title:'ТОЛЬКО NFT-КЕЙСЫ',  items:4, price:['25 ⭐','30 ⭐','35 ⭐','40 ⭐'] },
  { id:'exclusive',   title:'ЭКСКЛЮЗИВНЫЕ КЕЙСЫ',items:4, price:['2000 ⭐','3500 ⭐','5800 ⭐','8500 ⭐'] },
  { id:'standard',    title:'СТАНДАРТНЫЕ КЕЙСЫ', items:4, price:['20 ⭐','25 ⭐','28 ⭐','35 ⭐'] },
  { id:'gold',        title:'КЕЙСЫ ЗА ЗОЛОТО',   items:4, price:['ЗОЛОТО','ЗОЛОТО','ЗОЛОТО','ЗОЛОТО'] },
  { id:'allornothing',title:'ВСЁ ИЛИ НИЧЕГО КЕЙСЫ',items:4,price:['50 ⭐','75 ⭐','100 ⭐','150 ⭐'] },
  { id:'expensive',   title:'ДОРОГИЕ КЕЙСЫ',     items:4, price:['200 ⭐','250 ⭐','300 ⭐','400 ⭐'] },
];

const FALLBACK_IMG = "https://via.placeholder.com/512?text=%F0%9F%8E%81";

// ====== DOM-ссылки ======
const chipbar  = document.getElementById('chipbar');
const content  = document.getElementById('content');
const detail   = document.getElementById('detail');
const backBtn  = document.getElementById('backBtn');
const dTitle   = document.getElementById('detailTitle');
const dPrice   = document.getElementById('detailPrice');
const dThumb   = document.getElementById('detailThumb');
const lootGrid = document.getElementById('lootGrid');
// ====== Рендер карточек ======
sections.forEach(sec=>{
  // чип
  const chip = document.createElement('div');
  chip.className = 'chip';
  chip.dataset.target = `#sec-${sec.id}`;
  chip.textContent = sec.title.replace(' КЕЙСЫ','');
  chipbar.appendChild(chip);

  // заголовок секции
  const h2 = document.createElement('h2');
  h2.className = 'section';
  h2.id = `sec-${sec.id}`;
  h2.textContent = sec.title;
  content.appendChild(h2);

  // грид
  const grid = document.createElement('div');
  grid.className = 'grid';

  for(let i=0;i<sec.items;i++){
    const thumbUrl  = (CASE_THUMBS[sec.id] && CASE_THUMBS[sec.id][i]) || "";
    const thumbHTML = thumbUrl ? `<img src="${thumbUrl}" alt="Обложка кейса #${i+1}" onerror="this.src='${FALLBACK_IMG}'">` : `Заглушка`;

    const card = document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <div class="inner">
        <div class="thumb">${thumbHTML}</div>
        <div class="name">${sec.title.split(' ')[0]} Кейс #${i+1}</div>
        <div class="desc">${(sec.descs && sec.descs[i]) || 'Неоновая коллекция'}</div>
        <div class="price">${Array.isArray(sec.price)? sec.price[i] : sec.price}</div>
      </div>`;

    if (sec.id !== 'free') {
      const setId = `${sec.id}_${i+1}`;
      card.addEventListener('click', ()=> openDetail({
        title: `${sec.title} — Кейс #${i+1}`,
        price: Array.isArray(sec.price)? sec.price[i] : sec.price,
        setId
      }));
    }
    grid.appendChild(card);
  }

  content.appendChild(grid);
});

// ====== Чипы (скролл по секциям) ======
const chips = Array.from(chipbar.querySelectorAll('.chip'));
chipbar.addEventListener('click', e=>{
  const chip = e.target.closest('.chip'); if(!chip) return;
  setActiveChip(chip);
  const sel = chip.dataset.target;
  if(!sel || sel==="#top"){ window.scrollTo({top:0,behavior:'smooth'}); return; }
  document.querySelector(sel)?.scrollIntoView({behavior:'smooth', block:'start'});
});
function setActiveChip(ch){ chips.forEach(c=>c.classList.remove('active')); ch.classList.add('active'); }
const mapTargetToChip = new Map([['#top', chipbar.querySelector('.chip.active')], ...chips.map(c=>[c.dataset.target,c])]);
const sectionEls = sections.map(s=>document.getElementById(`sec-${s.id}`));
const io = new IntersectionObserver((entries)=>{
  let best=null,ratio=0;
  for(const e of entries){ if(e.isIntersecting && e.intersectionRatio>ratio){best=e.target;ratio=e.intersectionRatio;} }
  if(best){ const ch = mapTargetToChip.get('#'+best.id); ch && setActiveChip(ch); }
  if(window.scrollY<10){ setActiveChip(mapTargetToChip.get('#top')); }
}, {root:null, rootMargin:'-130px 0px -60% 0px', threshold:[0.2,0.4,0.6,0.8]});
sectionEls.forEach(s=>io.observe(s));

// ====== Кнопка «вверх» ======
const backTop = document.getElementById('backTop');
const toggleBackTop = ()=> backTop.classList.toggle('show', window.scrollY>2);
window.addEventListener('scroll', toggleBackTop, {passive:true});
backTop.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
toggleBackTop();

// ====== Рендер лута (флип-карточки) ======
function renderLoot(images, setId){
  lootGrid.innerHTML = "";
  const list = (images && images.length) ? images.slice(0,11) : Array.from({length:11}, ()=>null);
  const isCheap = typeof setId === 'string' && setId.startsWith('cheap');
  const table = isCheap ? (CHEAP_BACK_TEXT[setId] || []) : [];

  const DEF_STARS = "174000/";
  const DEF_TON   = "870";

  list.forEach((src, idx)=>{
    const wrap = document.createElement('div');
    wrap.className = 'loot';
    wrap.setAttribute('aria-label', `Предмет ${idx+1}`);
    wrap.setAttribute('role','button');
    wrap.tabIndex = 0;

    const inner = document.createElement('div');
    inner.className = 'loot-inner';

    const front = document.createElement('div');
    front.className = 'loot-face loot-front';
    if (src){
      const img = document.createElement('img');
      img.src = src;
      img.alt = `Предмет ${idx+1}`;
      img.loading = "lazy";
      img.onerror = () => img.src = FALLBACK_IMG;
      front.appendChild(img);
    } else {
      front.textContent = 'Заглушка';
    }

    const back = document.createElement('div');
    back.className = 'loot-face loot-back';

    if (isCheap){
      const row = table[idx] || {};
      const s = (row.stars ?? "").trim() || DEF_STARS;
      const t = (row.ton   ?? "").trim() || DEF_TON;
      back.innerHTML = `
        <div class="lb-stats">
          <div class="lb-stars">${s}</div>
          <div class="lb-ton">${t}</div>
        </div>`;
    } else {
      back.innerHTML = `
        <div class="lb-stats">
          <div class="lb-stars">—</div>
          <div class="lb-ton">—</div>
        </div>`;
    }

    inner.appendChild(front);
    inner.appendChild(back);
    wrap.appendChild(inner);

    // флип (одна открыта за раз)
    wrap.addEventListener('click', (e)=>{
      e.preventDefault();
      const isOpen = wrap.classList.contains('flipped');
      lootGrid.querySelectorAll('.loot.flipped').forEach(l=>l.classList.remove('flipped'));
      if (!isOpen) wrap.classList.add('flipped');
    }, {passive:false});

    wrap.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){
        e.preventDefault();
        wrap.click();
      }
    });

    lootGrid.appendChild(wrap);
  });
}

// ===== DROP MODAL LOGIC =====
const dropModal = document.getElementById('dropModal');
const dropImg   = document.getElementById('dropImg');
const keepBtn   = document.getElementById('keepBtn');
const sellBtn   = document.getElementById('sellBtn');

let _lastFocus = null;
let _modalOpen = false;

function openDropModal(imgSrc){
  if (!dropModal) return;
  _lastFocus = document.activeElement;

  // картинка
  dropImg.src = imgSrc || FALLBACK_IMG;
  dropImg.onerror = () => { dropImg.src = FALLBACK_IMG; };

  // показать модалку
  dropModal.classList.add('show');
  dropModal.setAttribute('aria-hidden','false');
  _modalOpen = true;

  // запретить прокрутку и взаимодействие со скроллом фона
  lockBody(true);

  // захват фокуса
  setTimeout(()=> (keepBtn || dropModal).focus(), 0);

  // блокируем фон, Esc и держим фокус
  dropModal.addEventListener('click', blockBackdropClick, true);
  document.addEventListener('keydown', blockEsc, true);
  document.addEventListener('keydown', trapTab, true);
} // ← ЭТА скобка закрывает openDropModal

function closeDropModal(){
  if (!dropModal) return;

  dropModal.classList.remove('show');
  dropModal.setAttribute('aria-hidden','true');
  _modalOpen = false;

  lockBody(false);

  dropModal.removeEventListener('click', blockBackdropClick, true);
  document.removeEventListener('keydown', blockEsc, true);
  document.removeEventListener('keydown', trapTab, true);

  if (_lastFocus && _lastFocus.focus) _lastFocus.focus();
}

function blockBackdropClick(e){
  const card = dropModal.querySelector('.modal-card');
  if (!card.contains(e.target)){
    e.stopPropagation();
    e.preventDefault();
  }
}
function blockEsc(e){
  if (e.key === 'Escape'){
    e.stopPropagation();
    e.preventDefault();
    // закрываем ТОЛЬКО по кнопкам
  }
}
function trapTab(e){
  if (e.key !== 'Tab' || !_modalOpen) return;
  const focusables = dropModal.querySelectorAll('button, [href], [tabindex]:not([tabindex="-1"])');
  const list = Array.from(focusables).filter(el=>!el.disabled && el.offsetParent !== null);
  if (!list.length) return;
  const first = list[0], last = list[list.length-1];
  if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
  else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
}

// Кнопки (пока просто закрывают модалку)
keepBtn?.addEventListener('click', () => {
  // TODO: начислить предмет игроку
  closeDropModal();
});
sellBtn?.addEventListener('click', () => {
  // TODO: продать предмет/начислить валюту
  closeDropModal();
});


function lockBody(locked){
  if (locked){
    const y = window.scrollY || 0;
    document.body.dataset.scrollY = String(y);
    document.body.style.position = 'fixed';
    document.body.style.top = `-${y}px`;
    document.body.style.left = '0';
    document.body.style.right = '0';
    document.body.style.width = '100%';
  } else {
    const y = parseInt(document.body.dataset.scrollY || '0', 10);
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.left = '';
    document.body.style.right = '';
    document.body.style.width = '';
    window.scrollTo(0, y);
  }
}


function openDetail({title, price, setId}) {
  // запоминаем текущий сет
  window.currentSetId = setId;

  // заголовки/цена
  dTitle.textContent = title;
  dPrice.textContent = String(price || '—');

  // чистая заглушка сверху
  dThumb.textContent = 'Заглушка';

  // лут снизу
  const images = LOOT_SETS[setId] || null;
  renderLoot(images, setId);

const key = `${setId}__0`;
const st  = ensureSpinState(key);
st.currentAngle = 0; // каждый заход начинаем с нулевого угла
// размеры фиксированные; если где-то менялись — вернём их
setReelSize({ sliceW: 210, sliceH: 128, minH: 360 });


  // НАРИСОВАТЬ ПРЕВЬЮ ЛЕНТ сразу под выбранное количество
  renderPreview(setId);

  // подготовка кнопок
  const spinStartBtn = document.getElementById('spinStartBtn');
  
  if (spinStartBtn) spinStartBtn.disabled = false;
  window.IS_SPINNING = false;

  // запуск N спинов
  
  if (spinStartBtn) spinStartBtn.onclick  = () => beginSpin(setId);
  
 lockBody(true);
detail.classList.add('show');
detail.setAttribute('aria-hidden','false');
detail.scrollTop = 0;

  }

// ====== Telegram WebApp ======
(()=>{
  const tg = window.Telegram && window.Telegram.WebApp;
  const avatarImg = document.getElementById('userAvatar');
  const fallback  = document.getElementById('avatarFallback');
  const nameEl    = document.getElementById('userName');

  if(!tg) return;
  tg.ready(); tg.expand();

  const u = tg.initDataUnsafe && tg.initDataUnsafe.user;
  if(!u) return;

  const display = u.username ? '@' + u.username : [u.first_name||'', u.last_name||''].join(' ').trim() || 'GLITCH DROP';
  nameEl.textContent = display;
  nameEl.setAttribute('data-text', display.replaceAll(' ', '\u00A0'));

  // 👇 ДОБАВЬ ЭТО, чтобы сразу подогнать размер ника
  if (typeof fitUserName === 'function') fitUserName();


  if (u.photo_url){
    avatarImg.src = u.photo_url;
    avatarImg.classList.remove('hidden');
    fallback.style.display = 'none';
  }
})();

// === Автоподгон ника под доступную ширину бренда ===
function fitUserName(){
  const brand = document.querySelector('.brand');
  const el = document.getElementById('userName');
  if(!brand || !el) return;

  el.style.transform = 'scale(1)';
  el.style.removeProperty('--name-scale');

  const maxW = Math.floor(brand.clientWidth);
  const needW = Math.ceil(el.scrollWidth);
  if (!maxW || !needW) return;

  if (needW <= maxW){
    el.removeAttribute('title');
    return;
  }

  const scale = Math.max(0.65, maxW / needW); // не меньше 0.65
  el.style.transform = `scale(${scale})`;

// лёгкое уплотнение межбуквенного интервала при сильном скейле
if (scale <= 0.70){
  el.style.letterSpacing = '-0.2px';
} else {
  el.style.removeProperty('letter-spacing');
}


  if (scale <= 0.70){
    el.setAttribute('title', el.textContent);
    el.style.maxWidth = maxW + 'px';
    el.style.textOverflow = 'ellipsis';
    el.style.overflow = 'hidden';
  } else {
    el.removeAttribute('title');
    el.style.removeProperty('max-width');
    el.style.removeProperty('text-overflow');
    el.style.removeProperty('overflow');
  }
}

// вызываем при загрузке и на изменение размеров
fitUserName();
window.addEventListener('resize', fitUserName, {passive:true});
window.addEventListener('orientationchange', fitUserName);

// 👇 На случай, если верстка дорисуется позже
document.addEventListener('DOMContentLoaded', () => {
  if (typeof fitUserName === 'function') fitUserName();
});

if (document.fonts && document.fonts.ready) {
  document.fonts.ready.then(() => fitUserName());
}



if ('ResizeObserver' in window){
  const ro = new ResizeObserver(fitUserName);
  const brandEl = document.querySelector('.brand');
  if (brandEl) ro.observe(brandEl);
}



// --- Support для 3D барабана: состояние, веса, лейблы ---

// Пустой реестр картинок (если не используешь отдельные спрайты барабана)
window.SPIN_IMAGES = window.SPIN_IMAGES || {}; // { setId: [url,url,...] }

// Общий state по ключу (setId__index)
window.SPIN_STATE = window.SPIN_STATE || new Map();

// Проценты выпадения по наборам (11 значений на setId). Пока нули — равновероятно.
const SPIN_CONFIGS_PERCENT = {
 
cheap_1: [0, 0, 0, 0, 0, 0, 0.392, 0.294, 0.196, 0.098, 0.02], 
cheap_2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
cheap_3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
cheap_4: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  
nft_1: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],  
nft_2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],   
nft_3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],   
nft_4: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  
exclusive_1: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
exclusive_2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
exclusive_3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
exclusive_4: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  
standard_1: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],  
standard_2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],  
standard_3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],  
standard_4: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  
gold_1: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
gold_2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
gold_3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
gold_4: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  
allornothing_1: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
allornothing_2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
allornothing_3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
allornothing_4: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
 
expensive_1: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
expensive_2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
expensive_3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
expensive_4: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
};

// Необязательные подписи/значения
const SPIN_LABELS = {
  cheap_1: {
    labels: ["CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1"],
    values: ["10 ⭐","25 ⭐","50 ⭐","100 ⭐","3 ⭐","5 ⭐","8 ⭐","15 ⭐","20 ⭐","30 ⭐","60 ⭐"]
  }
};
const DEFAULT_LABELS = Array(11).fill("ПРИЗ");
const DEFAULT_VALUES = ["10 ⭐","25 ⭐","50 ⭐","100 ⭐","3 ⭐","5 ⭐","8 ⭐","15 ⭐","20 ⭐","30 ⭐","60 ⭐"];

function ensureSpinState(key){
  if(!SPIN_STATE.has(key)){
    const setId = key.split('__')[0];
    const raw = (SPIN_CONFIGS_PERCENT[setId]?.slice(0,11)) || Array(11).fill(0);
    const sum = raw.reduce((a,b)=>a+b,0) || 1;
    const weights = raw.map(w => Math.max(0,w)/sum);

    const L = (SPIN_LABELS[setId]?.labels || DEFAULT_LABELS).slice(0,11);
    const V = (SPIN_LABELS[setId]?.values || DEFAULT_VALUES).slice(0,11);
    while(L.length<11) L.push("ПРИЗ");
    while(V.length<11) V.push("—");

    SPIN_STATE.set(key, {
      currentAngle: 0,
      rafId: 0,
      weights, labels: L, values: V
    });
  }
  return SPIN_STATE.get(key);
}


// Выбор индекса по весам
function pickIndexByWeights(weights){
  let r = Math.random(), acc = 0;
  for(let i=0;i<weights.length;i++){ acc += weights[i]; if(r <= acc) return i; }
  return weights.length-1;
}

/* ===== 3D барабан для detailThumb ===== */

// Глобальный флажок «идёт прокрут»
if (typeof window.IS_SPINNING === 'undefined') window.IS_SPINNING = false;

// Параметры барабана
const DRUM_ITEM_COUNT = 11;          // число граней

/* Геометрия/размер */
function getReelMetrics(){
  const cs = getComputedStyle(document.documentElement);
  const w = parseFloat(cs.getPropertyValue('--reel-slice-w')) || 210;
  const h = parseFloat(cs.getPropertyValue('--reel-slice-h')) || 128;
  const step = 360 / DRUM_ITEM_COUNT;
  const r = Math.round( (h / 2) / Math.tan(Math.PI / DRUM_ITEM_COUNT) );
  return { w, h, step, r };
}

/* Публичные функции изменения размера */
function setReelSize({sliceW, sliceH, minH} = {}){
  const root = document.documentElement.style;
  if(sliceW) root.setProperty('--reel-slice-w', `${sliceW}px`);
  if(sliceH) root.setProperty('--reel-slice-h', `${sliceH}px`);
  if(minH)   root.setProperty('--reel-min-h',   `${minH}px`);
}

/* Состояние с углом */
function ensureSpinStateWithAngle(key){
  const st = ensureSpinState(key);
  if(typeof st.currentAngle !== 'number') st.currentAngle = 0;
  return st;
}

/* Рендер барабана в d-thumb */
function render3DReel(setId){
  const parent = document.getElementById('detailThumb');
  if(!parent) return;
  const key = `${setId}__0`;
  const st  = ensureSpinStateWithAngle(key);
  const { step, r } = getReelMetrics();

  parent.innerHTML = `
    <div class="drum-wrap">
      <div class="drum-stage">
        <div class="drum-tilt">
          <div class="drum" id="drum_${key}" style="transform:translateZ(${-r}px) rotateX(${st.currentAngle}deg)"></div>
        </div>
        <div class="drum-pointer"></div>
      </div>
    </div>
  `;

  const drum = document.getElementById(`drum_${key}`);
  drum.innerHTML = "";

  const imgs = (SPIN_IMAGES[setId]?.length ? SPIN_IMAGES[setId] : LOOT_SETS[setId] || []).slice(0, DRUM_ITEM_COUNT);
  while(imgs.length < DRUM_ITEM_COUNT) imgs.push("");

  for(let i=0;i<DRUM_ITEM_COUNT;i++){
    const deg = -i * step; // фронтально, вращаем вниз
    const url   = imgs[i] || "";
    const label = (SPIN_STATE.get(key)?.labels?.[i]) ?? "ПРИЗ";
    const value = (SPIN_STATE.get(key)?.values?.[i]) ?? "—";

    const el = document.createElement('div');
    el.className = 'slice';
    el.style.setProperty('--_deg', `${deg}deg`);
    el.style.setProperty('--_rz',  `${r}px`);
    el.style.transform = `rotateX(${deg}deg) translateZ(${r}px)`;
    
// стало:
el.innerHTML = `
  <div class="img">
    ${url ? `<img src="${url}" onerror="this.src='${FALLBACK_IMG}'" alt="">` : '—'}
  </div>
`;

    drum.appendChild(el);
  }
}

function start3DSpin(setId, onDone){
  const key  = `${setId}__0`;
  const drum = document.getElementById(`drum_${key}`);
  if (!drum){ onDone && onDone({ idx:-1, imgSrc: FALLBACK_IMG }); return; }


  const st = ensureSpinState(key);
  const { step, r } = getReelMetrics();

  drum.querySelectorAll('.slice').forEach(s=> s.classList.remove('win'));

  const idx = pickIndexByWeights(st.weights);
  const current  = Number.isFinite(st.currentAngle) ? st.currentAngle : 0;
  const curSteps = Math.round(current / step);
  const curMod   = ((curSteps % 11) + 11) % 11;

  const need = ((idx - curMod) + 11) % 11;
  const EXTRA_TURNS_INT = 3;
  const deltaSteps = EXTRA_TURNS_INT * 11 + need;
  const target = (curSteps + deltaSteps) * step;

  const SPIN_DURATION_MS = 3800;
  const t0 = performance.now();
  const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

  function frame(now){
    const p = Math.min(1, (now - t0) / SPIN_DURATION_MS);
    const ang = current + (target - current) * easeOutCubic(p);
    drum.style.transform = `translateZ(${-r}px) rotateX(${ang}deg)`;

    if(p < 1){
      st.rafId = requestAnimationFrame(frame);
    } else {
            const snapped = Math.round(target / step) * step;
      drum.style.transform = `translateZ(${-r}px) rotateX(${snapped}deg)`;
      st.currentAngle = snapped;

      const slices = drum.querySelectorAll('.slice');
      const winEl = slices[idx];
      winEl?.classList.add('win');
      const winImg = winEl?.querySelector('img');
      const imgSrc = winImg ? winImg.src : FALLBACK_IMG;

      st.rafId = 0;
      onDone && onDone({ idx, imgSrc });
    }
  }

  cancelAnimationFrame(st.rafId);
  st.rafId = requestAnimationFrame(frame);
}

// превью барабана
function renderPreview(setId){
  render3DReel(setId);
}

// запуск спина
function beginSpin(setId){
  if (window.IS_SPINNING) return;
  window.IS_SPINNING = true;

  render3DReel(setId);

  const btn = document.getElementById('spinStartBtn');
  if (btn) btn.disabled = true;

  start3DSpin(setId, ({ imgSrc })=>{
  if (btn) btn.disabled = false;
  window.IS_SPINNING = false;

  // Показать модалку с выигрышем
  openDropModal(imgSrc);
});
}

backBtn.addEventListener('click', ()=>{
  // Остановить активные анимации барабана
  SPIN_STATE.forEach(st=>{
    if (st.rafId) cancelAnimationFrame(st.rafId);
    st.rafId = 0;
  });

  // Сброс трансформа барабана
  const drum = document.querySelector('.d-thumb .drum');
  if (drum) drum.style.transform = '';

  window.IS_SPINNING = false;
  document.getElementById('spinStartBtn')?.removeAttribute('disabled');

  // Закрыть деталку и вернуть скролл
  detail.classList.remove('show');
  detail.setAttribute('aria-hidden','true');
  lockBody(false);
});


</script>

<script src="nav-profile.js"></script>


</body>
</html>
