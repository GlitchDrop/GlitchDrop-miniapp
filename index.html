<!doctype html>
<html lang="ru">

<head>

  <script>
// === ГЛОБАЛЬНЫЙ СБРОС UID ДЛЯ ВСЕХ ПРИ СЛЕДУЮЩЕМ ЗАПУСКЕ ===
// Увеличь версию, когда нужно «сбросить всем»: 'v2' -> 'v3' и т.д.
var UID_SCHEMA_VERSION = 'v2';

// ——— утилиты совместимые со старыми WebView ———
function isValidUid8(v) {
  return typeof v === 'string' && /^\d{8}$/.test(v) && v !== '00000000';
}
function uidKeyFor(tgId) {
  return 'gd_uid8:' + UID_SCHEMA_VERSION + ':' + (tgId || 'anon');
}
// Полезно убрать очень старый общий ключ, если вдруг сохранился
var OLD_GENERIC_KEY = 'gd_uid8';

// Math.imul полифилл (для старых движков)
if (!Math.imul) {
  Math.imul = function (a, b) {
    var ah = (a >>> 16) & 0xffff, al = a & 0xffff;
    var bh = (b >>> 16) & 0xffff, bl = b & 0xffff;
    var high = ((ah * bl) + (al * bh)) & 0xffff;
    return ((high << 16) >>> 0) + (al * bl | 0);
  };
}

// Одноразовая зачистка старых версий ключей (срабатывает при каждом заходе)
(function sweepOldUidKeys(){
  try {
    var toDelete = [];
    for (var i = 0; i < localStorage.length; i++) {
      var k = localStorage.key(i);
      if (!k) continue;

      // все "gd_uid8:*" КРОМЕ текущей версии
      var isUidKey = k.indexOf('gd_uid8:') === 0;
      var isCurrent = k.indexOf('gd_uid8:' + UID_SCHEMA_VERSION + ':') === 0;
      if (isUidKey && !isCurrent) toDelete.push(k);

      // очень старый общий ключ
      if (k === OLD_GENERIC_KEY) toDelete.push(k);
    }
    for (var j = 0; j < toDelete.length; j++) {
      localStorage.removeItem(toDelete[j]);
    }
  } catch (e) { /* ignore */ }
})();

// ——— GD helpers ———
window.GD = window.GD || {};

GD._fnv1a = function (str) {
  var h = 0x811c9dc5 >>> 0;
  for (var i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 0x01000193) >>> 0;
  }
  return h >>> 0;
};

GD._toUid8 = function (n) {
  // всегда 8 цифр и никогда "00000000"
  var v = ((n % 99999999) + 1);
  if (v < 0) v = -v; // на всякий случай
  var s = String(v);
  while (s.length < 8) s = '0' + s;
  return s;
};

GD.resetUidCacheFor = function (tgId) {
  try { localStorage.removeItem(uidKeyFor(tgId)); } catch (e) {}
};

// Основной резолвер UID8 с кэшем и фолбэком
GD.getOrFetchUid8 = function (tgId) {
  var K = uidKeyFor(tgId);

  // 1) читаем кэш новой схемы
  try {
    var cached = localStorage.getItem(K);
    if (isValidUid8(cached)) return Promise.resolve(cached);
    if (cached) localStorage.removeItem(K); // вычистим мусор (включая 00000000)
  } catch (e) {}

  // 2) пробуем сервер, только если есть fetch и задан API_BASE
  var canFetch = (typeof fetch === 'function') && (typeof window !== 'undefined') && window.API_BASE;
  if (canFetch) {
    return fetch(window.API_BASE + '/api/referrals/hit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ telegram_id: String(tgId || '') })
    })
    .then(function (resp) {
      if (!resp.ok) throw new Error('bad status');
      return resp.json();
    })
    .then(function (data) {
      var uid8 = data && data.uid8;
      if (!isValidUid8(uid8)) throw new Error('bad uid');
      try {
  localStorage.setItem(K, uid8);
  localStorage.setItem('gd_uid8', uid8);
} catch (e) {}
      return uid8;
    })
    .catch(function () {
      // 3) фолбэк: детерминированный, гарантированно не "00000000"
      var h = GD._fnv1a('GLITCHDROP:' + (tgId || '0'));
      var fallback = GD._toUid8(h);
      try {
  localStorage.setItem(K, fallback);
  localStorage.setItem('gd_uid8', fallback);
} catch (e) {}
      return fallback;
    });
  }

  // 3) нет fetch — сразу фолбэк
  return new Promise(function (resolve) {
    var h = GD._fnv1a('GLITCHDROP:' + (tgId || '0'));
    var fallback = GD._toUid8(h);
    try {
  localStorage.setItem(K, fallback);
  localStorage.setItem('gd_uid8', fallback);
} catch (e) {}
    resolve(fallback);
  });
};

// Мемоизация промисов (без Map)
GD._uid8Promises = GD._uid8Promises || {};
GD.ensureUid8 = function (tgId) {
  var key = String(tgId || 'anon');
  if (!GD._uid8Promises[key]) {
    GD._uid8Promises[key] = GD.getOrFetchUid8(tgId);
  }
  return GD._uid8Promises[key];
};
</script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>GLITCH DROP — Mini App</title>

  <style>
 :root{
  --bg-top:#050814;
  --bg-bot:#0a1022;
  --grid:rgba(255,255,255,.025);
  --grid-gap:36px;

  --panel:#070b18;
  --panel2:#0a0f22;

  --card:#0b1026;
  --card2:#0d1230;

  --neon-cyan:#16f1ff;
  --neon-pink:#8a5cff;
  --neon-yellow:#ffe47a;
    --rub-sign-x: -4px; /* <-- меняй это число: -8px левее, +8px правее */
    
    /* только для ценника кейсов */
--case-rub-sign-x: -2px;  /* <-- двигает ₽ влево/вправо ТОЛЬКО в ценнике */
--case-rub-gap: 2px;      /* <-- зазор между числом и ₽ ТОЛЬКО в ценнике */

/* ===== для "Цена" в модалке барабана (detail) ===== */
--detail-rub-gap: 4px;      /* <-- зазор между числом и ₽ в барабане */
--detail-rub-sign-x: 2px;   /* <-- сдвиг ₽ по X в барабане (минус=влево, плюс=вправо) */

/* ===== зазор между ячейками барабана ===== */
--reel-gap: 12px;           /* меняй: 0px / 8px / 12px / 16px ... */

  --text:#e8efff;
  --muted:#9fb2d9;
  --border:rgba(120,180,255,.22);

  --shadow-strong:0 18px 50px rgba(5,10,40,.7), 0 0 80px rgba(22,241,255,.07);
  --shadow-soft:0 8px 22px rgba(5,10,40,.45);

  --radius:20px;
  --tabbar-h: 84px;  /* дефолт, дальше пересчитаем JS-ом */
    --rub-gap: 2px; /* <-- меняй это число: 0px вплотную, 1–3px чуть свободнее */
}


     *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif}
    html{scroll-behavior:smooth; scrollbar-gutter: stable;}
    body{ color:var(--text); overflow-x:hidden; background:var(--card); overflow-y:scroll; }
.cyber-bg{
  position:fixed; inset:0; z-index:0; pointer-events:none;
  background: var(--card);
}

   .app{min-height:100%;display:flex;flex-direction:column;position:relative;z-index:1}

    .topbar{
      position:sticky; top:0; z-index:30;
      padding:12px 12px 10px;
      background:transparent;
      border-bottom:none;
      backdrop-filter:none;
      box-shadow:none;
    }

    .tb-shell{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      border-radius:28px;
      background:linear-gradient(180deg, rgba(20,26,62,.78), rgba(10,14,32,.72));
      border:1px solid rgba(140,170,255,.22);
      backdrop-filter:blur(14px) saturate(1.2);
      box-shadow:0 18px 50px rgba(5,10,40,.65), 0 0 80px rgba(22,241,255,.06);
    }

    .tb-left{ display:flex; align-items:center; gap:12px; min-width:0; }

    .tb-ava{
      width:54px; height:54px;
      border-radius:50%;
      overflow:hidden;
      position:relative;
      flex:0 0 54px;
      border:2px solid rgba(140,170,255,.22);
      box-shadow:0 0 18px rgba(22,241,255,.10), 0 0 18px rgba(138,92,255,.08);
      background:linear-gradient(135deg, rgba(22,241,255,.08), rgba(138,92,255,.10));
    }
    .tb-ava .avatar{ width:100%; height:100%; border-radius:50%; border:none; box-shadow:none; object-fit:cover; background:transparent; }
    .tb-ava .avatar.hidden{ display:none; }
    .tb-ava .avatar-fallback{
      position:absolute; inset:0;
      border-radius:50%;
      display:grid; place-items:center;
      background:linear-gradient(135deg, rgba(22,241,255,.18), rgba(138,92,255,.18));
      border:none;
      font-weight:900;
      letter-spacing:.5px;
      color:#e8efff;
      text-shadow:0 0 12px rgba(22,241,255,.35);
    }

    .tb-text{ display:flex; flex-direction:column; gap:4px; min-width:0; line-height:1.05; }
    .tb-name{
      font-weight:900;
      font-size:22px;
      letter-spacing:.2px;
      color:#e8efff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tb-id{
      font-size:13px;
      font-weight:800;
      color:rgba(255,255,255,.55);
      letter-spacing:.4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .tb-right{ display:flex; align-items:center; gap:12px; flex:0 0 auto; }
    .tb-balance{
      display:flex;
      align-items:baseline;
      gap:6px;
      font-weight:900;
      font-size:26px;
      letter-spacing:.3px;
      color:#e8efff;
    }
    .tb-rub{
      font-weight:900;
      font-size:inherit;
      line-height:1;
      color:var(--neon-yellow);
      text-shadow:0 0 10px rgba(255,228,122,.28);
      transform:translateY(-1px);
    }

    .avatar{ width:42px; height:42px; border-radius:50%; border:2px solid rgba(22,241,255,.55); box-shadow:0 0 18px rgba(22,241,255,.28), 0 0 28px rgba(255,62,208,.18); object-fit:cover; background:linear-gradient(135deg, rgba(22,241,255,.15), rgba(255,62,208,.15)); }
    .avatar.hidden{ display:none; }
    .avatar-fallback{ width:42px; height:42px; border-radius:12px; display:grid; place-items:center; background:linear-gradient(135deg, rgba(22,241,255,.18), rgba(255,62,208,.18)); border:1px solid var(--border); font-weight:900; letter-spacing:.5px; color:#081121; text-shadow:0 0 12px rgba(22,241,255,.7); }
    .brand{position:relative; font-weight:900; line-height:1; letter-spacing:1px}
    .brand .glitch{ font-size:22px; color:#cfe6ff; position:relative; display:inline-block; text-shadow:0 0 24px rgba(22,241,255,.55), 0 0 24px rgba(255,62,208,.35); }
    .brand .glitch::before,.brand .glitch::after{ content:attr(data-text); position:absolute; left:0; top:0; width:100%; overflow:hidden; }
    .brand .glitch::before{ transform:translateX(1px); color:var(--neon-cyan); opacity:.9; text-shadow:0 0 10px rgba(22,241,255,.8); animation:glitch 3s infinite ease-in-out;}
    .brand .glitch::after { transform:translateX(-1px); color:var(--neon-pink); opacity:.8; text-shadow:0 0 10px rgba(255,62,208,.8); animation:glitch 2.6s infinite ease-in-out reverse;}
    @keyframes glitch{ 0%,100%{clip-path:inset(0 0 0 0)} 10%{clip-path:inset(0 0 65% 0)} 20%{clip-path:inset(0 0 0 0)} 30%{clip-path:inset(40% 0 0 0)} 45%{clip-path:inset(0 0 0 0)} 60%{clip-path:inset(0 0 75% 0)} 80%{clip-path:inset(20% 0 10% 0)} }
    .grow{flex:1}

    .pill{
      display:flex; align-items:center; gap:10px; padding:8px 12px;
      border-radius:999px; border:1px solid var(--border);
      background:linear-gradient(135deg, rgba(22,241,255,.1), rgba(138,92,255,.12));
      box-shadow:0 0 18px rgba(22,241,255,.12) inset;
      font-weight:900; color:#cfe6ff;
    }
    /* базовый размер иконок */
    .pill img{width:18px; height:18px; display:block; object-fit:cover; border-radius:4px}
    /* единый увеличенный размер для обеих пилюль */
    .pill--lg{ padding:10px 14px; }
    .pill--lg img{ width:24px; height:24px; }

.chipbar{
  position:sticky;
  top: var(--topbar-h, 64px);
  z-index:25;

  display:flex;
  gap:10px;
  padding:10px 14px 6px;
  overflow-x:auto;

  background:transparent;
  border-bottom:none;
  backdrop-filter:none;
}

.chipbar::-webkit-scrollbar{display:none}

.chip{
  padding:8px 14px;
  border-radius:999px;
  white-space:nowrap;
  cursor:pointer;
  user-select:none;

  font-weight:900;
  font-size:14px;
  letter-spacing:.3px;

  color:#a7b8df;
  background:linear-gradient(180deg, rgba(10,14,32,.9), rgba(8,10,24,.9));
  border:1px solid rgba(140,170,255,.18);

  box-shadow:none;

  /* важное против “прыжков” на таче */
  transform: translateY(0) scale(1);
  will-change: transform;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;

  transition:
    transform .16s cubic-bezier(.25,.8,.25,1),
    background .15s,
    color .15s,
    border-color .15s;
}

/* НЕ двигаем при hover (на тачах hover залипает) */
.chip:hover{
  transform:none;
}

/* НЕ двигаем при самом нажатии пальцем */
.chip:active{
  transform:none;
}

/* вот ЕДИНСТВЕННОЕ движение — только активный */
.chip.active{
  color:#081121 !important;
  background:linear-gradient(135deg, #16f1ff, #8a5cff) !important;
  border-color:transparent !important;

  transform: translateY(-2px) scale(1.06);
}

    .content{
  flex:1;
  padding:16px;
  max-width:1100px;
  margin:0 auto;
  width:100%;
  padding-bottom: max(var(--tabbar-h,84px), env(safe-area-inset-bottom) + 16px);
}

/* ====== CARD кейса (обновлённый) ====== */
.card{
  position:relative;
  padding:10px;
  gap:8px;
  overflow:hidden;
  cursor:pointer;
  border-radius:var(--radius);
  border:1px solid rgba(140,170,255,.2);
  background:linear-gradient(180deg, var(--card), var(--card2));
  box-shadow:var(--shadow-strong);

  transform:translateY(0) scale(1);
  transition:
    transform .14s cubic-bezier(.25,.8,.25,1),
    box-shadow .14s ease-out,
    border-color .14s ease-out;
}

/* пока палец на карточке — убираем transition, чтобы не “резинило” */
.card.tilting{
  transition:none !important;
}

/* лёгкая “глубина” контента */
.card .inner,
.card .card-footer{
  transform: translateZ(18px);
}

/* мягкий неон вокруг карточки */
.card::before{
  content:"";
  position:absolute;
  inset:-2px;
  background:conic-gradient(
    from 200deg,
    transparent,
    rgba(22,241,255,0.18),
    transparent 30%,
    rgba(255,62,208,0.18),
    transparent 55%
  );
  filter:blur(14px);
  opacity:.35;
  z-index:0;
  pointer-events:none;
}

/* затемнение содержимого при выборе */
.card::after{
  content:"";
  position:absolute;
  inset:0;
  background:radial-gradient(circle at 50% 50%, rgba(0,0,0,0.12), rgba(0,0,0,0.70));
  opacity:0;
  pointer-events:none;
  transition:opacity .14s ease-out;
  z-index:1;
}

.inner{
  position:relative;
  z-index:2;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.thumb{
  position:relative;
  height:170px;
  border-radius:18px;
  border:1px solid rgba(140,170,255,.18);
  background:
    radial-gradient(140px 110px at 20% 20%, rgba(22,241,255,.12), transparent 60%),
    radial-gradient(140px 110px at 80% 80%, rgba(138,92,255,.14), transparent 60%),
    linear-gradient(180deg,#070b1d,#050815);
  overflow:hidden;
}

.thumb::after{
  content:"";
  position:absolute;
  inset:0;
  background:radial-gradient(circle at 50% 75%, rgba(0,0,0,0.0), rgba(0,0,0,.55));
  pointer-events:none;
}

.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}

.case-overlay{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  gap:6px;
  padding:14px 14px 16px;
  z-index:2;
  text-align:center;
}

.case-title{
  font-weight:1000;
  letter-spacing:.8px;
  text-transform:uppercase;
  font-size:20px;
  text-shadow:0 10px 22px rgba(0,0,0,.55);
}

.case-sub{
  font-size:14px;
  color:rgba(232,239,255,.8);
  text-shadow:0 10px 22px rgba(0,0,0,.55);
  margin-top:-2px;
}

.price-pill{
  display:flex;
  align-items:center;
  justify-content:center;
  gap: var(--case-rub-gap);
  padding:10px 12px;
  border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(140,170,255,.22);
  box-shadow: inset 0 0 16px rgba(255,255,255,.04);
  transform: translateY(5px);
}

.price-pill-text{
  font-weight:900;
  color:#e8efff;
  letter-spacing:.3px;
}

.price-pill-cur{
  font-weight:900;
  color:rgba(232,239,255,.75);
  transform: translateX(var(--case-rub-sign-x));
}

html:not(.in-telegram) .card .price-pill{
  display:none;
}

/* ЦЕНТРАЛЬНАЯ КНОПКА «ОТКРЫТЬ» — ПРЯМО ПО ЦЕНТРУ КАРТОЧКИ */
.card-open-btn{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%) scale(0.9);
  padding:12px 24px;
  border-radius:999px;
  border:1px solid rgba(255,228,122,0.85);
  background:linear-gradient(135deg, #ffe64a, #ffb300);
  color:#241400;
  font-weight:900;
  letter-spacing:.7px;
  text-transform:uppercase;
  box-shadow:
    0 12px 32px rgba(255,228,122,0.45),
    0 0 36px rgba(255,228,122,0.75);
  opacity:0;
  pointer-events:none;
  transition:
    opacity .12s ease-out,
    transform .14s cubic-bezier(.25,.8,.25,1),
    box-shadow .14s ease-out;
  z-index:3;
}

.card-open-btn:active{
  transform:translate(-50%, -50%) scale(0.96);
  box-shadow:
    0 6px 18px rgba(255,228,122,0.45),
    0 0 24px rgba(255,228,122,0.70);
}

/* СОСТОЯНИЕ ВЫБРАННОЙ КАРТОЧКИ — «набухла» и с подсветкой */
.card.case-selected{
  transform:translateY(-2px) scale(1.03) rotateX(var(--rx)) rotateY(var(--ry));
  border-color:var(--neon-cyan);
  box-shadow:
    0 18px 40px rgba(22,241,255,0.45),
    0 0 40px rgba(255,228,122,0.75);
}

.card.case-selected::after{
  opacity:1; /* затемнение */
}
.card.case-selected .card-open-btn{
  opacity:1;
  pointer-events:auto;
  transform:translate(-50%, -50%) scale(1);
}
.card.case-selected .inner,
.card.case-selected .card-footer{
  filter:brightness(0.9);
}

.tabbar{
  position: fixed;
  left: 10px; right: 10px; bottom: 10px;
  z-index: 80;

  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 4px;

  padding: 7px 8px;
  padding-bottom: calc(env(safe-area-inset-bottom) + 7px);

  background: linear-gradient(180deg, rgba(10,14,32,.88), rgba(7,9,20,.92));
  border: 1px solid rgba(140,170,255,.20);
  border-radius: 28px;

  backdrop-filter: blur(14px) saturate(1.25);
  box-shadow:
    0 16px 48px rgba(0,0,0,.65),
    0 0 40px rgba(138,92,255,.18),
    inset 0 0 18px rgba(59,232,255,.06);
}

.tab{
  position: relative;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;

  gap: 3px;
  padding: 5px 2px;

  border-radius: 16px;

  color: #9fb2d9;
  font-size: 11.5px;
  font-weight: 900;
  letter-spacing: .25px;
  line-height: 1.05;

  cursor:pointer;
  transition:
    transform .16s ease,
    color .16s ease,
    background .2s ease;
}

.tab:hover{
  background: rgba(120,160,255,.06);
  transform: translateY(-1px);
  color: #dbe6ff;
}

/* контейнер под иконку — оставим не очень большим,
   чтобы он не тянул высоту таббара */
.ico{
  width: 34px;
  height: 34px;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  overflow: visible;
  border-radius: 12px;
}


/* реальный размер картинки маленький, а визуально увеличиваем scale-ом */
.ico img{
  width: 24px;
  height: 24px;
  display:block;
  object-fit: contain;

  transform: translateY(0.5px) scale(1.45);
  transform-origin:center;
  filter: drop-shadow(0 0 6px rgba(120,160,255,.35));

  transition:
    transform .18s ease,
    filter .18s ease;
}

/* активная вкладка — мягкий неоновый ореол без жёстких границ */
.tab.active{
  color: #eaf1ff;
  background: linear-gradient(180deg, rgba(59,232,255,.10), rgba(138,92,255,.12));
  transform: translateY(-4px);
}

.tab.active .ico{
  background:
    radial-gradient(80% 80% at 50% 20%, rgba(59,232,255,.28), transparent 60%),
    radial-gradient(90% 90% at 50% 90%, rgba(138,92,255,.34), transparent 65%);
  box-shadow:
    0 0 18px rgba(59,232,255,.45),
    0 0 26px rgba(138,92,255,.35);
}

.tab.active .ico img{
  transform: translateY(0) scale(1.7);
  filter:
    drop-shadow(0 0 10px rgba(59,232,255,.9))
    drop-shadow(0 0 14px rgba(138,92,255,.8));
}

/* светящийся индикатор снизу активной вкладки */
.tab.active::after{
  content:"";
  position:absolute;
  bottom: -2px;            /* было 4px — опускаем ниже текста */
  left:50%;
  width: 18px;
  height: 4px;
  border-radius: 999px;
  transform: translateX(-50%);
  background: linear-gradient(90deg, var(--neon-cyan), #b58cff);
  box-shadow: 0 0 10px rgba(59,232,255,.9);
}


/* лёгкий glow при наведении — мягкий, без рамки */
.tab:hover .ico img{
  transform: translateY(0.5px) scale(1.7);
  filter:
    drop-shadow(0 0 10px rgba(59,232,255,.9))
    drop-shadow(0 0 14px rgba(138,92,255,.8));
}

    .backtop{
  bottom: calc(var(--tabbar-h,84px) + 18px); position:fixed; right:14px; z-index:50; padding:9px 12px; border-radius:12px; font-weight:900; font-size:12px; letter-spacing:.3px; border:1px solid rgba(22,241,255,45); color:#081121; background:linear-gradient(135deg, var(--neon-cyan), var(--neon-pink)); box-shadow:0 10px 28px rgba(22,241,255,35), 0 0 36px rgba(255,62,208,25); opacity:0; pointer-events:none; transform:translateY(8px); transition:opacity .2s, transform .2s;
}
    .backtop.show{opacity:1; pointer-events:auto; transform:translateY(0)}

    /* ===== DETAIL VIEW ===== */
    .detail{
      position:fixed; inset:0; z-index:60; display:none; flex-direction:column;
      background:
        linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bot) 100%),
        repeating-linear-gradient(0deg,  var(--grid) 0 1px,  transparent 1px var(--grid-gap)),
        repeating-linear-gradient(90deg, var(--grid) 0 1px,  transparent 1px var(--grid-gap));
      background-blend-mode: normal, overlay, overlay;
      overflow:auto;
    }
    .detail.show{ display:flex; }
    .d-topbar{ position:sticky; top:0; z-index:61; display:flex; align-items:center; gap:10px; padding:10px 14px; background:linear-gradient(180deg,rgba(8,14,36,.82),rgba(6,10,26,.7)); border-bottom:1px solid var(--border); backdrop-filter:blur(10px); }
    .btn-back{ appearance:none; border:1px solid var(--border); background:transparent; color:var(--text); padding:8px 12px; border-radius:12px; font-weight:900; cursor:pointer; }
    .d-title{font-weight:900}
    .d-body{padding:16px; padding-bottom: max(var(--tabbar-h,84px), env(safe-area-inset-bottom) + 16px); max-width:1100px; margin:0 auto; width:100%}
    .d-hero{display:grid; grid-template-columns:1fr; gap:14px; margin-bottom:10px;}
    .d-thumb{ min-height:200px; height:auto; border-radius:16px; border:1px dashed rgba(180,210,255,.35);
      background: radial-gradient(160px 110px at 20% 20%, rgba(22,241,255,.12), transparent 60%), radial-gradient(160px 110px at 80% 80%, rgba(255,62,208,.10), transparent 60%), linear-gradient(180deg,#0c1230,#0a1028);
      display:grid; place-items:center; color:#a9c2ff; text-transform:uppercase; letter-spacing:1px; }
    .d-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn-spin{ appearance:none; border:none; cursor:pointer; padding:12px 18px; border-radius:14px; font-weight:900; color:#081121; background:linear-gradient(135deg,#ffe28a,#ffc13a); box-shadow:0 10px 28px rgba(255,209,102,.35), 0 0 30px rgba(255,209,102,.25); }

    /* --- Предупреждение "Вы не авторизованы" (только на сайте) --- */

/* по умолчанию скрыто, чтобы в Telegram не мешало */
.d-auth-warning{
  display: none;
}

/* В БРАУЗЕРЕ (html без класса .in-telegram) прячем кнопку "Крутить" и цену */
html:not(.in-telegram) .d-actions{
  display: none;
}

/* и вместо них показываем предупреждение */
html:not(.in-telegram) .d-auth-warning{
  display: flex;
  margin-top: 8px;
}

/* рамка чуть темнее фона, чтобы блок бросался в глаза */
.d-auth-warning .auth-box{
  width: 100%;
  border-radius: 16px;
  padding: 12px 14px;
  background: linear-gradient(
    180deg,
    rgba(8, 14, 36, 0.96),
    rgba(4, 8, 20, 0.96)
  );
  border: 1px solid rgba(255, 77, 109, 0.6); /* тёмно-красная рамка */
  box-shadow:
    0 0 18px rgba(255, 77, 109, 0.25),
    0 0 28px rgba(0, 0, 0, 0.6);
  text-align: center;
}

/* красный жирный заголовок по центру */
.d-auth-warning .auth-title{
  font-weight: 900;
  letter-spacing: 0.6px;
  text-transform: uppercase;
  color: #ff4d6d;
  margin-bottom: 4px;
}

/* тонкий белый текст под заголовком */
.d-auth-warning .auth-sub{
  font-size: 13px;
  font-weight: 400;
  color: #e8efff;
  opacity: 0.9;
}

    .panel{ margin-top:14px; padding:12px; border:1px solid var(--border); border-radius:16px; background:linear-gradient(180deg, rgba(20,26,62,.55), rgba(14,18,40,.6)); }
    .panel h3{margin:0 0 10px; text-align:center}
    .switch{display:flex; align-items:center; gap:10px; font-weight:800}
    .toggle{ width:46px; height:26px; border-radius:999px; position:relative; background:#2a314a; border:1px solid var(--border); cursor:pointer; }
    .toggle::after{ content:""; position:absolute; top:2px; left:2px; width:22px; height:22px; border-radius:50%; background:#fff; transition:transform .18s; }
    .toggle.active{ background:#19e6ff; } .toggle.active::after{ transform:translateX(20px); }
    .qty{display:flex; gap:10px; justify-content:center}
    .qty .q{ min-width:44px; height:40px; border-radius:12px; display:grid; place-items:center; cursor:pointer; border:1px solid var(--border); background:rgba(15,20,48,.6); font-weight:900; }
    .qty .q.active{ outline:2px solid var(--neon-cyan); color:#081121; background:linear-gradient(135deg,var(--neon-cyan),var(--neon-pink)); border-color:transparent }

    .subhead{margin:18px 0 10px; text-align:center; font-weight:900; letter-spacing:1.2px}

    /* ====== LOOT GRID с флипом ====== */
    .loot-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}

    .loot{
      position:relative; width:100%; aspect-ratio:1/1;
      perspective:900px;
      border-radius:14px;
    }
    .loot-inner{
      position:relative; width:100%; height:100%;
      transform-style:preserve-3d;
      transition:transform .45s cubic-bezier(.2,.7,.2,1);
      border-radius:14px;
    }
    .loot.flipped .loot-inner{ transform:rotateY(180deg); }

    .loot-face{
      position:absolute; inset:0;
      border-radius:14px;
      border:1px dashed rgba(180,210,255,.35);
      overflow:hidden;
      backface-visibility:hidden; -webkit-backface-visibility:hidden;
      display:grid; place-items:center;
      background: linear-gradient(180deg,#0c1230,#0a1028);
      color:#a9c2ff; font-size:12px; letter-spacing:1px; text-transform:uppercase;
    }
    .loot-front img{ width:100%; height:100%; object-fit:cover; display:block; }
    .loot-back{
      transform:rotateY(180deg);
      background:
        linear-gradient(180deg, rgba(12,18,48,.88), rgba(8,14,36,.9)),
        radial-gradient(600px 200px at 50% 110%, rgba(22,241,255,.12), transparent 60%),
        radial-gradient(600px 200px at 50% -10%, rgba(255,62,208,.10), transparent 60%);
      padding:12px;
      gap:8px;
    }

    /* «как на скрине» */
    .lb-stats{ width:100%; }
    .lb-stars, .lb-ton{
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      line-height:1.05;
      letter-spacing:.2px;
    }
    .lb-stars{
      font-size:20px;
      color:var(--neon-yellow);
      margin-bottom:4px;
      text-shadow:0 0 12px rgba(255,228,122,.25);
    }
    .lb-ton{
      font-size:18px;
      color:#79c6ff;
      text-shadow:0 0 12px rgba(22,241,255,.22);
    }

/* подсветка выигрыша без трансформаций */
.slice.win{
  outline:2px solid var(--neon-cyan);
  box-shadow:0 0 30px rgba(22,241,255,.28), inset 0 0 14px rgba(22,241,255,.12);
  animation:win-glow 900ms ease-out 1;
}

/* мягкий импульс свечения */
@keyframes win-glow{
  0%   { box-shadow:0 0 0 rgba(22,241,255,0), inset 0 0 0 rgba(22,241,255,0); }
  25%  { box-shadow:0 0 34px rgba(22,241,255,.35), inset 0 0 16px rgba(22,241,255,.14); }
  60%  { box-shadow:0 0 26px rgba(22,241,255,.28), inset 0 0 14px rgba(22,241,255,.12); }
  100% { box-shadow:0 0 30px rgba(22,241,255,.28), inset 0 0 14px rgba(22,241,255,.12); }
}

:root{
  --nick-font-size: 16px;      /* размер шрифта ника */
  --nick-block-width: 12ch;    /* ширина бокса: @ + 8 символов + ... ≈ 12 символов */
}

/* сам ник (glitch-текст) */
#userName.glitch{
  font-size: var(--nick-font-size);
  display: inline-block;

  /* ФИКС: бокс всегда одного размера */
  width:     var(--nick-block-width);
  min-width: var(--nick-block-width);
  max-width: var(--nick-block-width);

  white-space: nowrap;
  overflow: hidden;
  text-overflow: clip; /* троеточие уже приходит из JS */
  margin-bottom: 2px;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}

/* две строки: ник + ID */
.brand-lines{
  display:inline-flex;
  flex-direction:column;
  line-height:1.05;
}

/* строка ID под ником */
.brand .uid{
  font-size:12px;
  font-weight:800;
  color:rgba(255,255,255,.6);
  letter-spacing:.4px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.inventory-page{
  max-width:1100px;
  margin:0 auto;
  padding: 0 12px max(var(--tabbar-h,84px), env(safe-area-inset-bottom) + 16px);
}


.inventory-grid{
  display:grid;
  grid-template-columns:repeat(2, 1fr); /* ВСЕГДА 2 колонки */
  gap:14px;
  padding:12px 4px 0;
}

/* опционально */
.inventory-card{
  position:relative;
  aspect-ratio:1 / 1;
  border-radius:14px;
  border:1px dashed rgba(180,210,255,.35);
  background:
    radial-gradient(120px 80px at 20% 20%, rgba(22,241,255,.10), transparent 60%),
    radial-gradient(120px 80px at 80% 80%, rgba(255,62,208,.08), transparent 60%),
    linear-gradient(180deg,#0b1030,#0a1028);
  box-shadow:0 8px 26px rgba(10,20,60,.32);
  overflow:hidden;
  display:grid; place-items:center;
  user-select:none;
}

.inventory-card-number {
  position: absolute;
  top: 8px;
  left: 8px;
  background: rgba(255, 255, 255, 0.15);
  color: #ffffff;
  border-radius: 4px;
  padding: 3px 6px;
  font-size: 11px;
  font-weight: 900;
  z-index: 2;
  min-width: 24px;
  text-align: center;
  backdrop-filter: blur(4px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.inventory-card img{
  width:88%;
  height:88%;
  object-fit:contain;
  border-radius:12px;
  display:block;
}

/* пустое состояние */
.inventory-empty{
  min-height:40vh;
  display:grid; place-items:center;
  color:#ffffff; opacity:.9;
  font-weight:900; letter-spacing:.6px;
  text-align:center;
}

/* =========================================================
   ИНВЕНТАРЬ — ФОНОВАЯ ПОВЕРХНОСТЬ
   ========================================================= */
.inventory-surface{
  position:relative;
  min-height:100svh; /* растягивается на всю высоту экрана */
  background:
    radial-gradient(60% 40% at 50% -10%, rgba(22,241,255,.06), transparent 60%),
    radial-gradient(60% 40% at 50% 110%, rgba(255,62,208,.05), transparent 60%),
    linear-gradient(180deg, #0b1030 0%, #0a1028 100%);
  border-top:1px solid var(--border);
  box-shadow: inset 0 30px 60px rgba(10,20,60,.35);
}

/* === INVENTORY HEADER — full-bleed до краёв экрана === */
.inventory-header{
  width: 100vw;
  margin-left: calc(50% - 50vw);
  margin-right: calc(50% - 50vw);
  position: relative; /* было sticky */
  top: 0;             /* чтобы не смещалось */
  z-index: 22;

  overflow-x: hidden; /* фолбэк */
  overflow-x: clip;   /* основной вариант */

  padding: 10px max(12px, env(safe-area-inset-left)) 12px max(12px, env(safe-area-inset-right));
  text-align:center;
  font-weight:900;
  letter-spacing:1.4px;
  font-size:clamp(24px, 8vw, 52px);
  color:#e8efff;
  text-shadow: none; /* убрали неон */
  background: linear-gradient(180deg, rgba(12,16,38,88), rgba(10,14,34,82));
  border-bottom:1px solid var(--border);
  backdrop-filter: blur(8px);
}

/* ===== FRIENDS v2 (новый дизайн) ===== */
.friends-wrap{
  max-width: 980px; margin: 12px auto 0; padding: 0 12px;
  padding-bottom: max(var(--tabbar-h,84px), env(safe-area-inset-bottom) + 16px);
}

.friends-header{
  width:100%;
  position: sticky;
  top: 0;
  z-index: 22;
  padding: 10px max(12px, env(safe-area-inset-left)) 12px max(12px, env(safe-area-inset-right));
  text-align:center;
  font-weight:900;
  letter-spacing:1.4px;
  font-size:clamp(24px, 8vw, 52px);
  color:#e8efff;
  text-shadow:0 0 16px rgba(22,241,255,.18);
  background: linear-gradient(180deg, rgba(12,16,38,.88), rgba(10,14,34,.82));
  border-bottom:1px solid var(--border);
  backdrop-filter: blur(8px);
}
.fr-title{
  text-align:center; font-weight:900; letter-spacing:.6px;
  font-size: clamp(18px, 4.6vw, 26px);
  color:#e8efff; text-shadow:0 0 16px rgba(22,241,255,.2);
  margin: 2px 0 6px;
}
.fr-sub{ text-align:center; color:#9fb2d9; font-weight:800; font-size:13px; margin-bottom:12px; }
.fr-sub .bil{ filter: saturate(1.2); }

.fr-cta-row{
  display:grid; grid-template-columns:1fr 44px; gap:10px;
  align-items:stretch; margin-bottom: 10px;
}
.btn{ appearance:none; border:none; cursor:pointer; border-radius:14px; padding:14px 16px; font-weight:900; letter-spacing:.3px; box-shadow: var(--shadow-soft); }
.btn-primary{ color:#081121; background:linear-gradient(135deg, var(--neon-cyan), var(--neon-pink)); border:1px solid transparent; }
.btn-icon{ display:grid; place-items:center; background:linear-gradient(135deg, rgba(15,20,48,.92), rgba(12,16,38,.92)); border:1px solid var(--border); color:#e8efff; width:44px; padding:0; }
.btn-ghost{ color:#e8efff; background:linear-gradient(135deg, rgba(15,20,48,.9), rgba(12,16,38,.9)); border:1px solid var(--border); }

.fr-block-title{ font-weight:900; letter-spacing:.4px; color:#d7e6ff; margin: 4px 0 10px; text-shadow:0 0 12px rgba(22,241,255,.15); }
.fr-promo{ display:grid; grid-template-columns:1fr; gap:10px; }
.fr-input{ width:100%; border-radius:12px; border:1px solid var(--border); background:rgba(15,20,48,.9); color:#e8efff; padding:12px 12px; font-weight:800; outline:none; }
.fr-actions{ display:grid; grid-template-columns:1fr; gap:10px; }

.fr-list-wrap{ margin-top:14px; border:1px solid var(--border); border-radius:16px; background:linear-gradient(180deg, rgba(15,20,48,.72), rgba(12,16,38,.72)); }
.fr-list-head{ display:flex; justify-content:space-between; align-items:center; padding:12px 14px; font-weight:900; color:#e8efff; border-bottom:1px solid var(--border); }
.fr-list{ display:flex; flex-direction:column; gap:8px; padding:10px; }
.fr-item{ display:grid; grid-template-columns: 28px 1fr auto; align-items:center; gap:10px; padding:12px; border-radius:12px; border:1px solid var(--border); background:linear-gradient(135deg, rgba(18,24,56,.7), rgba(12,16,38,.7)); }
.fr-item .n{ font-weight:900; color:#e8efff; }
.fr-item .nm{ font-weight:900; color:#e8efff; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
.fr-item .gain{ display:flex; align-items:center; gap:8px; font-weight:900; color:#e8efff; }
.fr-item .gain img{ width:18px; height:18px; border-radius:4px; object-fit:cover; }

@media (min-width: 680px){
  .fr-cta-row{ grid-template-columns:1fr 48px 1fr; }
  .fr-actions{ grid-template-columns:1fr 1fr; }
}

/* где угодно в CSS */
.friends-page{
  padding-bottom: max(var(--tabbar-h,84px), env(safe-area-inset-bottom) + 16px);
}

/* Лочим скролл без position:fixed у body */
html.scroll-locked, html.scroll-locked body{
  overflow: hidden;
  overscroll-behavior: none; /* без резких пружин на iOS/Android */
}

/* ===== СЕТКА КАРТОЧЕК КЕЙСОВ ===== */
.grid{
  display: grid;
  gap: 14px;
  grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 колонки на мобиле */
  align-items: start;

  perspective: 900px;
  perspective-origin: 50% 40%;
}

@media (min-width: 560px){
  .grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } /* планшет */
}
@media (min-width: 960px){
  .grid{ grid-template-columns: repeat(4, minmax(0,1fr)); } /* десктоп */
}

/* ===== ПРЕВЬЮ В КАРТОЧКЕ — фиксированная высота/пропорции ===== */
.card .thumb{
  /* вариант 1: фикс по высоте (как было) */
  height: 160px !important;

  /* вариант 2: если хочешь пропорции вместо фикс. высоты — раскомментируй: */
  /* aspect-ratio: 16 / 9; height: auto !important; */
}
.card .thumb img{
  width: 100%;
  height: 100%;
  object-fit: cover;   /* картинка заполняет рамку, не тянется по высоте */
  display: block;
}

/* чуть ограничим тексты, чтобы они не раздували карточку */
.card .name{
  display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical;
  overflow: hidden;
}
.card .desc{
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Кнопка неактивна до валидного ввода */
.btn:disabled{
  opacity:.55;
  filter: saturate(.7) brightness(.9);
  cursor:not-allowed;
}

/* Пустая страница под конкурсы — только фон и “воздух” снизу под таббар */
.contests-page{
  padding-bottom: max(var(--tabbar-h,84px), env(safe-area-inset-bottom) + 16px);
}

/* Та же фоновая поверхность, что в инвентаре, чтобы фон был идентичный */
.contests-surface{
  position:relative;
  min-height:100svh;

  overflow-x:hidden;
  overflow-x:clip;
  overscroll-behavior-x:none;
  touch-action:pan-y;

  background:
    radial-gradient(60% 40% at 50% -10%, rgba(22,241,255,.06), transparent 60%),
    radial-gradient(60% 40% at 50% 110%, rgba(255,62,208,.05), transparent 60%),
    linear-gradient(180deg, #0b1030 0%, #0a1028 100%);
  border-top:1px solid var(--border);
  box-shadow: inset 0 30px 60px rgba(10,20,60,.35);
}

/* ===== CONTESTS ===== */
.contests-wrap{
  position:relative;
  min-height:100svh;
  background:
    radial-gradient(60% 40% at 50% -10%, rgba(22,241,255,.06), transparent 60%),
    radial-gradient(60% 40% at 50% 110%, rgba(255,62,208,.05), transparent 60%),
    linear-gradient(180deg, #0b1030 0%, #0a1028 100%);
  border-top:1px solid var(--border);
  box-shadow: inset 0 30px 60px rgba(10,20,60,.35);
  padding-bottom: max(var(--tabbar-h,84px), env(safe-area-inset-bottom) + 16px);
}

.contests-header{
  width: 100vw;
  margin-left: calc(50% - 50vw);
  margin-right: calc(50% - 50vw);
  position: sticky;
  top: var(--topbar-h, 64px);
  z-index: 22;

  /* размеры как у inventory-header */
  padding: 10px max(12px, env(safe-area-inset-left)) 12px max(12px, env(safe-area-inset-right));
  text-align: center;
  font-weight: 900;
  letter-spacing: 1.4px;
  font-size: clamp(24px, 8vw, 52px);

  color: #e8efff;
  text-shadow: 0 0 16px rgba(22,241,255,18);
  background: linear-gradient(180deg, rgba(12,16,38,88), rgba(10,14,34,82));
  border-bottom: 1px solid var(--border);
  backdrop-filter: blur(8px);
}

/* ПРОПУСК: без неона */
#upgradesScreen .contests-header{
  text-shadow: none !important;
}

/* ПРОПУСК: заголовок не “липнет” под topbar */
#upgradesScreen .contests-header{
  position: static;
  top: auto;
}

.contests-list{
  max-width: 980px;
  margin: 10px auto 0;
  padding: 0 12px 20px;
  display:flex;
  flex-direction:column;
  gap: 0; /* разделители сами дадут ритм */
}

/* карточка конкурса */
.cont-card{
  display:grid;
  grid-template-columns: 88px 1fr;
  align-items:center;
  gap: 14px;
  padding: 12px;
  border-radius: 14px;
  background: linear-gradient(135deg, rgba(15,20,48,.82), rgba(12,16,38,.82));
  border: 1px solid var(--border);
  box-shadow: var(--shadow-soft);
}

/* 1:1 окно под изображение */
.cont-img{
  width: 88px;
  aspect-ratio: 1 / 1;
  border-radius: 12px;
  border: 1px dashed rgba(180,210,255,.35);
  background:
    radial-gradient(80px 60px at 50% 50%, rgba(22,241,255,.10), transparent 60%),
    linear-gradient(180deg,#0b1030,#0a1028);
  overflow:hidden;
  display:grid; place-items:center;
}
.cont-img img{
  width: 100%;
  height: 100%;
  object-fit: cover;    /* строго 1:1 без искажений */
  display:block;
}

/* блок справа */
.cont-right{
  display:flex;
  align-items:center;
  gap: 12px;
  min-width: 0;
}

/* синий @username в стиле Telegram */
.cont-username{
  font-weight: 900;
  font-size: clamp(18px, 5.4vw, 32px);
  color: #2AABEE;         /* Telegram-голубой */
  text-decoration: none;
  text-shadow: 0 0 10px rgba(42,171,238,.25);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: pointer;
}

/* маленькая заглушка-кнопка справа (например «Подробнее») */
.cont-btn{
  appearance:none; border:1px solid var(--border);
  background:linear-gradient(135deg, rgba(15,20,48,.9), rgba(12,16,38,.9));
  color:#e8efff; font-weight:900; letter-spacing:.3px;
  border-radius:12px; padding:10px 12px; cursor:pointer;
}
.cont-btn:active{ transform: translateY(1px); }

.contests-list { gap: 10px; } /* вместо 0 */

/* === CONTESTS (fixed, no-scroll) === */
.contests-fixed{
  position: fixed;
  left: 0; right: 0;
  top: var(--topbar-h, 64px);
  bottom: 0; /* ВАЖНО: тянем фон до самого низа под таббар */
  z-index: 22;
  overflow: hidden; /* вообще без скролла */
  background:
    radial-gradient(60% 40% at 50% -10%, rgba(22,241,255,.06), transparent 60%),
    radial-gradient(60% 40% at 50% 110%, rgba(255,62,208,.05), transparent 60%),
    linear-gradient(180deg, #0b1030 0%, #0a1028 100%);
  border-top:1px solid var(--border);
  box-shadow: inset 0 30px 60px rgba(10,20,60,.35);

  /* чтобы контент/текст не уезжал под таббар */
  padding-bottom: max(var(--tabbar-h,84px), env(safe-area-inset-bottom) + 16px);

  display: grid;
  grid-template-rows: auto 1fr; /* шапка + контент */
}

/* шапка всегда видима */
.contests-fixed .contests-header{
  /* размеры как у inventory-header */
  padding: 10px max(12px, env(safe-area-inset-left)) 12px max(12px, env(safe-area-inset-right));
  text-align: center;
  font-weight: 900;
  letter-spacing: 1.4px;
  font-size: clamp(24px, 8vw, 52px);

  color:#e8efff;
  text-shadow:0 0 16px rgba(22,241,255,.18);
  background: linear-gradient(180deg, rgba(12,16,38,.88), rgba(10,14,34,.82));
  border-bottom:1px solid var(--border);

  position: static;  /* переопределяем глобальный sticky */
  width: auto;       /* убираем 100vw из общего стиля */
  margin: 0;         /* снимаем отрицательные маргины */
}

/* контейнер, который центрирует сообщение */
.contests-center{
  display:grid;
  place-items:center; /* по центру и по горизонтали, и по вертикали */
}

/* список внутри фикс-сцены; без прокрутки */
.contests-fixed .contests-list{
  padding: 12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow: hidden; /* даже если много карточек — сцена остаётся неподвижной */
}

/* === ПЛЮС-КАПСУЛА В ТОПБАРЕ === */
.plus-wrap{ position: relative; display: flex; align-items: center; }

.pill-plus{
  appearance:none; cursor:pointer; border:none; outline:none;
  width:44px; height:44px; border-radius:999px;
  display:grid; place-items:center; flex:0 0 auto;
  margin-right: 0;

  background:rgba(10,14,32,.35);
  border:1px solid rgba(140,170,255,.22);
  box-shadow:
    inset 0 0 18px rgba(255,255,255,.04),
    0 10px 28px rgba(0,0,0,.35);
  transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
}
.pill-plus:hover{ transform: translateY(-1px); box-shadow: 0 12px 32px rgba(0,0,0,.45); }
.pill-plus:active{ transform: translateY(0); }
.pill-plus:focus-visible{ outline:2px solid rgba(140,170,255,.6); outline-offset:2px; }

.plus-ico{
  font-weight:900; font-size:26px; line-height:1;
  color:rgba(255,255,255,.78);
  text-shadow:none;
  transform: translateY(-1px);
}

/* === ВЫПАДАЮЩЕЕ МИНИ-МЕНЮ === */
.quickmenu{
  position:absolute; top: calc(100% + 10px); right: 0;
  min-width: 220px; padding:8px;
  border-radius: 14px;
  border:1px solid var(--border);
  background:
    linear-gradient(180deg, rgba(20,26,62,.92), rgba(12,16,38,.94));
  box-shadow: var(--shadow-strong);
  backdrop-filter: blur(10px);
  display:none; z-index: 200;
}
.quickmenu.show{ display:block; animation: qk-pop .18s cubic-bezier(.2,.7,.2,1) both; }

@keyframes qk-pop{
  from{ opacity:0; transform: translateY(6px) scale(.98); }
  to  { opacity:1; transform: translateY(0)   scale(1); }
}

.qm-item{
  width:100%; text-align:left; cursor:pointer;
  padding:10px 12px; margin:4px 0;
  border-radius:12px; border:1px solid transparent;
  background:linear-gradient(135deg, rgba(15,20,48,.86), rgba(12,16,38,.86));
  color:#e8efff; font-weight:900; letter-spacing:.2px;
  transition: background .15s ease, box-shadow .15s ease, border-color .15s ease;
}
.qm-item:hover{
  border-color: var(--border);
  box-shadow: 0 6px 20px rgba(22,241,255,.14);
}
.qm-item:active{ transform: translateY(1px); }
.qm-item:focus-visible{ outline:2px solid var(--neon-cyan); outline-offset:2px; }

/* «хвостик» под меню */
.plus-wrap::after{
  content:""; position:absolute; top: calc(100% + 2px); right: 12px;
  width: 10px; height: 10px; transform: rotate(45deg);
  background: linear-gradient(180deg, rgba(20,26,62,.92), rgba(12,16,38,.94));
  border-left:1px solid var(--border); border-top:1px solid var(--border);
  filter: drop-shadow(0 2px 6px rgba(10,20,60,.35));
  display:none; z-index: 201;
}

.plus-wrap::after{ display:none; }
.plus-wrap.open::after{ display:block; }

/* ===== TOPUP MODAL ===== */
.modal-topup{ z-index: 120 !important; } /* выше detail (60) и confirm (90) */
.modal-topup::before{
  backdrop-filter: blur(8px);
  background: linear-gradient(180deg, rgba(8,14,36,.60), rgba(6,10,26,.72));
}

/* карточка меньше половины 9:16, аккуратная */
.topup-card{
  position:relative;
  width:min(520px, 92vw);
  height:min(45vh, 520px);
  max-height: 520px;
  border-radius: 20px;
  border:1px solid var(--border);
  background: linear-gradient(180deg, rgba(20,26,62,.80), rgba(14,18,40,.90));
  box-shadow: var(--shadow-strong);
  padding: 14px 14px 16px;
  display:flex; flex-direction:column; gap:10px;
}

/* заголовок */
.topup-title{
  text-align:left;
  font-weight: 900;
  letter-spacing: .6px;
  font-size: clamp(18px, 5.6vw, 28px);
  color: #e8efff;
  text-shadow: 0 0 16px rgba(22,241,255,.18);
  padding-right: 28px; /* место под крестик */
}

/* крестик */
.topup-close{
  position:absolute; top:10px; right:10px;
  appearance:none; border:1px solid var(--border);
  background:linear-gradient(135deg, rgba(15,20,48,.9), rgba(12,16,38,.9));
  color:#e8efff; width:28px; height:28px; border-radius:10px;
  font-weight:900; cursor:pointer; display:grid; place-items:center;
}

/* слайдер */
.topup-slider{ position:relative; flex:1; display:grid; grid-template-columns: 1fr; align-items:center; }
.topup-slider .viewport{
  overflow:hidden; border-radius:18px; border:1px solid var(--border);
  background:linear-gradient(180deg,#0c1230,#0a1028);
  box-shadow: inset 0 0 18px rgba(22,241,255,.12);
  height:100%;
}
.topup-slider .track{
  display:flex; height:100%; will-change: transform;
  transition: transform .26s cubic-bezier(.2,.7,.2,1);
}
.topup-slider .slide{
  min-width: 100%;
  padding: 10px;
  display:grid; place-items:center;
}

/* сам «прямоугольник» внутри слайда — в твоём стиле */
.topup-slider .slide::before{
  content:"";
  width: 86%;
  height: 78%;
  border-radius: 26px;
  border:1px solid var(--border);
  background:
    linear-gradient(135deg, rgba(22,241,255,.14), rgba(138,92,255,.18)),
    radial-gradient(160px 110px at 20% 20%, rgba(22,241,255,.12), transparent 60%),
    radial-gradient(160px 110px at 80% 80%, rgba(255,62,208,.10), transparent 60%),
    linear-gradient(180deg,#0c1230,#0a1028);
  box-shadow:
    inset 0 0 24px rgba(22,241,255,.12),
    0 10px 30px rgba(10,20,60,.35);
  display:block;
}

/* Уменьшаем ширину прямоугольника для большего расстояния от стрелок */
.topup-slider .slide::before {
  width: 76% !important;
}

/* стрелки */
.topup-slider .nav{
  position:absolute; top:50%; transform:translateY(-50%);
  width:38px; height:38px; border-radius:12px;
  appearance:none; border:1px solid var(--border);
  background:linear-gradient(135deg, rgba(15,20,48,.92), rgba(12,16,38,.92));
  color:#e8efff; font-weight:900; font-size:22px; line-height:1;
  display:grid; place-items:center; cursor:pointer;
  box-shadow: var(--shadow-soft);
}
.topup-slider .nav.prev{ left:6px; }
.topup-slider .nav.next{ right:6px; }

/* точки */
.topup-dots{ display:flex; justify-content:center; gap:8px; margin-top:4px; }
.topup-dots .dot{
  width:10px; height:10px; border-radius:999px; border:none; cursor:pointer;
  background: rgba(255,255,255,.34);
  box-shadow: none;
}
.topup-dots .dot.active{
  background: #fff;
  box-shadow: 0 0 10px rgba(255,255,255,.6), 0 0 16px rgba(22,241,255,.25);
}
.topup-dots .dot[aria-selected="true"]{ outline: none; }

/* подтвердить */
.topup-confirm{
  width:100%;
  margin-top: 4px;
  color:#081121;
  background:linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
  border:1px solid transparent;
  font-weight:900; letter-spacing:.3px;
  border-radius:14px; padding:12px 16px;
}

/* ===== TOPUP SLIDER - УЛУЧШЕННЫЕ СТИЛИ ===== */
.topup-slider .track {
    display: flex;
    height: 100%;
    will-change: transform;
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.topup-slider .slide {
    min-width: 100%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Улучшение для точек - КОМПАКТНЫЙ ВАРИАНТ */
.topup-dots {
    display: flex;
    justify-content: center;
    gap: 8px; /* уменьшил расстояние между точками */
    margin-top: 4px;
}

.topup-dots .dot {
    width: 20px;           /* Длина линии */
    height: 3px;           /* Толщина линии */
    border-radius: 2px;    /* Слегка скругленные края */
    background: rgba(255, 255, 255, 0.4);  /* Цвет неактивной линии */
    border: none;          /* Убираем обводку */
}

.topup-dots .dot {
    width: 20px;
    height: 3px;
    border-radius: 2px;
    background: rgba(255, 255, 255, 0.4);
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.topup-dots .dot.active {
    background: var(--neon-cyan);
    box-shadow: 0 0 8px rgba(22, 241, 255, 0.6);
    transform: scaleX(1.2);
}

.topup-dots {
    display: flex;
    justify-content: center;
    width: 100%;
    gap: 6px;
    margin-top: 10px; /* вертикаль НЕ трогаем */
}

.topup-dots .dot::after {
    content: '';
    position: absolute;
    top: -6px;
    left: -6px;
    right: -6px;
    bottom: -6px;
    border-radius: 50%;
}

.topup-dots .dot::after {
    content: '';
    position: absolute;
    top: -4px;
    left: -4px;
    right: -4px;
    bottom: -4px;
    border-radius: 50%;
}

/* Улучшение стрелок */
.topup-slider .nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 44px;
    height: 44px;
    border-radius: 12px;
    appearance: none;
    border: 1px solid var(--border);
    background: linear-gradient(135deg, rgba(15, 20, 48, 0.92), rgba(12, 16, 38, 0.92));
    color: #e8efff;
    font-weight: 900;
    font-size: 20px;
    line-height: 1;
    display: grid;
    place-items: center;
    cursor: pointer;
    box-shadow: var(--shadow-soft);
    z-index: 10;
    transition: all 0.2s ease;
}

.topup-slider .nav:hover {
    background: linear-gradient(135deg, rgba(22, 241, 255, 0.15), rgba(138, 92, 255, 0.15));
    border-color: var(--neon-cyan);
    transform: translateY(-50%) scale(1.05);
}

.topup-slider .nav:active {
    transform: translateY(-50%) scale(0.95);
}

.topup-slider .nav.prev { left: 10px; }
.topup-slider .nav.next { right: 10px; }

/* Адаптивность */
@media (max-width: 480px) {
    .topup-slider .nav {
        width: 36px;
        height: 36px;
        font-size: 16px;
    }
    
    .topup-slider .nav.prev { left: 6px; }
    .topup-slider .nav.next { right: 6px; }
}

/* ===== СТИЛИ ДЛЯ ИЗОБРАЖЕНИЙ В СЛАЙДЕРЕ ===== */
.topup-slider .slide-img {
    position: absolute;
    width: 76%;
    height: 78%;
    border-radius: 26px;
    object-fit: cover;
    display: block;
    border: 2px solid transparent; /* Невидимая рамка */
    background: transparent;
}

/* Убираем старый псевдоэлемент и заменяем на картинку */
.topup-slider .slide::before {
    display: none;
}

/* Чтобы модалка ввода суммы была поверх модалки выбора способа оплаты */
#topupAmountModal {
  z-index: 130;
}

/* === TOPBAR PILLS — выше, уже; плюс — кругом; сдвиг влево === */
:root{
  --topbar-pill-w: 88px;
  --topbar-pill-h: 40px;
}

/* НОВЫЙ ТОПБАР: убираем все старые сдвиги/ужимания */
.topbar{
  padding:12px 12px 10px;
}

.topbar .pill-plus{
  margin-left: 0;
  transform: none;
}

.topbar .pill:first-of-type{
  margin-left: 0;
}

/* Друзья: растяжка списка вниз при сохранении текущего верха */
.friends-wrap{
  /* превращаем обёртку в колонку, чтобы нижний блок мог занять остаток */
  display: flex;
  flex-direction: column;

  /* тянем всю страницу друзей до 20px над таббаром */
  min-height: calc(100vh - var(--tabbar-h, 84px) - 20px - env(safe-area-inset-bottom, 0px));
}

/* сама "таблица" (обёртка списка) занимает всё оставшееся место */
.fr-list-wrap{
  display: flex;
  flex-direction: column;
  flex: 1 1 auto;
  min-height: 0; /* важно, чтобы .fr-list могла расти внутри */
}

/* список внутри — на всю высоту .fr-list-wrap */
.fr-list{
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 10px;
}

/* пустое состояние по центру расширенной "таблицы" */
.fr-empty{
  flex: 1 1 auto;
  display: grid;
  place-items: center;
  text-align: center;
  padding: 16px;
  font-weight: 900;
  letter-spacing: .4px;
  color: #9fb2d9;
  opacity: .95;
}

/* Друзья — компактнее вертикальные интервалы без промокода */
.friends-wrap{
  display:flex;
  flex-direction:column;
  row-gap: 8px;                 /* общий «ритм» */
}

/* пара "текст сверху" */
.fr-title{ margin-top: 6px; margin-bottom: 2px; }
.fr-sub{   margin: 0 0 6px 0; }

/* ряд с кнопками */
.fr-cta-row{
  gap: 8px;
  margin: 0;                    /* убираем лишний отступ снизу */
}

/* сразу за кнопками идёт таблица — почти без верхнего зазора */
.fr-list-wrap{ margin-top: 6px; }

/* шапка списка и сам список — плотнее */
.fr-list-head{ padding-top: 4px; padding-bottom: 6px; }
.fr-list{ padding-top: 8px; padding-bottom: 10px; }

.floating-error .err-topup{
  background: transparent;
  border: none;
  padding: 0;
  font: inherit;
  color: #6fb1ff;           /* синий */
  text-decoration: underline;
  cursor: pointer;
}

/* ===== КНОПКА "ВОЙТИ ЧЕРЕЗ TELEGRAM" НА САЙТЕ ===== */

.landing-login-wrap{
  position: fixed;         /* всегда прижата к верху окна */
  top: 0;
  left: 0;
  right: 0;
  z-index: 110;            /* выше контента и таббара, но ниже топовых оверлеев */
  display: flex;
  justify-content: center;
  padding: 16px 12px 8px;
  background: linear-gradient(180deg, rgba(8,14,36,.95), rgba(6,10,26,.85));
  border-bottom: 1px solid var(--border);
  backdrop-filter: blur(10px);
}

/* сама кнопка */
.landing-login-btn{
  width: 100%;
  max-width: 420px;
  border-radius: 999px;
  padding: 14px 18px;
  border: 1px solid rgba(22,241,255,0.6);
  font-weight: 900;
  font-size: 16px;
  letter-spacing: .8px;
  text-transform: uppercase;
  cursor: pointer;

  background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
  color: #081121;
  box-shadow:
    0 12px 32px rgba(22,241,255,0.35),
    0 0 40px rgba(255,62,208,0.25);
  text-align: center;
}

.landing-login-btn:active{
  transform: translateY(1px);
}

/* Внутри Telegram mini-app кнопку прячем */
.in-telegram .landing-login-wrap{
  display: none;
}

/* А вот на САЙТЕ полностью убираем верхний топбар,
   чтобы его «перекрывал» баннер с кнопкой */
.on-site .topbar{
  display: none;
}

.amount-meta {
  margin-top: 0;                 /* прям вплотную к полю */
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 8px;
}

/* "Вы получите ..." слева */
.amount-meta-left {
  flex: 1;
  text-align: left;
}

/* Модалка вывода предметов */
.withdraw-modal .modal-card {
  max-width: 480px;
  padding: 20px;
}

.withdraw-steps {
  margin: 16px 0;
  line-height: 1.5;
  color: #e8efff;
}

.withdraw-steps ol {
  margin: 0;
  padding-left: 20px;
}

.withdraw-steps li {
  margin-bottom: 12px;
}

.moderator-link {
  color: #2AABEE;
  text-decoration: none;
  font-weight: 700;
  cursor: pointer;
}

.moderator-link:hover {
  text-decoration: underline;
}

.withdraw-close-btn {
  width: 100%;
  margin-top: 10px;
  color: #081121;
  background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
  border: 1px solid transparent;
  font-weight: 900;
  letter-spacing: .3px;
  border-radius: 14px;
  padding: 12px 16px;
}

h2.section{
  margin:18px 2px 14px;
  font-size:34px;
  font-weight:1000;
  letter-spacing:0;
  color:#e8efff;

  text-transform:none;
  text-shadow:0 0 18px rgba(0,0,0,.35);
}


/* =========================
   LIVE 3D GRID BACKGROUND
   ========================= */

#live-grid-bg{
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  overflow: hidden;
}

/* общий слой */
#live-grid-bg > div{
  position:absolute;
  inset:-4%;
  width:108%;
  height:108%;
}

/* 1) БАЗА: твоя картинка */
#live-grid-bg .grid-base{
  background: var(--card);
  background-image: none;
  filter: none;
  transform: none;
  animation: none;
  opacity: 1;
}

/* 2) ПОДСВЕТКА ЛИНИЙ: мягкое мерцание */
#live-grid-bg .grid-glow{
  opacity: 0;
  animation: none;
}


/* 3) “СКАН-ВОЛНЫ” по линиям сетки */
#live-grid-bg .grid-scan{
  opacity: 0;
  animation: none;
}

/* если у тебя контент вдруг перекрывается фоном — подними его */
.app, #root, body > .app-wrap, .wrap{
  position: relative;
  z-index: 1;
}

/* ====== Анимации ====== */

/* лёгкое движение всей картинки */
@keyframes gridDrift{
  0%   { transform: translate3d(0,0,0) scale(1.03); }
  50%  { transform: translate3d(-1.2%,-0.8%,0) scale(1.05); }
  100% { transform: translate3d(1.2%,0.8%,0) scale(1.04); }
}

/* дыхание подсветки */
@keyframes glowBreath{
  0%   { opacity:.55; transform: scale(1) }
  100% { opacity:1;   transform: scale(1.03) }
}

/* скан по X */
@keyframes scanX{
  0%   { transform: translateX(-35%); }
  100% { transform: translateX(35%); }
}

/* скан по Y */
@keyframes scanY{
  0%   { transform: translateY(-30%); }
  100% { transform: translateY(30%); }
}

/* FIX: активная иконка сразу нужного размера */
.tab.active .ico img{
  width: 24px !important;
  height: 24px !important;

  /* делаем сразу “как при касании” */
  transform: translateY(0.5px) scale(1.7) !important;

  filter:
    drop-shadow(0 0 10px rgba(59,232,255,.9))
    drop-shadow(0 0 14px rgba(138,92,255,.8)) !important;
}

/* =========================
   APP LOADER
   ========================= */
#app-loader{
  position: fixed;
  inset: 0;
  z-index: 99999;
  display: grid;
  place-items: center;
  pointer-events: all;

  /* переливающийся фон */
  background:
    radial-gradient(1200px 700px at 20% -10%, rgba(138,92,255,.45), transparent 60%),
    radial-gradient(1000px 600px at 80% 110%, rgba(59,232,255,.38), transparent 60%),
    linear-gradient(135deg, #050614, #0b0f2a, #120b3a, #071a3a);
  background-size: 200% 200%;
  animation: loaderBgShift 6s ease-in-out infinite alternate;
}

@keyframes loaderBgShift{
  0%   { background-position: 0% 30%; filter: hue-rotate(0deg); }
  100% { background-position: 100% 70%; filter: hue-rotate(12deg); }
}

#app-loader .loader-card{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  transform: translateY(-6px);
}

/* круглая картинка + вращение */
#app-loader .loader-logo{
  width: 120px;
  height: 120px;
  border-radius: 999px;
  object-fit: cover;

  box-shadow:
    0 0 25px rgba(59,232,255,.45),
    0 0 35px rgba(138,92,255,.45);

  animation: logoSpin 1.2s linear infinite;
}

@keyframes logoSpin{
  from{ transform: rotate(0deg); }
  to  { transform: rotate(360deg); }
}

/* текст */
#app-loader .loader-text{
  font-weight: 900;
  letter-spacing: .6px;
  font-size: 14px;
  color: rgba(255,255,255,.75);
  text-shadow: 0 0 10px rgba(59,232,255,.25);
}

/* прогресс */
#app-loader .loader-bar{
  width: 170px;
  height: 6px;
  border-radius: 999px;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(160,190,255,.25);
  overflow: hidden;
  box-shadow: inset 0 0 8px rgba(0,0,0,.6);
}

#app-loader .loader-bar-fill{
  height: 100%;
  width: 40%;
  border-radius: 999px;
  background: linear-gradient(90deg, #3be8ff, #8a5cff, #ff61d0);
  box-shadow: 0 0 12px rgba(59,232,255,.6);
  animation: barMove 1.1s ease-in-out infinite;
}

@keyframes barMove{
  0%   { transform: translateX(-110%); }
  100% { transform: translateX(260%); }
}

/* плавное исчезновение */
#app-loader.loaded{
  animation: none;
  opacity: 0;
  transition: opacity .25s ease;
  pointer-events: none;
}

/* OFF: вся подсветка чипов */
.chip{
  box-shadow: none !important;
}
.chip::before,
.chip::after{
  content:none !important;
  display:none !important;
}
.chip:hover{
  box-shadow:none !important;
}
.chip.active::before,
.chip.active::after{
  content:none !important;
  display:none !important;
}

/* Пилюля ₽ — центрируем число + ₽ справа */
.topbar .pill.pill-rub{
  min-width: 120px;
  height: var(--topbar-pill-h);
  padding: 6px 10px;

  display: flex;
  align-items: center;
  justify-content: center;   /* блок по центру пилюли */
  gap: var(--rub-gap);       /* зазор между цифрой и ₽ */
}

/* Цифра баланса */
.topbar .pill.pill-rub .num{
  font-weight: 900;
  font-size: 15px;
  line-height: 1;
  white-space: nowrap;
}

/* Знак ₽ справа от цифры — размер как у цифры */
.topbar .pill.pill-rub .pill-rub-sign{
  font-weight: 900;          /* как у .num */
  font-size: inherit;        /* берёт размер цифры */
  line-height: 1;
  color: var(--neon-yellow);
  text-shadow: 0 0 10px rgba(255,228,122,.35);
  transform: translateY(-0.5px);
}

/* Конкурсы — пустой экран должен перекрывать фон до низа */
.contests-fixed{
  min-height: calc(100vh - var(--topbar-h, 0px) - var(--tabbar-h, 0px));
  display: flex;
  flex-direction: column;
}

/* "Доска" с текстом — растягиваем вниз как в Инвентаре */
.contests-center{
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== SETTINGS SCREEN ===== */
.settings-screen{
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: var(--bg-top);
  display: flex;
  flex-direction: column;
  padding: 14px 14px 90px; /* снизу запас под таббар */
}

.settings-header{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom: 18px;
}

.settings-back{
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  color:#fff;
  padding:8px 12px;
  border-radius:10px;
  font-size:14px;
  cursor:pointer;
}

.settings-title{
  font-weight:700;
  letter-spacing:.12em;
  font-size:14px;
  color:#fff;
  opacity:.9;
}

.settings-list{
  margin-top: 6px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

.settings-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 12px;
  background: rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.08);
  border-radius:12px;
}

.settings-label{
  color:#fff;
  font-size:15px;
  opacity:.95;
}

/* switch */
.switch{
  position:relative;
  width:48px;
  height:28px;
  display:inline-block;
}
.switch input{ display:none; }
.slider{
  position:absolute; inset:0;
  background: rgba(255,255,255,.18);
  border-radius:999px;
  transition:.2s;
}
.slider:before{
  content:"";
  position:absolute;
  width:22px; height:22px;
  left:3px; top:3px;
  background:#fff;
  border-radius:50%;
  transition:.2s;
}
.switch input:checked + .slider{
  background: rgba(120,255,180,.45);
}
.switch input:checked + .slider:before{
  transform: translateX(20px);
}

/* ===== "Цена" в detail/baraбане: число + ₽ как у ценника ===== */
#detailPrice{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--detail-rub-gap);     /* регулируемый зазор */
}

/* сам знак ₽ */
#detailPrice .detail-rub{
  font-size: inherit;            /* размер как у цифр */
  font-weight: inherit;          /* толщина как у цифр */
  line-height: 1;
  color: var(--neon-yellow);     /* золотой как на главной */
  text-shadow: 0 0 12px rgba(255,228,122,0.25);

  display: inline-block;
  transform: translateX(var(--detail-rub-sign-x)); /* регулируемый сдвиг */
}

/* ===== BATTLE PASS — BASE TIMELINE LAYOUT ===== */

.bp-timeline{
  max-width: 720px;
  margin: 0 auto;
  padding: 20px 12px 40px;
  display: flex;
  flex-direction: column;
  gap: 28px;

  position: relative; /* нужно для .bp-mainline */
}

/* светящаяся часть ДО первой точки */
.bp-mainline{
  position: absolute;
  width: 2px;
  border-radius: 999px;

  /* GPU-анимация вместо height/top */
  transform: translate3d(-50%,0,0) scaleY(0);
  transform-origin: top;
  will-change: transform;

  pointer-events: none;
  z-index: 1;

  /* плавнее и медленнее */
  transition: transform .8s cubic-bezier(.16,1,3,1);

  /* БЫЛО: градиент (из-за него низ уходил в другой цвет) */
  background: rgba(22,241,255,35);
  box-shadow: 0 0 8px rgba(22,241,255,25);

  /* плавная "верхушка" — убираем эффект обрезки свечения */
  -webkit-mask-image: linear-gradient(to bottom, transparent 0, #000 18px);
  mask-image: linear-gradient(to bottom, transparent 0, #000 18px);
  -webkit-mask-repeat: no-repeat;
  mask-repeat: no-repeat;
  -webkit-mask-size: 100% 100%;
  mask-size: 100% 100%;

  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}

/* тусклая часть ПОСЛЕ первой точки */
.bp-mainline-dim{
  position: absolute;
  width: 2px;
  border-radius: 999px;

  /* GPU-анимация */
  transform: translate3d(-50%,0,0) scaleY(0);
  transform-origin: bottom;
  will-change: transform;

  pointer-events: none;
  z-index: 1;

 transition: transform .8s cubic-bezier(.16,1,.3,1);

  background: rgba(190, 200, 215, .38); /* <-- СЕРАЯ линия, больше не сливается */
  box-shadow: none;

  /* та же плавная верхушка */
  -webkit-mask-image: linear-gradient(to bottom, transparent 0, #000 18px);
  mask-image: linear-gradient(to bottom, transparent 0, #000 18px);
  -webkit-mask-repeat: no-repeat;
  mask-repeat: no-repeat;
  -webkit-mask-size: 100% 100%;
  mask-size: 100% 100%;

  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}

/* один элемент прогресса */
.bp-item{
  display: grid;
  grid-template-columns: 40px 1fr;
  align-items: stretch;   /* тянем левую колонку до низа карточки */
  column-gap: 16px;
}

/* левая колонка (линия + точка) */
.bp-line-wrap{
  position: relative;
  display: flex;
  justify-content: center;
  align-items: flex-end;  /* точка у нижнего края */
  height: 100%;
}

/* старая сегментная линия — выключаем */
.bp-line{
  display: none;
}

/* точка прогресса */
.bp-node{
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #0b1030;          /* непрозрачная заливка */
  border: 2px solid rgba(180,210,255,6);
  transform: translateY(-9px);  /* подняли точки на ~9px */
  z-index: 3;                   /* точки поверх линии */
}

/* карточка награды */
.bp-card{
  position: relative; /* важно для .bp-card::before */
  border-radius: 16px;
  border: 1px solid var(--border);

  /* переносим “верхний” фон на всю карточку (чтобы не было стыка) */
  background:
    radial-gradient(120px 80px at 20% 20%, rgba(22,241,255,.08), transparent 60%),
    radial-gradient(120px 80px at 80% 80%, rgba(138,92,255,.08), transparent 60%),
    linear-gradient(180deg,#0b1030,#0a1028);

  overflow: hidden;
  transition: border-color .12s ease, box-shadow .12s ease, opacity .12s ease, filter .12s ease;
}

/* область картинки */
.bp-card-img{
  height: 120px;

  /* убираем отдельный фон, чтобы не было “полосы”/стыка */
  background: transparent;

  /* ВАЖНО: убираем relative, чтобы абсолютный img центрировался по .bp-card */
  position: static;
  overflow: visible;
}

.bp-card-img img{
  width: 96px;
  height: auto;
  aspect-ratio: 1 / 1;
  object-fit: contain;
  display: block;

  /* центр по ВСЕЙ карточке (включая зону кнопки “Получить”) */
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);

  /* чтобы картинка никогда не мешала нажимать “Получить” */
  pointer-events: none;
}

/* нижняя часть карточки */
.bp-card-footer{
  padding: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;

  /* футер всегда поверх картинки */
  position: relative;
  z-index: 2;
}

/* название награды */
.bp-card-title{
  font-weight: 900;
  letter-spacing: .4px;
}

/* кнопка (пока просто стиль) */
.bp-card-btn{
  padding: 6px 14px;
  border-radius: 999px;
  font-weight: 900;
  font-size: 12px;
  letter-spacing: .4px;
  background: rgba(120,160,255,.15);
  border: 1px solid rgba(120,160,255,.35);
  color: #e8efff;
  user-select: none;
}

/* ===== BATTLE PASS — SOFT NEON ENHANCEMENTS ===== */

/* линия с лёгким свечением */
.bp-timeline::before{
  background: rgba(22,241,255,35);
  box-shadow: 0 0 8px rgba(22,241,255,25);
}

/* базовый узел */
.bp-node{
  background: #0b1030;
  border-color: rgba(22,241,255,.6);
  box-shadow: 0 0 6px rgba(22,241,255,.35);
}

/* активный узел (пока просто стиль, без логики) */
.bp-node.active{
  border-color: var(--neon-cyan);
  box-shadow:
    0 0 10px rgba(22,241,255,.8),
    0 0 18px rgba(22,241,255,.4);
}

/* карточка — лёгкая глубина */
.bp-card{
  box-shadow:
    0 10px 26px rgba(10,20,60,.45),
    inset 0 0 18px rgba(22,241,255,.06);
}

/* УБИРАЕМ фоновое свечение карточек */
.bp-card::before{
  content: none;
}

/* кнопка — аккуратный неон */
.bp-card-btn{
  background: linear-gradient(
    135deg,
    rgba(22,241,255,.22),
    rgba(138,92,255,.22)
  );
  border-color: rgba(22,241,255,.45);
  box-shadow: 0 0 10px rgba(22,241,255,.25);
}

/* ===== BATTLE PASS — NODE STATES ===== */

/* ПОЛУЧЕНО */
.bp-node.done{
  background: #a0a0a0;              /* непрозрачно */
  border-color: rgba(180,180,180,55);
  box-shadow: none;
}

/* АКТИВНЫЙ */
.bp-node.active{
  background: var(--neon-cyan);
  border-color: var(--neon-cyan);
  box-shadow:
    0 0 10px rgba(22,241,255,.9),
    0 0 20px rgba(22,241,255,.45);
}

/* БУДУЩИЙ */
.bp-node.locked{
  background: #0b1030;
  border-color: rgba(120,140,180,.35);
  box-shadow: none;
}

.bp-item.locked .bp-card{
  opacity: .55;
  filter: grayscale(.4);
}

/* Полученные — НЕ становятся ярче (как до получения первой) */
.bp-item.done .bp-card{
  opacity: .55;
  filter: grayscale(.4);
}

/* АКТИВНАЯ награда — без неонового свечения */
.bp-item.active .bp-card{
  opacity: 1;
  filter: none;
  border-color: rgba(22,241,255,35);
  box-shadow: none;
}

.bp-card-btn.cooldown{
  opacity: .6;
}

  </style>

<style>

.hide { display: none !important; }

/* CTA-кнопки: не ломаем layout, скрываем через visibility */
.spin-cta{
  visibility: hidden;         /* невидимы, но место занято */
  display: inline-flex;       /* фиксированный тип отображения */
  align-items: center;
  gap: 8px;
}
.spin-cta.show{
  visibility: visible;        /* показываем без изменения размеров родителя */
}


/* === 3D барабан (фронтально, одна ячейка) === */
:root{
  /* размеры можно менять из JS */
  --reel-slice-w: 210px;
  --reel-slice-h: 128px;
  --reel-min-h:   360px;
}

.drum-wrap{
  position:relative;
  width:100%;
  height:100%;
  min-height: var(--reel-min-h);
  display:grid; place-items:center;
  perspective: 1200px;
}

.drum-stage{
  position:relative;
  width:min(560px, 92%);
  height:100%;
  border-radius:16px;
  border:1px solid var(--border);
  background:linear-gradient(180deg,#0c1230,#0a1028);
  box-shadow:inset 0 0 24px rgba(22,241,255,.12);
  overflow:hidden;
}

/* фронтально, без наклона */
.drum-tilt{
  position:absolute; inset:18px;
  transform-style:preserve-3d;
}

.drum{
  position:absolute; left:50%; top:50%;
  transform-style:preserve-3d;
  will-change:transform;
}

/* «вкладки» барабана */
.slice{
  position:absolute; left:50%; top:50%;
  width: var(--reel-slice-w);
  height: var(--reel-slice-h);
  margin: calc(-1 * var(--reel-slice-h) / 2) calc(-1 * var(--reel-slice-w) / 2);
  border-radius:14px;
  border:1px dashed rgba(180,210,255,.35);
  background:
    radial-gradient(120px 80px at 20% 20%, rgba(22,241,255,.10), transparent 60%),
    radial-gradient(120px 80px at 80% 80%, rgba(255,62,208,.08), transparent 60%),
    linear-gradient(180deg,#0b1030,#0a1028);
  box-shadow:0 8px 26px rgba(10,20,60,.35);
  display:grid; grid-template-rows:1fr auto; align-items:center; justify-items:center;
  overflow:hidden;
  backface-visibility:hidden; -webkit-backface-visibility:hidden;
}

.slice .meta{
  width:100%; padding:8px 10px;
  font-weight:900; letter-spacing:.3px; font-size:12px; color:#a9c2ff;
  display:flex; align-items:center; justify-content:space-between;
}
.slice .value{
  color:var(--neon-yellow); text-shadow:0 0 12px rgba(255,228,122,.25);
  font-weight:900; font-size:14px;
}

/* центральная линия выигрыша */
.drum-pointer{
  position:absolute; left:0; right:0; top:50%;
  transform:translateY(-50%); height:2px;
  background:linear-gradient(90deg, transparent, var(--neon-cyan), var(--neon-pink), transparent);
  box-shadow:0 0 14px rgba(22,241,255,.45), 0 0 20px rgba(255,62,208,.25);
  pointer-events:none;
}

/* лёгкая виньетка для глубины */
.drum-stage:before, .drum-stage:after{
  content:""; position:absolute; left:0; right:0; height:22%;
  pointer-events:none; z-index:5;
  background:linear-gradient(180deg, rgba(8,14,36,.8), transparent);
}
.drum-stage:after{ bottom:0; top:auto; transform:rotate(180deg); }

/* 🔧 КВАДРАТНАЯ РАМА ДЛЯ КАРТИНКИ В БАРАБАНЕ */
.slice .img{
  position: relative;
  aspect-ratio: 1 / 1;
  width: 100%;
  height: auto;
  padding: 0;
  border-bottom: 1px solid var(--border);
  background: radial-gradient(80px 60px at 50% 50%, rgba(22,241,255,.10), transparent 60%);
  overflow: hidden;
  box-sizing: border-box;
}

/* 🔧 КАРТИНКА ВСЕГДА ЦЕЛИКОМ ВНУТРИ 1:1 РАМЫ */
.slice .img img{
  position: absolute;
  inset: 8px;
  width: calc(100% - 16px);
  height: calc(100% - 16px);
  object-fit: contain;
  display: block;
  max-width: none;
  max-height: none;
  border-radius: 12px;
} /* ← вот этой скобки не хватало */

/* === Оверрайды ТОЛЬКО для барабана === */
.drum .slice {
  grid-template-rows: 1fr;
}

/* рамка 1:1 + центрирование */
.drum .slice .img{
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  padding: 0;
  aspect-ratio: 1 / 1;
  overflow: hidden;
  border-bottom: none;
  background: radial-gradient(80px 60px at 50% 50%, rgba(22,241,255,.10), transparent 60%);
}

/* картинка по центру, без обрезания краёв */
.drum .slice .img img{
  position: static !important;
  inset: auto !important;
  width: 88%;
  height: 88%;
  object-fit: contain;
  border-radius: 12px;
  display: block;
}

/* ===== DROP MODAL (smooth/slow) ===== */
.modal{
  position:fixed; inset:0; z-index:90;   /* выше detail */
  display:flex; align-items:center; justify-content:center;

  opacity:0;
  visibility:hidden;
  pointer-events:none;

  transition:
    opacity .42s ease,
    visibility 0s linear .42s;
}

.modal::before{
  content:""; position:absolute; inset:0;
  background:linear-gradient(180deg, rgba(8,14,36,75), rgba(6,10,26,85));
  backdrop-filter: blur(8px);

  opacity:0;
  transition: opacity .42s ease;
}

/* —— жёстко поверх всего и без шанса быть перекрытой —— */
.loader-overlay{
  z-index: 1000001 !important; /* выше, чем .modal с 99999 */
  pointer-events: all;
}

/* показываем */
.modal.show{
  opacity:1;
  visibility:visible;
  pointer-events:auto;

  transition:
    opacity .42s ease,
    visibility 0s;
}
.modal.show::before{ opacity:1; }

.modal .modal-card{
  z-index: 2;          /* поверх ::before */
}

.modal-card{
  position:relative; z-index:1;
  width:min(520px, 92%); padding:16px;
  border-radius:20px; border:1px solid var(--border);
  background:linear-gradient(180deg, rgba(20,26,62,75), rgba(14,18,40,88));
  box-shadow: var(--shadow-strong);

  opacity:0;
  transform: translateY(22px) scale(.955);
  will-change: transform, opacity;

  transition:
    transform .55s cubic-bezier(.22,1,.36,1),
    opacity .55s ease;
}

.modal.show .modal-card{
  opacity:1;
  transform: translateY(0) scale(1);
}

.modal-title{
  text-align:center; font-weight:900; letter-spacing:.8px;
  margin-bottom:12px; color:#d7e6ff; text-shadow:0 0 16px rgba(22,241,255,.25);
}

.modal-image{
  width:100%; aspect-ratio:1/1; border-radius:16px;
  border:1px dashed rgba(180,210,255,.35);
  background:
    radial-gradient(120px 80px at 50% 50%, rgba(22,241,255,.10), transparent 60%),
    linear-gradient(180deg,#0b1030,#0a1028);
  display:grid; place-items:center; overflow:hidden; margin-bottom:12px;
}
.modal-image img{
  width:88%; height:88%; object-fit:contain; border-radius:12px; display:block;
}

/* === Кнопки действий в модалках (подтверждение и дроп) === */
.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
}

.modal-actions .btn {
  appearance: none;
  cursor: pointer;
  border: none;
  padding: 12px 18px;
  border-radius: 14px;
  font-weight: 900;
  box-shadow: var(--shadow-soft);

  /* 💎 Новые свойства для одинаковой ширины */
  flex: 1 1 0;           /* обе кнопки делят пространство поровну */
  text-align: center;
  min-width: 120px;       /* защита от сжатия */
  max-width: 160px;       /* ограничение, чтобы не растягивались слишком сильно */
}

.modal-actions .btn.keep{
  color:#081121; background:linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
  border:1px solid transparent;
}
.modal-actions .btn.sell{
  color:#e8efff; background:linear-gradient(135deg, rgba(15,20,48,.9), rgba(12,16,38,.9));
  border:1px solid var(--border);

}

/* текст в модалке подтверждения */
.modal-text{
  margin: 6px 0 12px;
  text-align:center;
  font-weight:800;
  letter-spacing:.3px;
  color:#d7e6ff;
}

/* зелёная "ДА" и красная "НЕТ" в глитч-стиле */
.modal-actions .btn.btn-yes{
  color:#081121;
  background:linear-gradient(135deg, #54ffa8, #19e6ff);
  border:1px solid transparent;
  box-shadow:0 10px 28px rgba(25,230,255,.35), 0 0 30px rgba(84,255,168,.25);
}
.modal-actions .btn.btn-no{
  color:#fff;
  background:linear-gradient(135deg, #ff4d6d, #b3123e);
  border:1px solid rgba(255,90,120,.45);
  box-shadow:0 10px 22px rgba(255,77,109,.25);
}


/* === Кнопка ПРОДАТЬ — текст по центру === */
.inv-sell{
  position: absolute;
  left: 10px;
  bottom: 10px;
  transform: none;
  appearance: none;
  border: none;
  padding: 10px 14px;
  border-radius: 999px;
  font-weight: 900;
  letter-spacing: .3px;
  cursor: pointer;
  color: #081121;
  background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
  border: 1px solid rgba(22,241,255,.35);
  box-shadow: 0 8px 22px rgba(22,241,255,.28), 0 0 24px rgba(255,62,208,.22);
  width: calc(50% - 12px);
  text-align: center;

  /* → добавляем абсолютный центр текста ← */
  display: flex;
  justify-content: center;
  align-items: center;
}

.inv-sell:active{
  transform: translateY(1px);
}

/* === Кнопка ВЫВЕСТИ — белый текст === */
.inv-withdraw{
  position: absolute;
  right: 10px;
  bottom: 10px;
  transform: none;
  appearance: none;
  border: 1px solid rgba(22,241,255,.45);
  padding: 10px 14px;
  border-radius: 999px;
  font-weight: 900;
  letter-spacing: .3px;
  cursor: pointer;
  color: #e8efff;
  background: linear-gradient(135deg, rgba(22,241,255,.15), rgba(138,92,255,.18));
  box-shadow: 0 4px 12px rgba(22,241,255,.2);
  width: calc(50% - 12px);
  text-align: center;
  display: flex;
  justify-content: center;
  align-items: center;
  box-sizing: border-box;
  opacity: 1;
  pointer-events: auto;
  transition: all 0.2s ease;
}

.inv-withdraw:active{
  transform: translateY(1px);
  box-shadow: 0 2px 6px rgba(22,241,255,.15);
}

.amount-input-wrapper {
  margin: 20px 0 4px; /* добавили небольшой отступ снизу */
  position: relative;
}

.amount-input {
  width: 100%;
  padding: 16px;
  border: 2px solid var(--border);
  border-radius: 12px;
  background: rgba(15,20,48,.9);
  color: var(--text);
  font-weight: 800;
  font-size: 18px;
  text-align: center;
  outline: none;
  transition: all 0.2s ease;
}

.amount-input:focus {
  border-color: var(--neon-cyan);
  box-shadow: 0 0 20px rgba(22,241,255,.3);
}

.amount-input::placeholder {
  color: #9fb2d9;
  opacity: 0.7;
}

/* Сообщение об ошибке под полем ввода */
.error-message {
  color: #ff4d6d;
  font-size: 14px;
  font-weight: 800;
  margin-top: 5px;
  text-align: center;
  display: none;
}

.error-message.show {
  transform: translateY(0);
  opacity: 1;
}

/* ===== TON WALLET LINE ===== */
.wallet-line{
  margin: 0 0 10px 0;          /* чуть выше инпута */
  padding: 8px 12px;
  border-radius: 12px;
  border: 1px solid rgba(22,241,255,.35);
  background: rgba(7,14,30,.7);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  font-weight: 800;
  font-size: 14px;
  color: #e8efff;
  box-shadow: inset 0 0 12px rgba(22,241,255,.12);
}

.wallet-line-text{
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.wallet-line-close{
  width: 24px;
  height: 24px;
  min-width: 24px;
  border: none;
  background: transparent;
  color: #cfe0ff;
  font-size: 18px;
  line-height: 1;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: .8;
}

.wallet-line-close:hover{ opacity: 1; }

.amount-meta {
  margin-top: 4px;             /* чуть ниже поля */
  display: flex;
  align-items: baseline;
  justify-content: flex-start;
}

.amount-meta-left {
  font-size: 12px;
  font-weight: 800;
  letter-spacing: 0.3px;
  color: #e8efff;
}

/* Анимированное сообщение вверху */
.floating-error {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: linear-gradient(135deg, #ff4d6d, #b3123e);
  color: white;
  padding: 15px 25px;
  border-radius: 12px;
  font-weight: 900;
  letter-spacing: 0.5px;
  text-align: center;
  z-index: 1000;
  box-shadow: 0 10px 30px rgba(255,77,109,.4);
  transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.floating-error.show {
  transform: translateX(-50%) translateY(0);
}

/* Серое уведомление (инвентарь) */
.floating-info {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: linear-gradient(135deg, #d1d5db, #6b7280);
  color: #0b0f1a;
  padding: 14px 22px;
  border-radius: 14px;
  font-size: 15px;
  font-weight: 700;
  z-index: 9999;
  box-shadow: 0 10px 30px rgba(0,0,0,0.28);
  opacity: 0;
  transition: all 0.4s ease;
}
.floating-info.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

/* === КИБЕР-ЗАГРУЗКА ДЛЯ ПОПОЛНЕНИЯ === */

.loader-overlay{
  position: fixed;
  inset: 0;
  z-index: 140; /* выше всех модалок */
  display: none;
  align-items: center;
  justify-content: center;
  background:
    radial-gradient(circle at 15% 0, rgba(22,241,255,.18), transparent 55%),
    radial-gradient(circle at 85% 100%, rgba(255,62,208,.22), transparent 55%),
    rgba(3,8,23,.92);
  backdrop-filter: blur(12px);
}

.loader-overlay.show{
  display: flex;
}

.loader-ring{
  position: relative;
  width: 80px;
  height: 80px;
}

/* Внешнее неоновое кольцо */
.loader-ring::before{
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 50%;
  background: conic-gradient(
    from 0deg,
    var(--neon-cyan),
    var(--neon-pink),
    var(--neon-yellow),
    var(--neon-cyan)
  );
  /* вырезаем центр, чтобы получилось кольцо */
  -webkit-mask: radial-gradient(farthest-side, transparent 58%, #000 60%);
  mask: radial-gradient(farthest-side, transparent 58%, #000 60%);
  animation: loader-spin 0.9s linear infinite;
  box-shadow:
    0 0 26px rgba(22,241,255,.55),
    0 0 34px rgba(255,62,208,.35);
}

/* мягкое ядро в центре */
.loader-ring::after{
  content: '';
  position: absolute;
  inset: 20px;
  border-radius: 50%;
  background:
    radial-gradient(circle, rgba(22,241,255,.2), rgba(10,16,36,1));
  box-shadow: inset 0 0 18px rgba(0,0,0,.7);
}

@keyframes loader-spin{
  to { transform: rotate(360deg); }
}

:root{
  --grid-bg-image: url("assets/images/Untitled (75).png");
}

</style>

<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

<script>
  window.addEventListener('load', function () {
    try {
      if (window.TON_CONNECT_UI && TON_CONNECT_UI.TonConnectUI) {
        window.tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: "https://raw.githubusercontent.com/GlitchDrop/GlitchDrop-miniapp/main/tonconnect-manifest.json",
  language: "ru",
});


        console.log('✅ TonConnectUI инициализирован', window.tonConnectUI);

        // глобальный ключ для сохранения TON кошелька
        window.TON_WALLET_LS_KEY = 'gd_ton_wallet_addr';

        // Слушаем изменение статуса кошелька
        window.tonConnectUI.onStatusChange(function (wallet) {
          console.log('[TonConnect] status change:', wallet);

          // ✅ сохраняем адрес после первой/любой успешной привязки
          try {
            const addr = wallet?.account?.address;
if (addr) {
  const friendlyAddr = normalizeTonAddr(addr);
  localStorage.setItem(window.TON_WALLET_LS_KEY, friendlyAddr);
  if (typeof renderTonWalletLine === 'function') renderTonWalletLine();
}
          } catch (e) {
            console.warn('Не удалось сохранить TON-адрес', e);
          }

          // Если кошелёк подключился и у нас есть ожидающее пополнение — отправляем транзакцию
          if (wallet && window.tonTopupPending) {
            sendTonTopup();
          }
        });

      } else {
        console.error('❌ TON_CONNECT_UI не найден — скрипт tonconnect-ui.min.js не загрузился');
      }
    } catch (e) {
      console.error('❌ Ошибка при инициализации TonConnectUI:', e);
    }
  });
</script>

</head>
<body>

  <!-- APP LOADER OVERLAY -->
<div id="app-loader" aria-live="polite">
  <div class="loader-card">
    <img
      class="loader-logo"
      src="assets/images/Untitled (68).png"
      alt="Loading"
    />
    <div class="loader-text">Загрузка элементов</div>
    <div class="loader-bar">
      <div class="loader-bar-fill"></div>
    </div>
  </div>
</div>

  <div class="cyber-bg"></div>

  <!-- LIVE 3D GRID BG -->
<div id="live-grid-bg">
  <div class="grid-base"></div>
  <div class="grid-glow"></div>
  <div class="grid-scan"></div>
</div>

  <div class="landing-login-wrap">
  <button type="button" id="openMiniAppBtn" class="landing-login-btn">
    ВОЙТИ ЧЕРЕЗ TELEGRAM
  </button>
</div>

  <div class="app" id="top">
    <div class="topbar">
      <div class="tb-shell">
        <div class="tb-left">
          <div class="tb-ava">
            <img id="userAvatar" class="avatar hidden" alt="avatar">
            <div id="avatarFallback" class="avatar-fallback">GD</div>
          </div>

          <div class="tb-text">
            <div id="userName" class="tb-name">GLITCH&nbsp;DROP</div>
            <div id="userId" class="tb-id" aria-label="User ID">ID 00000000</div>
          </div>
        </div>

        <div class="tb-right">
          <div class="tb-balance" title="Баланс ₽">
            <span id="rubBalance">0</span>
            <span class="tb-rub" aria-hidden="true">₽</span>
          </div>

          <div class="plus-wrap">
            <button id="addBtn" class="pill-plus" aria-haspopup="true" aria-expanded="false" aria-controls="quickMenu" title="Быстрое действие">
              <span class="plus-ico" aria-hidden="true">+</span>
            </button>

            <div id="quickMenu" class="quickmenu" role="menu" aria-hidden="true">
              <button class="qm-item" role="menuitem" data-action="daily">🎁 Ежедневный бонус</button>
              <button class="qm-item" role="menuitem" data-action="topup">💳 Пополнить баланс</button>
              <button class="qm-item" role="menuitem" data-action="settings">⚙️ Настройки</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="chipbar" id="chipbar"><div class="chip active" data-target="#top">Все</div></div>
    <div class="content" id="content"></div>

<!-- ПУСТОЙ ЭКРАН ПРОФИЛЯ -->
<div class="hide" id="profileScreen" aria-hidden="true"></div>
<!-- ПУСТОЙ ЭКРАН ДРУЗЕЙ -->
<div class="hide" id="friendsScreen" aria-hidden="true"></div>

<!-- ПУСТОЙ ЭКРАН КОНКУРСОВ -->
<div class="hide" id="contestsScreen" aria-hidden="true"></div>

<!-- ПУСТОЙ ЭКРАН ОБМЕНОВ -->
<div class="hide" id="upgradesScreen" aria-hidden="true"></div>

<!-- ЭКРАН НАСТРОЕК -->
<div class="hide settings-screen" id="settingsScreen" aria-hidden="true">
  <div class="settings-header">
    <button type="button" class="settings-back" id="settingsBack">← Назад</button>
    <div class="settings-title">НАСТРОЙКИ</div>
  </div>

  <div class="settings-list">
    <div class="settings-row">
      <div class="settings-label">Вибрация</div>
      <label class="switch">
        <input type="checkbox" id="toggleVibration" checked>
        <span class="slider"></span>
      </label>
    </div>

    <div class="settings-row">
      <div class="settings-label">Сохранение кошелька</div>
      <label class="switch">
        <input type="checkbox" id="toggleWalletSave" checked>
        <span class="slider"></span>
      </label>
    </div>

    <div class="settings-row">
      <div class="settings-label">Автоматическая продажа</div>
      <label class="switch">
        <input type="checkbox" id="toggleAutoSell" checked>
        <span class="slider"></span>
      </label>
    </div>
  </div>
</div>

    <nav class="tabbar">
  <div class="tab">
    <div class="ico">
      <img src="assets/images/20251116_1410_Чашка на прозрачном фоне_remix_01ka65p4jmegq99mzejj6nkprr.png" alt="Конкурсы">
    </div>
    Конкурсы
  </div>

  <div class="tab">
    <div class="ico">
      <img src="assets/images/20251117_1747_Иконка с прозрачным фоном_remix_01ka94fh16en3vq3kqfmhp6re2.png" alt="Пропуск">
    </div>
    Пропуск
  </div>

  <div class="tab active">
    <div class="ico">
      <img src="assets/images/20251116_1418_Прозрачный фон, ровный центр_remix_01ka6642srfterwmtfaw3xvgx9.png" alt="Кейсы">
    </div>
    Кейсы
  </div>

  <div class="tab">
    <div class="ico">
      <img src="assets/images/20251116_1344_Центральная иконка на прозрачном фоне_remix_01ka6472x6eeybwvx8cxa95kdh.png" alt="Друзья">
    </div>
    Друзья
  </div>

  <div class="tab" data-tab="inventory">
    <div class="ico">
      <img src="assets/images/20251116_1414_Рюкзак на прозрачном фоне_remix_01ka65wfdyf5htgqqchxje2t43.png" alt="Инвентарь">
    </div>
    Инвентарь
  </div>
</nav>

  <!-- DETAIL VIEW -->
  <div id="detail" class="detail" aria-hidden="true">
    <div class="d-topbar">
      <button id="backBtn" class="btn-back">← Назад</button>
      <div class="d-title" id="detailTitle">Кейс</div>
      <div class="grow"></div>
    </div>
    <div class="d-body">
      <div class="d-hero">
        <div id="detailThumb" class="d-thumb">Заглушка</div>
        <div class="d-actions">
  <button class="btn-spin" id="spinStartBtn">КРУТИТЬ</button>
  <div class="pill"><span>Цена:</span><span class="num" id="detailPrice">—</span></div>
</div>

        <!-- Предупреждение только для сайта (браузера) -->
        <div class="d-auth-warning">
          <div class="auth-box">
            <div class="auth-title">Вы не авторизованы!</div>
            <div class="auth-sub">Для открытия кейсов необходимо пройти авторизацию</div>
          </div>
        </div>

</div> <!-- закрывает .d-hero -->
<div class="subhead">СОДЕРЖИМОЕ КЕЙСА</div>
<div id="lootGrid" class="loot-grid"></div>
<div style="height:40px"></div>
    </div> <!-- ←← закрыл .d-body -->
  </div>   <!-- ←← закрыл #detail -->

<!-- DROP MODAL -->
<div id="dropModal" class="modal" aria-hidden="true" aria-modal="true" role="dialog">
  <div class="modal-card" role="document">
    <div class="modal-title">ПРЕДМЕТ ПОЛУЧЕН</div>
    <div class="modal-image">
      <img id="dropImg" alt="Выпавший предмет">
    </div>
    <div class="modal-actions">
      <button id="keepBtn" class="btn keep">ОСТАВИТЬ</button>
      <button id="sellBtn" class="btn sell">ПРОДАТЬ</button>
    </div>
  </div>
</div>

<!-- CONFIRM SELL MODAL -->
<div id="confirmModal" class="modal" aria-hidden="true" aria-modal="true" role="dialog">
  <div class="modal-card" role="document">
    <div class="modal-title">ПОДТВЕРДИТЬ ПРОДАЖУ</div>
    <div id="confirmText" class="modal-text">
      Вы уверены, что хотите продать этот предмет?
    </div>
    <div class="modal-actions">
      <button id="confirmNo"  class="btn btn-no">НЕТ</button>
      <button id="confirmYes" class="btn btn-yes">ДА</button>
    </div>
  </div>
</div>

<!-- TOPUP MODAL - ДОБАВЛЯЕМ ЗДЕСЬ -->
<div id="topupModal" class="modal modal-topup" aria-hidden="true" aria-modal="true" role="dialog">
  <div class="topup-card" role="document">
    <button class="topup-close" aria-label="Закрыть">✖</button>
    <div class="topup-title">Выберите способ оплаты</div>

    <div class="topup-slider" id="topupSlider" aria-roledescription="carousel">
      <button class="nav prev" aria-label="Предыдущий">‹</button>

      <div class="viewport">
        <div class="track">
          <!-- 3 слайда-заглушки -->
<div class="slide"></div>
<div class="slide"></div>
<div class="slide"></div>
        </div>
      </div>

      <!-- TOPUP AMOUNT MODAL -->
<div id="topupAmountModal" class="modal" aria-hidden="true" aria-modal="true" role="dialog">
  <div class="modal-card" role="document" style="max-width: 400px;">
    <div class="modal-title">ПОПОЛНЕНИЕ БАЛАНСА</div>
    
    <!-- Контейнер для сообщений об ошибке -->
    <div id="amountError" class="error-message"></div>
    
        <!-- TON WALLET LINE (показывается только если кошелек привязан) -->
    <div id="tonWalletLine" class="wallet-line" style="display:none;">
      <span id="tonWalletShort" class="wallet-line-text">UQB4...k8qK</span>
      <button type="button" id="tonWalletUnlink" class="wallet-line-close" aria-label="Отвязать кошелек">✕</button>
    </div>

    <div class="amount-input-wrapper">
      <input type="text" 
             id="amountInput" 
             class="amount-input" 
             placeholder="Сумма пополнения"
             maxlength="10"
             autocomplete="off">
    </div>

    <div class="amount-meta" id="tonMeta" style="display:none;">
  <div class="amount-meta-left" id="tonReceiveText">
    Вы получите 2000 Stars
  </div>
</div>

    <div class="modal-actions">
      <button id="cancelAmountBtn" class="btn btn-ghost">ОТМЕНА</button>
      <button id="confirmAmountBtn" class="btn btn-primary">ПОПОЛНИТЬ</button>
    </div>
  </div>
</div>

<!-- ✅ Cardlink / SBP оплата -->
<div id="bankPayModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="document" style="max-width: 520px; width: 100%;">
    <div class="modal-title">ОПЛАТА ЧЕРЕЗ СБП</div>

    <div class="bankpay-frame-wrap" style="width:100%; height:70vh; min-height:420px;">
      <iframe id="bankPayFrame"
              src=""
              style="border:0; width:100%; height:100%; border-radius:12px;"
              allow="payment *; clipboard-read; clipboard-write"></iframe>
    </div>

    <div class="modal-actions">
      <button id="bankPayCloseBtn" class="btn btn-ghost">ЗАКРЫТЬ</button>
    </div>
  </div>
</div>

      <button class="nav next" aria-label="Следующий">›</button>
    </div>

    <div class="topup-dots" id="topupDots" role="tablist" aria-label="Варианты оплаты">
  <button class="dot" role="tab" aria-selected="true"></button>
  <button class="dot" role="tab" aria-selected="false"></button>
  <button class="dot" role="tab" aria-selected="false"></button>
</div>

    <button class="btn topup-confirm" id="topupConfirm">ПОДТВЕРДИТЬ</button>
  </div>
</div>

<button id="backTop" class="backtop" aria-label="Вверх">ВВЕРХ ↑</button>

<!-- Модалка вывода предметов -->
<div id="withdrawModal" class="modal withdraw-modal" aria-hidden="true" aria-modal="true" role="dialog">
  <div class="modal-card" role="document">
    <div class="modal-title">ВЫВОД ПРЕДМЕТОВ</div>
    
    <div class="withdraw-steps">
      <ol>
        <li>Выберите подарок, который хотите вывести.</li>
        <li>
          Напишите нашему модератору 
          <span id="moderatorUsername" class="moderator-link">(@Username)</span>, 
          чтобы запросить вывод подарка. Обязательно укажите в сообщении свой ID профиля и номер подарка.
        </li>
        <li>
          Далее, пожалуйста, следуйте инструкциям модератора — он подскажет все дальнейшие шаги, 
          чтобы вы гарантированно получили свой подарок.
        </li>
        <li>Получите свой подарок на аккаунт!</li>
        <li>После получения подарка начинайте охоту на новые призы!🎁</li>
      </ol>
    </div>

    <button id="withdrawCloseBtn" class="btn withdraw-close-btn">ЗАКРЫТЬ</button>
  </div>
</div>

<!-- Глобальный лоадер для пополнения -->
<div id="loaderOverlay" class="loader-overlay" aria-hidden="true">
  <div class="loader-ring" role="status" aria-label="Загрузка…"></div>
</div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
  window.GD = window.GD || {};
  window.API_BASE = 'https://sneerful-anamaria-doucely.ngrok-free.dev';
  GD.API_BASE = window.API_BASE;
</script>


<script>
// === App namespace (общие утилиты во всём приложении) ===

// точный ник бота БЕЗ @
GD.BOT_USERNAME = 'Glitchdrop_bot';

// ПРЯМАЯ ссылка на мини-апп из BotFather
// СКОПИРУЙ её из BotFather дословно!
const TELEGRAM_MINIAPP_URL = 'http://t.me/Glitchdrop_bot/GlitchDrop';

// хеш + формат под 8 цифр (используется в фолбэках)
GD._fnv1a = function(str){
  let h = 0x811c9dc5;
  for (let i = 0; i < str.length; i++){ h ^= str.charCodeAt(i); h = (h >>> 0) * 0x01000193; }
  return h >>> 0;
};

// читаем uid8 из localStorage (его кладёт getOrFetchUid8 ниже)
GD.getUid8 = function(){
  try{
    const v = localStorage.getItem('gd_uid8');
    return (v && /^\d{8}$/.test(v)) ? v : '00000000';
  }catch(_){ return '00000000'; }
};

// строим ссылку-приглашение
GD.buildInviteLink = function(){
  const uid = GD.getUid8();
  return `https://t.me/${GD.BOT_USERNAME}?startapp=ref_${uid}`;
};

GD._uid8Promise = null;

// БЕЗОПАСНАЯ ЭКРАНИЗАЦИЯ ТЕКСТА ДЛЯ ВСТАВКИ В innerHTML
window.esc = function(s){
  return String(s)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;')
    .replaceAll('/','&#47;');
};

async function fetchInvited(){
  const tg = window.Telegram?.WebApp;
  const u  = tg?.initDataUnsafe?.user;

  // берем uid8 либо из Telegram, либо из localStorage
  let uid8 = null;

  if (u?.id){
    uid8 = window.MY_UID8 || await GD.ensureUid8(String(u.id));
    window.MY_UID8 = uid8;
  } else {
    uid8 = GD.getUid8(); // из localStorage gd_uid8
  }

  if(!uid8 || uid8 === '00000000') return [];

  try{
    const r = await fetch(`${window.API_BASE}/api/referrals?uid8=${uid8}`, { method:'GET' });
    if(!r.ok) return [];
    const data = await r.json();
    return Array.isArray(data.items) ? data.items : [];
  }catch(_){ return []; }
}


window.safeOpen = function(url){
  const tg = window.Telegram?.WebApp;

  // Внутри Telegram Mini App
  if (tg?.openTelegramLink){ tg.openTelegramLink(url); return; }
  if (tg?.openLink){ tg.openLink(url, { tryBrowser:true }); return; }

  // Вне Telegram
  const w = window.open(url, '_blank', 'noopener,noreferrer');
  if (!w || w.closed) window.location.href = url;
};

// ===== КНОПКА "ВОЙТИ ЧЕРЕЗ TELEGRAM" НА САЙТЕ =====
(function(){

  // Определяем, внутри ли мы Telegram WebApp
  const tg = window.Telegram && window.Telegram.WebApp;

  if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user){
    // Внутри мини-аппа: вешаем класс на <html>, чтобы скрыть кнопку
    document.documentElement.classList.add('in-telegram');
  } else {
    // В обычном браузере (САЙТ): ставим класс on-site
    document.documentElement.classList.add('on-site');
  }

  const btn = document.getElementById('openMiniAppBtn');
  if (!btn) return;

  // URL для открытия мини-аппа бота из браузера
  const miniAppUrl = `https://t.me/${GD.BOT_USERNAME}/app`;
  // либо вариант со startapp:
  // const miniAppUrl = `https://t.me/${GD.BOT_USERNAME}?startapp=from_site`;

  btn.addEventListener('click', function(){
    if (typeof window.safeOpen === 'function'){
      window.safeOpen(miniAppUrl);
    } else {
      window.open(miniAppUrl, '_blank');
    }
  });
})();

</script>


<script>
// ====== ДАННЫЕ ======
const LOOT_SETS = { /* <-- твои массивы, оставляю как есть */ 
  cheap_1:[ "assets/images/20251003_1635_Прозрачный фон_remix_01k6n4frmwe74ry17r7gszk6ef.png",
    "assets/images/20251003_1629_Прозрачный фон_remix_01k6n43z74eq3ve8a9rcx44f02.png",
    "assets/images/20251003_1627_Прозрачный Фон_remix_01k6n416bkeassbn7rx8a17bdt.png",
    "assets/images/20251012_1000_Прозрачный фон_remix_01k7bkfcsqe3mts7q04f9z6xgq.png",
    "assets/images/20251003_1624_Прозрачный фон_remix_01k6n3v1nbffkrc39mm720d2gm.png",
    "assets/images/20251008_1905_Прозрачный фон_remix_01k72913cgfyy90e2abb8t2dft.png",
    "assets/images/20251003_1632_Прозрачный фон_remix_01k6n49ebnfssrvwq0605g9bkx.png",
    "assets/images/20251003_1621_Прозрачный фон_remix_01k6n3p2hwf4fbk1r0rqbvdc5d.png",
    "assets/images/20251003_1620_Прозрачный фон_remix_01k6n3k7yrey7864fgc944j33p.png",
    "assets/images/20251003_1618_Прозрачный фон_remix_01k6n3fv8bej7813hnthjyags5.png",
    "assets/images/20251003_1616_Сердце с бантом_remix_01k6n3czjze6paj61x9g5r7ab3.png"
  ],
  cheap_2:["assets/images/снупп дог.png","assets/images/20251003_1635_Прозрачный фон_remix_01k6n4frmwe74ry17r7gszk6ef.png","assets/images/20251003_1627_Прозрачный Фон_remix_01k6n416bkeassbn7rx8a17bdt.png","assets/images/20251003_1629_Прозрачный фон_remix_01k6n43z74eq3ve8a9rcx44f02.png","assets/images/20251012_1000_Прозрачный фон_remix_01k7bkfcsqe3mts7q04f9z6xgq.png","assets/images/20251003_1632_Прозрачный фон_remix_01k6n49ebnfssrvwq0605g9bkx.png","assets/images/20251003_1624_Прозрачный фон_remix_01k6n3v1nbffkrc39mm720d2gm.png","assets/images/20251008_1905_Прозрачный фон_remix_01k72913cgfyy90e2abb8t2dft.png","assets/images/20251003_1620_Прозрачный фон_remix_01k6n3k7yrey7864fgc944j33p.png","assets/images/20251003_1616_Сердце с бантом_remix_01k6n3czjze6paj61x9g5r7ab3.png","assets/images/20251003_1618_Прозрачный фон_remix_01k6n3fv8bej7813hnthjyags5.png"],
  cheap_3:["assets/images/kniga.png","assets/images/klever.png","assets/images/20251003_1635_Прозрачный фон_remix_01k6n4frmwe74ry17r7gszk6ef.png","assets/images/20251003_1627_Прозрачный Фон_remix_01k6n416bkeassbn7rx8a17bdt.png","assets/images/20251003_1629_Прозрачный фон_remix_01k6n43z74eq3ve8a9rcx44f02.png","assets/images/20251003_1624_Прозрачный фон_remix_01k6n3v1nbffkrc39mm720d2gm.png","assets/images/20251008_1905_Прозрачный фон_remix_01k72913cgfyy90e2abb8t2dft.png","assets/images/20251003_1621_Прозрачный фон_remix_01k6n3p2hwf4fbk1r0rqbvdc5d.png","assets/images/20251003_1620_Прозрачный фон_remix_01k6n3k7yrey7864fgc944j33p.png","assets/images/20251003_1618_Прозрачный фон_remix_01k6n3fv8bej7813hnthjyags5.png","assets/images/20251003_1616_Сердце с бантом_remix_01k6n3czjze6paj61x9g5r7ab3.png"],
  cheap_4:["","","","","","","","","","",""],
  nft_1:["","","","","","","","","","",""],
  nft_2:["","","","","","","","","","",""],
  nft_3:["","","","","","","","","","",""],
  nft_4:["","","","","","","","","","",""],
  exclusive_1:["","","","","","","","","","",""],
  exclusive_2:["","","","","","","","","","",""],
  exclusive_3:["","","","","","","","","","",""],
  exclusive_4:["","","","","","","","","","",""],
  standard_1:["","","","","","","","","","",""],
  standard_2:["","","","","","","","","","",""],
  standard_3:["","","","","","","","","","",""],
  standard_4:["","","","","","","","","","",""],
  gold_1:["","","","","","","","","","",""],
  gold_2:["","","","","","","","","","",""],
  gold_3:["","","","","","","","","","",""],
  gold_4:["","","","","","","","","","",""],
  allornothing_1:["","","","","","","","","","",""],
  allornothing_2:["","","","","","","","","","",""],
  allornothing_3:["","","","","","","","","","",""],
  allornothing_4:["","","","","","","","","","",""],
  expensive_1:["","","","","","","","","","",""],
  expensive_2:["","","","","","","","","","",""],
  expensive_3:["","","","","","","","","","",""],
  expensive_4:["","","","","","","","","","",""],
};

const CHEAP_BACK_TEXT = {
  cheap_1: Array(11).fill({stars:"174000/", ton:"870"}),
  cheap_2: Array(11).fill({stars:"174000/", ton:"870"}),
  cheap_3: Array(11).fill({stars:"174000/", ton:"870"}),
  cheap_4: Array(11).fill({stars:"174000/", ton:"870"}),
};

const CASE_THUMBS = {
  free:["assets/images/ПРОМОКОД.png","assets/images/за 500₽.png","assets/images/за 2000₽.png","assets/images/ChatGPT Image 6 янв. 2026 г., 15_43_15.png"],
  cheap:["assets/images/20251010_1652_Золотой Кубок_remix_01k7767y0he76bx0bzxsakmpd4.png","assets/images/20251226_1817_Грани механической шестерни_remix_01kddkqfbtfq0a36md3kbfpdwx.png","",""],
  nft:["assets/images/ChatGPT Image 5 окт. 2025 г., 10_33_06.png","assets/images/ChatGPT Image 5 окт. 2025 г., 11_26_19.png","assets/images/NFT 3.png","assets/images/20251005_1527_Зелёная призрачная тыква_remix_01k6t5bwrrfxet6r4vzrkgra3k.png"],
  exclusive:["assets/images/20251005_1639_Новогодняя змея_remix_01k6t9fz7mevwt1beaq5bxehc4.png","assets/images/20251005_1703_Фен с розовой лентой_remix_01k6tavjk3fq8brq0e5fr8hycw.png","assets/images/20251005_1718_Стильный школьный рюкзак_simple_compose_01k6tbpyfyedkb0r4qcr8r6p8m.png","assets/images/20251005_1752_Радужные Губы и Пузыри_remix_01k6tdn1ebem893yskvv82bpgz.png"],
  standard:["","","",""],
  gold:["","","",""],
  allornothing:["","","",""],
  expensive:["","","",""],
};

// ===== Прелоад картинок кейсов и лута =====
(function preloadCaseImages(){
  try {
    const urls = [];

    // обложки кейсов
    if (typeof CASE_THUMBS === 'object' && CASE_THUMBS) {
      for (const key in CASE_THUMBS) {
        const arr = CASE_THUMBS[key];
        if (Array.isArray(arr)) {
          arr.forEach(u => { if (u) urls.push(u); });
        }
      }
    }

    // картинки приза для барабана/лута
    if (typeof LOOT_SETS === 'object' && LOOT_SETS) {
      for (const key in LOOT_SETS) {
        const arr = LOOT_SETS[key];
        if (Array.isArray(arr)) {
          arr.forEach(u => { if (u) urls.push(u); });
        }
      }
    }

    // если используешь SPIN_IMAGES, тоже можно прогреть
    if (typeof SPIN_IMAGES === 'object' && SPIN_IMAGES) {
      for (const key in SPIN_IMAGES) {
        const arr = SPIN_IMAGES[key];
        if (Array.isArray(arr)) {
          arr.forEach(u => { if (u) urls.push(u); });
        }
      }
    }

    // убираем дубли, чтобы не спамить одинаковые запросы
    const unique = Array.from(new Set(urls));

    unique.forEach(src => {
      const img = new Image();
      img.src = src; // браузер сам закэширует
    });
  } catch (e) {
    console.warn('preloadCaseImages error', e);
  }
})();

const sections = [
  { id:'free',        title:'БЕСПЛАТНЫЕ КЕЙСЫ',  items:4, price:'БЕСПЛАТНО',},
  { id:'cheap',       title:'ДЕШЁВЫЕ КЕЙСЫ',     items:4, price:['50 ⭐','250 ⭐','500 ⭐','1500 ⭐'] },
  { id:'nft',         title:'ТОЛЬКО NFT-КЕЙСЫ',  items:4, price:['25 ⭐','30 ⭐','35 ⭐','40 ⭐'] },
  { id:'exclusive',   title:'ЭКСКЛЮЗИВНЫЕ КЕЙСЫ',items:4, price:['2000 ⭐','3500 ⭐','5800 ⭐','8500 ⭐'] },
  { id:'standard',    title:'СТАНДАРТНЫЕ КЕЙСЫ', items:4, price:['20 ⭐','25 ⭐','28 ⭐','35 ⭐'] },
  { id:'gold',        title:'КЕЙСЫ ЗА ЗОЛОТО',   items:4, price:['ЗОЛОТО','ЗОЛОТО','ЗОЛОТО','ЗОЛОТО'] },
  { id:'allornothing',title:'ВСЁ ИЛИ НИЧЕГО КЕЙСЫ',items:4,price:['50 ⭐','75 ⭐','100 ⭐','150 ⭐'] },
  { id:'expensive',   title:'ДОРОГИЕ КЕЙСЫ',     items:4, price:['200 ⭐','250 ⭐','300 ⭐','400 ⭐'] },
];

const FALLBACK_IMG = "https://via.placeholder.com/512?text=%F0%9F%8E%81";

/* ===== КОНКУРСЫ — данные, которые ты редактируешь =====
   img: URL 1:1 картинки (любая пропорция, впишется в квадрат)
   username: строка вида "@ChannelName"
   link: (опционально) прямая ссылка; если пусто — сделаю https://t.me/<username без @>
*/
const CONTESTS_DATA = [
  { img: "assets/images/contest1.png", username: "@podarkisliv", link: "" },
  { img: "assets/images/contest2.png", username: "@Username2", link: "" },
  { img: "assets/images/contest3.png", username: "@Username3", link: "" },
  { img: "assets/images/contest4.png", username: "@Username4", link: "" },
];


// ====== DOM-ссылки ======
const chipbar  = document.getElementById('chipbar');
const content  = document.getElementById('content');
const detail   = document.getElementById('detail');
const backBtn  = document.getElementById('backBtn');
const dTitle   = document.getElementById('detailTitle');
const dPrice   = document.getElementById('detailPrice');
const dThumb   = document.getElementById('detailThumb');
const lootGrid = document.getElementById('lootGrid');

/* текущая выбранная платная карточка */
let selectedCaseCard = null;
function clearSelectedCase(){
  if (selectedCaseCard){
    selectedCaseCard.classList.remove('case-selected');
    selectedCaseCard = null;
  }
}

/* ===== 3D Tilt для карточек (поворот от пальца) ===== */
function initCardTilt(card){
  if (!card || card.__tiltBound) return;
  card.__tiltBound = true;

  const MAX_DEG = 7;       // сила наклона (крути 6..12)
  const SMOOTH = 0.14;     // плавность (меньше = плавнее, 0.12..0.22)

  let down = false;
  let rect = null;

  let curRx = 0, curRy = 0;
  let tgtRx = 0, tgtRy = 0;

  let raf = 0;

  const clamp = (v, a, b) => (v < a ? a : (v > b ? b : v));

  function tick(){
    raf = 0;

    curRx += (tgtRx - curRx) * SMOOTH;
    curRy += (tgtRy - curRy) * SMOOTH;

    card.style.setProperty('--rx', curRx.toFixed(3) + 'deg');
    card.style.setProperty('--ry', curRy.toFixed(3) + 'deg');

    if (Math.abs(tgtRx - curRx) > 0.01 || Math.abs(tgtRy - curRy) > 0.01){
      raf = requestAnimationFrame(tick);
    }
  }

  function setFromXY(x, y){
    rect = rect || card.getBoundingClientRect();

    let nx = (x - rect.left) / rect.width;
    let ny = (y - rect.top) / rect.height;

    nx = clamp(nx, 0, 1);
    ny = clamp(ny, 0, 1);

    tgtRy = clamp((nx - 0.5) * (MAX_DEG * 2), -MAX_DEG, MAX_DEG);
    tgtRx = clamp(-(ny - 0.5) * (MAX_DEG * 2), -MAX_DEG, MAX_DEG);

    if (!raf) raf = requestAnimationFrame(tick);
  }

  function reset(){
    rect = null;
    tgtRx = 0;
    tgtRy = 0;
    if (!raf) raf = requestAnimationFrame(tick);
  }

  function onDown(e){
    // если жмут по кнопке "ОТКРЫТЬ" — не крутим карточку (чтобы клик был чистый)
    if (e.target && e.target.closest && e.target.closest('.card-open-btn')) return;

    down = true;
    rect = card.getBoundingClientRect();
    card.classList.add('tilting');

    if (e.pointerId != null && card.setPointerCapture){
      try{ card.setPointerCapture(e.pointerId); }catch(_){}
    }

    setFromXY(e.clientX, e.clientY);
  }

  function onMove(e){
    if (!down) return;
    setFromXY(e.clientX, e.clientY);
  }

  function onUp(){
    if (!down) return;
    down = false;
    card.classList.remove('tilting');
    reset();
  }

  if (window.PointerEvent){
    card.addEventListener('pointerdown', onDown, { passive:true });
    card.addEventListener('pointermove', onMove, { passive:true });
    card.addEventListener('pointerup', onUp, { passive:true });
    card.addEventListener('pointercancel', onUp, { passive:true });
  } else {
    // запасной вариант для очень старых webview
    card.addEventListener('touchstart', (ev)=>{
      const t = ev.touches && ev.touches[0];
      if (!t) return;
      down = true;
      rect = card.getBoundingClientRect();
      card.classList.add('tilting');
      setFromXY(t.clientX, t.clientY);
    }, { passive:true });

    card.addEventListener('touchmove', (ev)=>{
      if (!down) return;
      const t = ev.touches && ev.touches[0];
      if (!t) return;
      setFromXY(t.clientX, t.clientY);
    }, { passive:true });

    card.addEventListener('touchend', onUp, { passive:true });
    card.addEventListener('touchcancel', onUp, { passive:true });
  }
}

// ====== Рендер карточек ======
sections.forEach(sec=>{
  // чип
  const chip = document.createElement('div');
  chip.className = 'chip';
  chip.dataset.target = `#sec-${sec.id}`;
  chip.textContent = sec.title.replace(' КЕЙСЫ','');
  chipbar.appendChild(chip);

  // заголовок секции
  const h2 = document.createElement('h2');
  h2.className = 'section';
  h2.id = `sec-${sec.id}`;
  h2.textContent = sec.title;
  content.appendChild(h2);

  // грид
  const grid = document.createElement('div');
  grid.className = 'grid';

  for(let i=0;i<sec.items;i++){
    const thumbUrl  = (CASE_THUMBS[sec.id] && CASE_THUMBS[sec.id][i]) || "";
    const thumbHTML = thumbUrl
      ? `<img src="${thumbUrl}" alt="Обложка кейса #${i+1}" onerror="this.src='${FALLBACK_IMG}'">`
      : `Заглушка`;

    const isFree   = (sec.id === 'free');
    const rawPrice = Array.isArray(sec.price)? sec.price[i] : sec.price;

    // убираем вторую звезду в конце ("50 ⭐" -> "50")
    const cleanPrice = String(rawPrice || '').replace(/\s*[⭐₽]\s*$/,'').trim();

    const card = document.createElement('div');
    card.className='card';

    const setId = `${sec.id}_${i+1}`;

    card.innerHTML = `
      <div class="inner">
        <div class="thumb">
          ${thumbHTML}
        </div>
      </div>

      <div class="card-footer">
        <div class="price-pill">
          <span class="price-pill-text">${isFree ? (rawPrice || 'Бесплатно') : cleanPrice}</span>
          ${isFree ? '' : '<span class="price-pill-cur">₽</span>'}
        </div>
      </div>

      <button type="button" class="card-open-btn">ОТКРЫТЬ</button>
    `;

        const openBtn = card.querySelector('.card-open-btn');

    // Выбор карточки — по normal click (не срабатывает при скролле)
    card.addEventListener('click', (evt)=>{
      // если жмём по самой кнопке "ОТКРЫТЬ" — не переключаем выбор
      if (evt.target.closest('.card-open-btn')) return;

      // повторный тап по уже выбранной — "отбухает"
      if (selectedCaseCard === card){
        clearSelectedCase();
        return;
      }

      // снимаем выбор с предыдущей
      if (selectedCaseCard && selectedCaseCard !== card){
        selectedCaseCard.classList.remove('case-selected');
      }

      selectedCaseCard = card;
      card.classList.add('case-selected');
    });

    // Нажатие на кнопку "ОТКРЫТЬ" — перейти к барабану (и для бесплатных тоже)
    if (openBtn){
      openBtn.addEventListener('click', (ev)=>{
        ev.stopPropagation();

        openDetail({
          title: `${sec.title} — Кейс #${i+1}`,
          price: rawPrice,
          setId
        });
      });
    }

    initCardTilt(card);
    grid.appendChild(card);

  }

  content.appendChild(grid);
});

// ====== Клик мимо карточки — снимаем выбор ======
document.addEventListener('click', (evt)=>{
  if (!selectedCaseCard) return;

  // если кликнули по любой карточке (или по кнопке внутри неё) — не трогаем
  if (evt.target.closest('.card')) return;

  clearSelectedCase();
});

// ====== Чипы (ФИЛЬТР секций: заголовок + grid) ======
const chips = Array.from(chipbar.querySelectorAll('.chip'));

// Собираем пары секций: heading (h2#sec-...) + grid (следующий div.grid)
const sectionPairs = sections.map((s, i) => {
  const heading = document.getElementById(`sec-${s.id}`);
  const grid = heading ? heading.nextElementSibling : null;

  return {
    id: s.id,
    heading,
    grid,
    index: i
  };
}).filter(p =>
  p.heading &&
  p.grid &&
  p.grid.classList.contains('grid')
);

const sectionsContainer = sectionPairs[0]?.heading?.parentElement;

// текущий активный фильтр (по умолчанию "Все")
let activeFilterSel = "#top";

// Показать ВСЕ секции в исходном порядке (heading + grid)
function showAllSections(){
  if (!sectionsContainer) return;

  sectionPairs
    .sort((a,b)=> a.index - b.index)
    .forEach(p=>{
      p.heading.style.display = "";
      p.grid.style.display = "";

      // возвращаем порядок: заголовок -> grid
      sectionsContainer.appendChild(p.heading);
      sectionsContainer.appendChild(p.grid);
    });
}

// Показать ТОЛЬКО одну секцию (и поднять её вверх)
function showOnlySection(sel){
  if (!sectionsContainer) return;

  // sel вида "#sec-cheap" => id "cheap"
  const targetId = sel.replace('#sec-','');
  const target = sectionPairs.find(p => p.id === targetId);
  if (!target) return;

  // прячем все пары кроме нужной
  sectionPairs.forEach(p=>{
    const isTarget = (p === target);
    p.heading.style.display = isTarget ? "" : "none";
    p.grid.style.display = isTarget ? "" : "none";
  });

  // поднимаем нужную секцию в самый верх:
  // сначала heading, сразу за ним grid
  sectionsContainer.insertBefore(target.heading, sectionsContainer.firstChild);
  sectionsContainer.insertBefore(target.grid, target.heading.nextSibling);
}

// скроллим к верху, потом применяем фильтр
function scrollToTopThen(cb){
  if (window.scrollY < 5){
    cb();
    return;
  }

  window.scrollTo({ top: 0, behavior: "smooth" });

  const start = Date.now();
  const onScroll = ()=>{
    if (window.scrollY < 5 || (Date.now() - start) > 700){
      window.removeEventListener("scroll", onScroll);
      cb();
    }
  };
  window.addEventListener("scroll", onScroll, { passive:true });
}

// клик по чипу = выбрать фильтр
chipbar.addEventListener("click", e=>{
  const chip = e.target.closest(".chip");
  if (!chip) return;

  setActiveChip(chip);

  const sel = chip.dataset.target || "#top";
  activeFilterSel = sel;

  if (sel === "#top"){
    // "Все"
    scrollToTopThen(showAllSections);
  } else {
    // конкретная секция
    scrollToTopThen(()=> showOnlySection(sel));
  }
});

// активный чип подсвечен, пока не выберут другой
function setActiveChip(ch){
  chips.forEach(c=> c.classList.remove("active"));
  ch.classList.add("active");
}

// при старте — включаем "Все"
const topChip = chips.find(c => (c.dataset.target || "#top") === "#top");
if (topChip) setActiveChip(topChip);
showAllSections();

// ====== Кнопка «вверх» ======
const backTop = document.getElementById('backTop');
const toggleBackTop = ()=> backTop.classList.toggle('show', window.scrollY>2);
window.addEventListener('scroll', toggleBackTop, {passive:true});
backTop.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
toggleBackTop();

// ====== Рендер лута (флип-карточки) ======
function renderLoot(images, setId){
  lootGrid.innerHTML = "";
  const list = (images && images.length) ? images.slice(0,11) : Array.from({length:11}, ()=>null);
  const isCheap = typeof setId === 'string' && setId.startsWith('cheap');
  const table = isCheap ? (CHEAP_BACK_TEXT[setId] || []) : [];

  const DEF_STARS = "174000/";
  const DEF_TON   = "870";

  list.forEach((src, idx)=>{
    const wrap = document.createElement('div');
    wrap.className = 'loot';
    wrap.setAttribute('aria-label', `Предмет ${idx+1}`);
    wrap.setAttribute('role','button');
    wrap.tabIndex = 0;

    const inner = document.createElement('div');
    inner.className = 'loot-inner';

    const front = document.createElement('div');
    front.className = 'loot-face loot-front';
    if (src){
      const img = document.createElement('img');
      img.src = src;
      img.alt = `Предмет ${idx+1}`;
      img.loading = "lazy";
      img.onerror = () => img.src = FALLBACK_IMG;
      front.appendChild(img);
    } else {
      front.textContent = 'Заглушка';
    }

    const back = document.createElement('div');
    back.className = 'loot-face loot-back';

    if (isCheap){
      const row = table[idx] || {};
      const sRaw = (row.stars ?? "").trim() || DEF_STARS;
      const t    = (row.ton   ?? "").trim() || DEF_TON;

      const sClean = String(sRaw).replace(/\s*[⭐₽]\s*$/,'').trim();
      const sHasNum = /\d/.test(sClean);

      const sHtml = sHasNum
        ? `${sClean}<span class="lb-rub">₽</span>`
        : sClean;

      back.innerHTML = `
        <div class="lb-stats">
          <div class="lb-stars">${sHtml}</div>
          <div class="lb-ton">${t}</div>
        </div>`;
    } else {

      back.innerHTML = `
        <div class="lb-stats">
          <div class="lb-stars">—</div>
          <div class="lb-ton">—</div>
        </div>`;
    }

    inner.appendChild(front);
    inner.appendChild(back);
    wrap.appendChild(inner);

    // флип (одна открыта за раз)
    wrap.addEventListener('click', (e)=>{
      e.preventDefault();
      const isOpen = wrap.classList.contains('flipped');
      lootGrid.querySelectorAll('.loot.flipped').forEach(l=>l.classList.remove('flipped'));
      if (!isOpen) wrap.classList.add('flipped');
    }, {passive:false});

    wrap.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' || e.key===' '){
        e.preventDefault();
        wrap.click();
      }
    });

    lootGrid.appendChild(wrap);
  });
}

// ===== DROP MODAL LOGIC =====
const dropModal = document.getElementById('dropModal');
const dropImg   = document.getElementById('dropImg');
const keepBtn   = document.getElementById('keepBtn');
const sellBtn   = document.getElementById('sellBtn');

let _lastFocus = null;
let _modalOpen = false;

function openDropModal(imgSrc){
  if (!dropModal) return;
  _lastFocus = document.activeElement;

  // картинка
  dropImg.src = imgSrc || FALLBACK_IMG;
window._lastDropImgSrc = dropImg.src;   // ИНВЕНТАРЬ: запомнили картинку дропа

  dropImg.onerror = () => { dropImg.src = FALLBACK_IMG; };

  // показать модалку
  dropModal.classList.add('show');
  dropModal.setAttribute('aria-hidden','false');
  _modalOpen = true;

  // запретить прокрутку и взаимодействие со скроллом фона
  lockBody(true);

  // захват фокуса
  setTimeout(()=> (keepBtn || dropModal).focus(), 0);

  // блокируем фон, Esc и держим фокус
  dropModal.addEventListener('click', blockBackdropClick, true);
  document.addEventListener('keydown', blockEsc, true);
  document.addEventListener('keydown', trapTab, true);
} // ← ЭТА скобка закрывает openDropModal

function closeDropModal(){
  if (!dropModal) return;
  dropModal.classList.remove('show');
  dropModal.setAttribute('aria-hidden','true');
  _modalOpen = false;

  // Разблокируем прокрутку только если экран detail закрыт
  if (!detail.classList.contains('show')) {
    lockBody(false); 
}

  dropModal.removeEventListener('click', blockBackdropClick, true);
  document.removeEventListener('keydown', blockEsc, true);
  document.removeEventListener('keydown', trapTab, true);

  if (_lastFocus && _lastFocus.focus) _lastFocus.focus();
}

function blockBackdropClick(e){
  const card = dropModal.querySelector('.modal-card');
  if (!card.contains(e.target)){
    e.stopPropagation();
    e.preventDefault();
  }
}
function blockEsc(e){
  if (e.key === 'Escape'){
    e.stopPropagation();
    e.preventDefault();
    // закрываем ТОЛЬКО по кнопкам
  }
}
function trapTab(e){
  if (e.key !== 'Tab' || !_modalOpen) return;
  const focusables = dropModal.querySelectorAll('button, [href], [tabindex]:not([tabindex="-1"])');
  const list = Array.from(focusables).filter(el=>!el.disabled && el.offsetParent !== null);
  if (!list.length) return;
  const first = list[0], last = list[list.length-1];
  if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
  else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
}

/* =========================================================
   ИНТЕРФЕЙС ВКЛАДКИ «ПРОФИЛЬ» — добавить предмет из модалки
   ========================================================= */
keepBtn?.addEventListener('click', () => {
  if (window._lastDropImgSrc) addToInventory(window._lastDropImgSrc);
  closeDropModal();
});

sellBtn?.addEventListener('click', () => {
  // TODO: продать предмет/начислить валюту
  closeDropModal();
});


function lockBody(locked){
  if (locked){
    const y = window.scrollY || 0;
    document.body.dataset.scrollY = String(y);
    document.documentElement.classList.add('scroll-locked');
  } else {
    const y = parseInt(document.body.dataset.scrollY || '0', 10);
    document.documentElement.classList.remove('scroll-locked');
    window.scrollTo(0, y);
  }
}


function openDetail({title, price, setId}) {
  // запоминаем текущий сет
  window.currentSetId = setId;

  // заголовки/цена
  dTitle.textContent = title;

  const priceStr   = String(price || '—');
  const cleanPrice = priceStr.replace(/\s*[⭐₽]\s*$/,'').trim();
  const hasNumber  = /\d/.test(cleanPrice);

  // если это числовая цена — рисуем "число + ₽" (₽ справа)
  // если это "БЕСПЛАТНО/ЗОЛОТО/—" — оставляем как есть
  dPrice.innerHTML = hasNumber
    ? `${cleanPrice}<span class="detail-rub">₽</span>`
    : cleanPrice;

  // чистая заглушка сверху
  dThumb.textContent = 'Заглушка';

  // лут снизу
  const images = LOOT_SETS[setId] || null;
  renderLoot(images, setId);

const key = `${setId}__0`;
const st  = ensureSpinState(key);
st.currentAngle = 0; // каждый заход начинаем с нулевого угла
// размеры фиксированные; если где-то менялись — вернём их
setReelSize({ sliceW: 210, sliceH: 128, minH: 360 });


  // НАРИСОВАТЬ ПРЕВЬЮ ЛЕНТ сразу под выбранное количество
  renderPreview(setId);

  // подготовка кнопок
  const spinStartBtn = document.getElementById('spinStartBtn');
  
  if (spinStartBtn) spinStartBtn.disabled = false;
  window.IS_SPINNING = false;

  // запуск N спинов
  
  if (spinStartBtn) spinStartBtn.onclick  = () => beginSpin(setId);
  
 lockBody(true);
detail.classList.add('show');
detail.setAttribute('aria-hidden','false');
detail.scrollTop = 0;

  }

// ====== Telegram WebApp ======
(()=>{
  const tg = window.Telegram && window.Telegram.WebApp;
  const avatarImg = document.getElementById('userAvatar');
  const fallback  = document.getElementById('avatarFallback');
  const nameEl    = document.getElementById('userName');

  if(!tg) return;
  tg.ready(); tg.expand();

const u = tg.initDataUnsafe && tg.initDataUnsafe.user;
if (!u) return;


// ====== REF SYSTEM: HIT ON START (самореф разрешён) ======
(async function referralHitOnStart(){
  try {
    const refUid8 = (tg.initDataUnsafe?.start_param || "").trim();

    // получаем свой uid8 и сохраняем (важно!)
    const myUid8 = await GD.ensureUid8(String(u.id));
    window.MY_UID8 = myUid8;

    // если пришли по реф ссылке — регистрируем друга
    if (refUid8 && /^\d{8}$/.test(refUid8) && window.API_BASE) {
      await fetch(window.API_BASE + "/api/referrals/hit", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          ref_uid8: refUid8,
          user: {
            id: u.id,
            first_name: u.first_name,
            last_name: u.last_name,
            username: u.username,
            photo_url: u.photo_url
          },
          initData: tg.initData
        })
      }).catch(()=>{});
    }
  } catch(e){
    console.log("referralHitOnStart error:", e);
  }
})();

// максимум 8 символов у username (без @)
const USERNAME_MAX = 8;
let display;

if (u.username) {
  const raw = String(u.username);
  const short = raw.length > USERNAME_MAX
    ? raw.slice(0, USERNAME_MAX) + '...'
    : raw;
  display = '@' + short;
} else {
  const name = [u.first_name || '', u.last_name || '']
    .join(' ')
    .trim();
  display = name || 'GLITCH DROP';
}

nameEl.textContent = display;
nameEl.setAttribute('data-text', display.replaceAll(' ', '\u00A0'));

(async () => {
  try {
    const tg = window.Telegram && window.Telegram.WebApp;
    const u  = tg?.initDataUnsafe?.user;
    if (!u) return; // не в Telegram Mini App — ничего не делаем

    const uid8 = await GD.ensureUid8(u.id);

    if (uid8 && uid8 !== '00000000') {
      document.querySelectorAll('#userId').forEach(el => {
        el.textContent = `ID ${uid8}`;
      });
    }
  } catch (e) {
    console.warn('ensureUid8 failed', e);
  }
})();

// Если фронт и API на одном домене через прокси /api → оставь пустую строку.
// Если на другом домене — укажи полный адрес, например:
// const API_BASE = "https://sneerful-anamaria-doucely.ngrok-free.dev";


function fnv1a(str){
  let h = 0x811c9dc5;
  for (let i = 0; i < str.length; i++){
    h ^= str.charCodeAt(i);
    h = (h >>> 0) * 0x01000193;
  }
  return h >>> 0;
}
function to8(n){ return String(n % 100000000).padStart(8,'0'); }

// === ЕДИНЫЙ ИСТОЧНИК UID8 + КЭШ ПРОМИСА ===
let _uid8Promise = null;

/**
 * Возвращает UID8: сначала localStorage, затем бэкенд, иначе детерминированный фолбэк.
 * @param {string|number} tgUserId
 * @returns {Promise<string>} 8-значная строка
 */

// === РЕФЕРАЛКА: регистрация друга при первом запуске по ref_<uid8> ===
(async () => {
  const tg = window.Telegram && window.Telegram.WebApp;
  if (!tg || !tg.initDataUnsafe) return;

  const u = tg.initDataUnsafe.user;
  const startParam = tg.initDataUnsafe.start_param; // ждём формат ref_XXXXXXXX
  if (!startParam || !/^ref_\d{8}$/.test(startParam)) return;

  const refUid8 = startParam.slice(4);

  // имя «как в аккаунте» (НЕ username)
  const displayName = [u?.first_name||'', u?.last_name||''].join(' ').trim() || 'Без имени';

  try{
    const resp = await fetch(`${window.API_BASE}/api/referrals/hit`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        ref_uid8: refUid8,
        initData: tg.initData || '',  // ВАЖНО: строка initData для проверки подписи на бэке
        user: {
          id: String(u?.id||''),
          first_name: u?.first_name || '',
          last_name:  u?.last_name  || '',
          photo_url:  u?.photo_url  || ''
        }
      })
    });
    
  }catch(e){}
})();


  // 👇 ДОБАВЬ ЭТО, чтобы сразу подогнать размер ника
  if (typeof fitUserName === 'function') fitUserName();


  if (u.photo_url){
    avatarImg.src = u.photo_url;
    avatarImg.classList.remove('hidden');
    fallback.style.display = 'none';
  }

  // Обновляем высоту topbar после загрузки имени/аватара
  if (typeof syncTopbarOffset === 'function') syncTopbarOffset();
})();

// === Автоподгон ника отключён: всё делаем через обрезку + CSS ===
function fitUserName(){
  // Ничего не делаем — размер и блок ника управляются в CSS
}

// === Синхронизация высоты верхнего блока в CSS-переменную ===
function syncTopbarOffset(){
  const root = document.documentElement;

  // Если мы на САЙТЕ — берём высоту баннера с кнопкой
  if (root.classList.contains('on-site')){
    const landing = document.querySelector('.landing-login-wrap');
    const hLanding = landing?.offsetHeight || 64;
    root.style.setProperty('--topbar-h', hLanding + 'px');
    return;
  }

  // Внутри мини-аппа — как раньше, от высоты topbar
  const topbar = document.querySelector('.topbar');
  const hTopbar = topbar?.offsetHeight || 64;
  root.style.setProperty('--topbar-h', hTopbar + 'px');
}

// 1) Вызвать прямо сейчас
syncTopbarOffset();

// 2) Обновлять при ресайзе и перевороте экрана
window.addEventListener('resize', syncTopbarOffset, {passive:true});
window.addEventListener('orientationchange', syncTopbarOffset, {passive:true});

// 3) Когда шрифты дорисовались (если влияет на высоту)
if (document.fonts && document.fonts.ready) {
  document.fonts.ready.then(syncTopbarOffset);
}

function syncTabbarOffset(){
  const h = document.querySelector('.tabbar')?.offsetHeight || 84;
  document.documentElement.style.setProperty('--tabbar-h', h + 'px');
}
syncTabbarOffset();
window.addEventListener('resize', syncTabbarOffset, {passive:true});
window.addEventListener('orientationchange', syncTabbarOffset, {passive:true});
if (document.fonts && document.fonts.ready) {
  document.fonts.ready.then(syncTabbarOffset);
}


// --- Support для 3D барабана: состояние, веса, лейблы ---

// Пустой реестр картинок (если не используешь отдельные спрайты барабана)
window.SPIN_IMAGES = window.SPIN_IMAGES || {}; // { setId: [url,url,...] }

// Общий state по ключу (setId__index)
window.SPIN_STATE = window.SPIN_STATE || new Map();

// Проценты выпадения по наборам (11 значений на setId). Пока нули — равновероятно.
const SPIN_CONFIGS_PERCENT = {
 
cheap_1: [0, 0, 0, 0, 0, 0, 0.392, 0.294, 0.196, 0.098, 0.02], 
cheap_2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
cheap_3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
cheap_4: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  
nft_1: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],  
nft_2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],   
nft_3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],   
nft_4: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  
exclusive_1: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
exclusive_2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
exclusive_3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
exclusive_4: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  
standard_1: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],  
standard_2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],  
standard_3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],  
standard_4: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  
gold_1: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
gold_2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
gold_3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
gold_4: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  
allornothing_1: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
allornothing_2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
allornothing_3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
allornothing_4: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
 
expensive_1: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
expensive_2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
expensive_3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
expensive_4: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
};

// Необязательные подписи/значения
const SPIN_LABELS = {
  cheap_1: {
    labels: ["CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1","CHEAP#1"],
    values: ["10 ⭐","25 ⭐","50 ⭐","100 ⭐","3 ⭐","5 ⭐","8 ⭐","15 ⭐","20 ⭐","30 ⭐","60 ⭐"]
  }
};
const DEFAULT_LABELS = Array(11).fill("ПРИЗ");
const DEFAULT_VALUES = ["10 ⭐","25 ⭐","50 ⭐","100 ⭐","3 ⭐","5 ⭐","8 ⭐","15 ⭐","20 ⭐","30 ⭐","60 ⭐"];

function ensureSpinState(key){
  if(!SPIN_STATE.has(key)){
    const setId = key.split('__')[0];
    const raw = (SPIN_CONFIGS_PERCENT[setId]?.slice(0,11)) || Array(11).fill(0);
    const sum = raw.reduce((a,b)=>a+b,0) || 1;
    const weights = raw.map(w => Math.max(0,w)/sum);

    const L = (SPIN_LABELS[setId]?.labels || DEFAULT_LABELS).slice(0,11);
    const V = (SPIN_LABELS[setId]?.values || DEFAULT_VALUES).slice(0,11);
    while(L.length<11) L.push("ПРИЗ");
    while(V.length<11) V.push("—");

    SPIN_STATE.set(key, {
      currentAngle: 0,
      rafId: 0,
      weights, labels: L, values: V
    });
  }
  return SPIN_STATE.get(key);
}


// Выбор индекса по весам
function pickIndexByWeights(weights){
  let r = Math.random(), acc = 0;
  for(let i=0;i<weights.length;i++){ acc += weights[i]; if(r <= acc) return i; }
  return weights.length-1;
}

/* ===== 3D барабан для detailThumb ===== */

// Глобальный флажок «идёт прокрут»
if (typeof window.IS_SPINNING === 'undefined') window.IS_SPINNING = false;

// Параметры барабана
const DRUM_ITEM_COUNT = 11;          // число граней

/* Геометрия/размер */
function getReelMetrics(){
  const cs = getComputedStyle(document.documentElement);
  const w = parseFloat(cs.getPropertyValue('--reel-slice-w')) || 210;
  const h = parseFloat(cs.getPropertyValue('--reel-slice-h')) || 128;
  const gap = parseFloat(cs.getPropertyValue('--reel-gap')) || 0; // <-- расстояние между ячейками

  const step = 360 / DRUM_ITEM_COUNT;

  // радиус считаем по "виртуальной" высоте (h + gap), а сама грань остаётся высотой h
  const r = Math.round(((h + gap) / 2) / Math.tan(Math.PI / DRUM_ITEM_COUNT));

  return { w, h, step, r };
}

/* Публичные функции изменения размера */
function setReelSize({sliceW, sliceH, minH} = {}){
  const root = document.documentElement.style;
  if(sliceW) root.setProperty('--reel-slice-w', `${sliceW}px`);
  if(sliceH) root.setProperty('--reel-slice-h', `${sliceH}px`);
  if(minH)   root.setProperty('--reel-min-h',   `${minH}px`);
}

/* Состояние с углом */
function ensureSpinStateWithAngle(key){
  const st = ensureSpinState(key);
  if(typeof st.currentAngle !== 'number') st.currentAngle = 0;
  return st;
}

/* Рендер барабана в d-thumb */
function render3DReel(setId){
  const parent = document.getElementById('detailThumb');
  if(!parent) return;
  const key = `${setId}__0`;
  const st  = ensureSpinStateWithAngle(key);
  const { step, r } = getReelMetrics();

  parent.innerHTML = `
    <div class="drum-wrap">
      <div class="drum-stage">
        <div class="drum-tilt">
          <div class="drum" id="drum_${key}" style="transform:translateZ(${-r}px) rotateX(${st.currentAngle}deg)"></div>
        </div>
        <div class="drum-pointer"></div>
      </div>
    </div>
  `;

  const drum = document.getElementById(`drum_${key}`);
  drum.innerHTML = "";

  const imgs = (SPIN_IMAGES[setId]?.length ? SPIN_IMAGES[setId] : LOOT_SETS[setId] || []).slice(0, DRUM_ITEM_COUNT);
  while(imgs.length < DRUM_ITEM_COUNT) imgs.push("");

  for(let i=0;i<DRUM_ITEM_COUNT;i++){
    const deg = -i * step; // фронтально, вращаем вниз
    const url   = imgs[i] || "";
    const label = (SPIN_STATE.get(key)?.labels?.[i]) ?? "ПРИЗ";
    const value = (SPIN_STATE.get(key)?.values?.[i]) ?? "—";

    const el = document.createElement('div');
    el.className = 'slice';
    el.style.setProperty('--_deg', `${deg}deg`);
    el.style.setProperty('--_rz',  `${r}px`);
    el.style.transform = `rotateX(${deg}deg) translateZ(${r}px)`;
    
// стало:
el.innerHTML = `
  <div class="img">
    ${url ? `<img src="${url}" onerror="this.src='${FALLBACK_IMG}'" alt="">` : '—'}
  </div>
`;

    drum.appendChild(el);
  }
}

function start3DSpin(setId, onDone){
  const key  = `${setId}__0`;
  const drum = document.getElementById(`drum_${key}`);
  if (!drum){ onDone && onDone({ idx:-1, imgSrc: FALLBACK_IMG }); return; }


  const st = ensureSpinState(key);
  const { step, r } = getReelMetrics();

  drum.querySelectorAll('.slice').forEach(s=> s.classList.remove('win'));

  const idx = pickIndexByWeights(st.weights);
  const current  = Number.isFinite(st.currentAngle) ? st.currentAngle : 0;
  const curSteps = Math.round(current / step);
  const curMod   = ((curSteps % 11) + 11) % 11;

  const need = ((idx - curMod) + 11) % 11;
  const EXTRA_TURNS_INT = 3;
  const deltaSteps = EXTRA_TURNS_INT * 11 + need;
  const target = (curSteps + deltaSteps) * step;

  const SPIN_DURATION_MS = 3800;
  const t0 = performance.now();
  const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

  function frame(now){
    const p = Math.min(1, (now - t0) / SPIN_DURATION_MS);
    const ang = current + (target - current) * easeOutCubic(p);
    drum.style.transform = `translateZ(${-r}px) rotateX(${ang}deg)`;

    if(p < 1){
      st.rafId = requestAnimationFrame(frame);
    } else {
            const snapped = Math.round(target / step) * step;
      drum.style.transform = `translateZ(${-r}px) rotateX(${snapped}deg)`;
      st.currentAngle = snapped;

      const slices = drum.querySelectorAll('.slice');
      const winEl = slices[idx];
      winEl?.classList.add('win');
      const winImg = winEl?.querySelector('img');
      const imgSrc = winImg ? winImg.src : FALLBACK_IMG;

      st.rafId = 0;
      onDone && onDone({ idx, imgSrc });
    }
  }

  cancelAnimationFrame(st.rafId);
  st.rafId = requestAnimationFrame(frame);
}

// превью барабана
function renderPreview(setId){
  render3DReel(setId);
}

// запуск спина
function beginSpin(setId){
  // 1) Оплата «прокрута»
  if (!tryChargeSpin()) {
    // Недостаточно звёзд — спин не запускаем
    return;
  }

  // 2) Дальше — твоя старая логика спина
  if (window.IS_SPINNING) return;
  window.IS_SPINNING = true;

  render3DReel(setId);

  const btn = document.getElementById('spinStartBtn');
  if (btn) btn.disabled = true;

  start3DSpin(setId, ({ imgSrc }) => {
    if (btn) btn.disabled = false;
    window.IS_SPINNING = false;

    // Показать модалку с выигрышем
    openDropModal(imgSrc);
  });
}

backBtn.addEventListener('click', ()=>{
  // Остановить активные анимации барабана
  SPIN_STATE.forEach(st=>{
    if (st.rafId) cancelAnimationFrame(st.rafId);
    st.rafId = 0;
  });

  // Сброс трансформа барабана
  const drum = document.querySelector('.d-thumb .drum');
  if (drum) drum.style.transform = '';

  window.IS_SPINNING = false;
  document.getElementById('spinStartBtn')?.removeAttribute('disabled');

  // Закрыть деталку и вернуть скролл
  detail.classList.remove('show');
  detail.setAttribute('aria-hidden','true');
  lockBody(false);
});

/* =========================================================
   ИНВЕНТАРЬ — PERSISTENCE (localStorage)
   ========================================================= */
function loadInventory(){
  try{
    const raw = localStorage.getItem('gd_inventory');
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){
    return [];
  }
}
function saveInventory(){
  try{
    localStorage.setItem('gd_inventory', JSON.stringify(window.INVENTORY));
  }catch(e){}
}

/* текущее состояние (подхватываем сохранённое) */
window.INVENTORY = loadInventory();   // [{id, img}, ...]

/* ===== FRIENDS / PROMO — PERSISTENCE ===== */
const LS_PROMO_KEY = 'gd_promo_state'; // { draft:"", created:false, code:"" }

function loadPromoState(){
  try{
    const raw = localStorage.getItem(LS_PROMO_KEY);
    const s = raw ? JSON.parse(raw) : null;
    return s && typeof s==='object'
      ? { draft: s.draft || "", created: !!s.created, code: s.code || "" }
      : { draft:"", created:false, code:"" };
  }catch(e){
    return { draft:"", created:false, code:"" };
  }
}
function savePromoState(next){
  try{
    const cur = loadPromoState();
    const merged = { ...cur, ...next };
    localStorage.setItem(LS_PROMO_KEY, JSON.stringify(merged));
  }catch(e){}
}
function clearPromo(){
  try{ localStorage.removeItem(LS_PROMO_KEY); }catch(e){}
}

// Флаг "сейчас редактируем промокод"
const LS_PROMO_EDITING = 'gd_promo_editing';

function setPromoEditing(on){
  try{
    if(on) localStorage.setItem(LS_PROMO_EDITING, '1');
    else   localStorage.removeItem(LS_PROMO_EDITING);
  }catch(e){}
}
function isPromoEditing(){
  try{ return localStorage.getItem(LS_PROMO_EDITING) === '1'; }catch(e){ return false; }
}

// Сбросить черновик и выйти из режима редактирования
function cancelPromoEditing(){
  savePromoState({ draft: "" });
  setPromoEditing(false);
}


function addToInventory(imgSrc){
  if(!imgSrc) return;
  const id = `it_${Date.now()}_${Math.random().toString(36).slice(2,7)}`;
  window.INVENTORY.push({ id, img: imgSrc });
  saveInventory();         // ← сохраняем на диск
  renderInventory();
}

// ===== Переключение между "Кейсы" и "Профиль" =====
const profileScreen = document.getElementById('profileScreen');
const friendsScreen  = document.getElementById('friendsScreen');
const contestsScreen = document.getElementById('contestsScreen');
const upgradesScreen = document.getElementById('upgradesScreen');


const tabsAll = Array.from(document.querySelectorAll('.tabbar .tab'));

const casesTab   = tabsAll.find(t => t.textContent.trim().includes('Кейсы'));
const profileTab =
  document.querySelector('.tabbar .tab[data-tab="inventory"]')
  || tabsAll.find(t => /ИНВЕНТАРЬ|Профиль/i.test(t.textContent.trim()));
const friendsTab = tabsAll.find(t => /Друзья/i.test(t.textContent.trim()));
const contestsTab = tabsAll.find(t => /Конкурсы/i.test(t.textContent.trim()));
const upgradesTab = tabsAll.find(t => /Пропуск/i.test(t.textContent.trim()));

// ===== HAPTIC FEEDBACK (вибрация) =====
function tabHaptic(){
  try{
    if (window.Telegram?.WebApp?.HapticFeedback?.impactOccurred){
      window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
      return;
    }
  }catch(e){}
  if (navigator.vibrate) navigator.vibrate(18);
}

// Делает таб активным визуально
function setActiveTab(tab){
  tabsAll.forEach(t => t.classList.remove('active'));
  tab?.classList.add('active');
}

function hardCloseDetailAndModal(){
  // Закрыть модалку дропа, если открыта
  if (typeof _modalOpen !== 'undefined' && _modalOpen) {
    try { closeDropModal(); } catch(e){}
  }
  // Закрыть detail, если открыт
  if (detail?.classList.contains('show')) {
    try {
      SPIN_STATE.forEach(st=>{ if (st.rafId) cancelAnimationFrame(st.rafId); st.rafId = 0; });
      detail.classList.remove('show');
      detail.setAttribute('aria-hidden','true');
    } catch(e){}
  }
  // Вернуть скролл, если был залочен
  try { lockBody(false); } catch(e){}
}

// Показать экран кейсов (текущая главная)
function showCases(){
  hardCloseDetailAndModal();
cancelPromoEditing(); // если редактировал на вкладке "Друзья" — откатить черновик

contestsScreen.classList.add('hide');
  contestsScreen.setAttribute('aria-hidden','true');

  chipbar.classList.remove('hide');
  content.classList.remove('hide');
  backTop.classList.remove('hide');

  profileScreen.classList.add('hide');
  profileScreen.setAttribute('aria-hidden','true');

  friendsScreen.classList.add('hide');
  friendsScreen.setAttribute('aria-hidden','true');
  upgradesScreen.classList.add('hide');
upgradesScreen.setAttribute('aria-hidden','true');


  setActiveTab(casesTab);
  restoreTopbarIfNeeded();
  document.body.classList.remove('friends-active');
  if (typeof syncTopbarOffset === 'function') syncTopbarOffset();

}

function showProfile(){
  hardCloseDetailAndModal();
cancelPromoEditing(); // если редактировал на вкладке "Друзья" — откатить черновик

contestsScreen.classList.add('hide');
  contestsScreen.setAttribute('aria-hidden','true');

  chipbar.classList.add('hide');
  content.classList.add('hide');
  backTop.classList.add('hide');

  friendsScreen.classList.add('hide');
  friendsScreen.setAttribute('aria-hidden','true');
  upgradesScreen.classList.add('hide');
upgradesScreen.setAttribute('aria-hidden','true');


  profileScreen.innerHTML = `
    <div class="inventory-surface">
      <div class="inventory-page">
        <div class="inventory-header">ИНВЕНТАРЬ</div>
        <div id="inventoryEmpty" class="inventory-empty">ЗДЕСЬ ПОКА НИЧЕГО НЕТ</div>
        <div id="inventoryGrid" class="inventory-grid" style="display:none"></div>
      </div>
    </div>
  `;
  profileScreen.classList.remove('hide');
  profileScreen.setAttribute('aria-hidden','false');

  setActiveTab(profileTab);
  window.scrollTo({ top: 0, behavior: 'smooth' });

  renderInventory();
  restoreTopbarIfNeeded();                          // ← вернём верхний топбар

document.body.classList.remove('friends-active');
if (typeof syncTopbarOffset === 'function') syncTopbarOffset();

}


function renderInventory(){
  const grid  = document.getElementById('inventoryGrid');
  const empty = document.getElementById('inventoryEmpty');
  if(!grid || !empty) return;

  grid.innerHTML = '';

  // Показываем предметы в порядке добавления (новые снизу)
const list = window.INVENTORY || [];

  if (!list.length){
    empty.style.display = 'grid';
    grid.style.display  = 'none';
    return;
  }

  empty.style.display = 'none';
  grid.style.display  = 'grid';

  list.forEach((item, index)=>{
  const card = document.createElement('div');
  card.className = 'inventory-card';
  card.dataset.id = item.id;
  card.innerHTML = `
  <div class="inventory-card-number">№${index + 1}</div>
    <img src="${item.img || FALLBACK_IMG}" alt="предмет" loading="lazy" onerror="this.onerror=null;this.src='${FALLBACK_IMG}'">
    <button type="button" class="inv-sell">ПРОДАТЬ</button>
    <button type="button" class="inv-withdraw">Вывести</button>
  `;
  grid.appendChild(card);

    // Добавляем обработчик для кнопки "Вывести"
    const withdrawBtn = card.querySelector('.inv-withdraw');
    if (withdrawBtn) {
      withdrawBtn.style.pointerEvents = 'auto';
      withdrawBtn.style.cursor = 'pointer';
      withdrawBtn.style.opacity = '1';
      withdrawBtn.style.color = '#e8efff';
      withdrawBtn.style.background = 'linear-gradient(135deg, rgba(22,241,255,.15), rgba(138,92,255,.18))';
      withdrawBtn.style.border = '1px solid rgba(22,241,255,.45)';
      withdrawBtn.style.boxShadow = '0 4px 12px rgba(22,241,255,.2)';
      
      withdrawBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openWithdrawModal();
      });
    }
  });

  // делегирование на кнопки ПРОДАТЬ
  grid.onclick = (e)=>{
    const btn  = e.target.closest('.inv-sell');
    if(!btn) return;
    const card = btn.closest('.inventory-card');
    const id   = card?.dataset.id;
    if(!id) return;

    openConfirmSell(() => sellFromInventory(id, card));
  };
}

/* ===================== FRIENDS v2 ===================== */
const topbarEl = document.querySelector('.topbar');

// флаг «уже нарисовали один раз»
let friendsLoaded = false;

async function renderFriends(forceReload = false){
  if (!friendsScreen) return;

  // если уже загружено и не просили форс-обновление — просто выходим
  if (friendsLoaded && !forceReload) return;

  const TOKEN_ICON = 'assets/images/20251005_0825_Яркое неоновое сияние_remix_01k6sd902pf03ah1w3cpkr66jz.png';
  const invited = await fetchInvited();

  friendsLoaded = true;

  friendsScreen.innerHTML = `
    <div class="friends-header">ДРУЗЬЯ</div>

    <div class="friends-wrap">
      <!-- Промо-блок во всю ширину, без «панели» -->
      <div class="fr-title">Приглашай друзей — Получай награды!</div>
      <div class="fr-sub">Каждый приглашённый друг = <strong>1</strong> <span class="bil">🎟️</span> билет</div>

      <div class="fr-cta-row">
        <button type="button" class="btn btn-primary" id="btnInvite">ПРИГЛАСИТЬ ДРУГА</button>
        <button type="button" class="btn btn-icon" id="btnCopy" title="Скопировать ссылку">📋</button>
        <button type="button" class="btn btn-ghost" id="btnPartner" style="display:none">СТАТЬ ПАРТНЁРОМ</button>
      </div>

      <div class="fr-list-wrap">
        <div class="fr-list-head">
          <span>Приглашённые друзья</span>
          <span>(${invited.length})</span>
        </div>
        <div class="fr-list" id="frList">
          ${
  invited.length
    ? invited.map((u,i)=>`
      <div class="fr-item" role="listitem">
        <div class="n">${i+1}.</div>
        <div class="nm">
          <span class="nm-txt">${esc(u.name || 'Пользователь')}</span>
        </div>
        <div class="gain">
          +1 <img src="${u.photo_url || 'assets/images/20251005_0825_Яркое неоновое сияние_remix_01k6sd902pf03ah1w3cpkr66jz.png'}" alt="" onerror="this.src='assets/images/20251005_0825_Яркое неоновое сияние_remix_01k6sd902pf03ah1w3cpkr66jz.png'">
        </div>
      </div>
    `).join('')
    
    : `<div class="fr-empty">Вы пока никого не пригласили</div>`

}
        </div>
      </div>
    </div>
  `;

// ===== ДЕЙСТВИЯ КНОПОК ПРИГЛАШЕНИЯ/КОПИРОВАНИЯ — ЖЕЛЕЗОБЕТОННЫЙ ВАРИАНТ =====
const tg = window.Telegram && window.Telegram.WebApp;

function showToast(msg){
  if (tg?.showAlert) tg.showAlert(msg);
  else alert(msg);
}

document.getElementById('btnInvite')?.addEventListener('click', async () => {
  const tg = window.Telegram?.WebApp;
const u = tg?.initDataUnsafe?.user;
if(u?.id) await GD.ensureUid8(String(u.id));
  const link = GD.buildInviteLink();
  const text = 'Залетай в GLITCH DROP — ловим дропы вместе!';
  const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`;
  safeOpen(shareUrl); // без любых setTimeout/alert/toast
});

document.getElementById('btnCopy')?.addEventListener('click', async () => {
  await GD.ensureUid8();
  const link = GD.buildInviteLink();
  // остальной код копирования — без изменений

  // 1) Внутри Telegram
  if (tg?.setClipboardText) {
    tg.setClipboardText(link);
    try { tg.HapticFeedback?.notificationOccurred('success'); } catch(_) {}
    tg.showAlert?.('Ссылка скопирована');
    return;
  }

  // 2) Современный Clipboard API
  try {
    await navigator.clipboard.writeText(link);
    showToast('Ссылка скопирована');
    return;
  } catch(_) {}

  // 3) Фолбэк через textarea
  try {
    const ta = document.createElement('textarea');
    ta.value = link;
    ta.setAttribute('readonly','');
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    if (ok) { showToast('Ссылка скопирована'); return; }
  } catch(_) {}

  // 4) Абсолютный фолбэк — просто показать ссылку
  showToast(`Скопируй вручную:\n${link}`);
});


// Партнёрская кнопка — оставим заглушкой (как и было)
const partnerBtn = document.getElementById('btnPartner');
if (window.matchMedia('(min-width:680px)').matches && partnerBtn){
  partnerBtn.style.display = 'inline-block';
  partnerBtn.addEventListener('click', ()=> alert('Стать партнёром (заглушка)'));
}

}


function showFriends(){
  hardCloseDetailAndModal();

contestsScreen.classList.add('hide');
  contestsScreen.setAttribute('aria-hidden','true');

  chipbar.classList.add('hide');
  content.classList.add('hide');
  backTop.classList.add('hide');
  profileScreen.classList.add('hide');
  profileScreen.setAttribute('aria-hidden','true');
  upgradesScreen.classList.add('hide');
upgradesScreen.setAttribute('aria-hidden','true');


  // показать friends
  friendsScreen.classList.remove('hide');
  friendsScreen.setAttribute('aria-hidden','false');

  // прячем только верхний топбар
  topbarEl?.classList.add('hide');

  // нижний таббар ОСТАЁТСЯ видимым — никаких body-классов
  document.body.classList.remove('friends-active');

  setActiveTab(friendsTab);
  window.scrollTo({ top: 0, behavior: 'smooth' });

  // заголовок «Друзья» прижат к самому верху
  document.documentElement.style.setProperty('--topbar-h', '0px');

  renderFriends(true);
}


// вернуть топбар при уходе с «Друзей»
function restoreTopbarIfNeeded(){
  if (friendsScreen?.classList.contains('hide')){
    topbarEl?.classList.remove('hide');
  }
}

function showUpgrades(){
  hardCloseDetailAndModal();

  // вернуть верхний топбар и корректные отступы
  topbarEl?.classList.remove('hide');
  restoreTopbarIfNeeded?.();
  if (typeof syncTopbarOffset === 'function') syncTopbarOffset();
  if (typeof syncTabbarOffset === 'function') syncTabbarOffset();

  // спрятать остальные экраны
  chipbar.classList.add('hide');
  content.classList.add('hide');
  backTop.classList.add('hide');

  profileScreen.classList.add('hide');  profileScreen.setAttribute('aria-hidden','true');
  friendsScreen.classList.add('hide');  friendsScreen.setAttribute('aria-hidden','true');
  contestsScreen.classList.add('hide'); contestsScreen.setAttribute('aria-hidden','true');

  // показать обмен
  upgradesScreen.classList.remove('hide');
  upgradesScreen.setAttribute('aria-hidden','false');

  // отрисовать пропуск (каждый вход — без предпросмотра)
  window.__bpPassPreviewMode = false;
  renderBattlePass();

  setActiveTab(upgradesTab);
  document.body.classList.remove('friends-active');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// === ПУСТОЙ РЕЖИМ ДЛЯ «КОНКУРСОВ» ===

// true — показываем заглушку «Здесь пока что пусто»; false — обычный интерфейс
GD.contestsEmpty = true;

// ===== BATTLE PASS — НАЧИСЛЕНИЕ STARS + PERSIST + COOLDOWN 24H =====
// ✅ МЕНЯЙ СУММЫ ТУТ:
const BP_REWARD_STARS = {
  3: 25,
  7: 75
};

// цена разблокировки пропуска (в валюте баланса)
const BP_PASS_PRICE = 150;

// 24 часа между получением наград (кроме первой)
const BP_COOLDOWN_MS = 24 * 60 * 60 * 1000;

// localStorage keys
const LS_BP_CLAIMED   = 'gd_bp_claimed_v1';         // {"1":true,"2":true,}
const LS_BP_PROGRESS  = 'gd_bp_progress_idx_v1';    // "0.6"
const LS_BP_LASTCLAIM = 'gd_bp_last_claim_ts_v1';   // unix ms
const LS_BP_UNLOCKED  = 'gd_bp_unlocked_v1';        // "1" если пропуск куплен

// TEMP: после обновления страницы снова требуем покупку пропуска
try{ localStorage.removeItem(LS_BP_UNLOCKED); }catch(e){}

function bpLsGet(key, fallback){
  try{
    const v = localStorage.getItem(key);
    return (v === null || v === undefined) ? fallback : v;
  }catch(e){
    return fallback;
  }
}
function bpLsSet(key, val){
  try{ localStorage.setItem(key, val); }catch(e){}
}

// куплен ли пропуск
function bpIsPassUnlocked(){
  try{
    return localStorage.getItem(LS_BP_UNLOCKED) === '1';
  }catch(e){
    return false;
  }
}
function bpSetPassUnlocked(on){
  try{
    if (on){
      localStorage.setItem(LS_BP_UNLOCKED, '1');
    }else{
      localStorage.removeItem(LS_BP_UNLOCKED);
    }
  }catch(e){}
}

function bpLoadClaimed(){
  try{
    const raw = bpLsGet(LS_BP_CLAIMED, '{}');
    const obj = raw ? JSON.parse(raw) : {};
    return (obj && typeof obj === 'object') ? obj : {};
  }catch(e){
    return {};
  }
}
function bpSaveClaimed(map){
  bpLsSet(LS_BP_CLAIMED, JSON.stringify(map || {}));
}

function bpLoadProgress(){
  const n = parseInt(bpLsGet(LS_BP_PROGRESS, '0'), 10);
  return Number.isFinite(n) ? n : 0;
}
function bpSaveProgress(idx){
  bpLsSet(LS_BP_PROGRESS, String((idx|0)));
}

function bpLoadLastClaimTs(){
  const n = parseInt(bpLsGet(LS_BP_LASTCLAIM, '0'), 10);
  return Number.isFinite(n) ? n : 0;
}
function bpSaveLastClaimTs(ts){
  bpLsSet(LS_BP_LASTCLAIM, String((ts|0)));
}

// подхватываем сохранённое
window.__bpClaimedThisRun = bpLoadClaimed();
window.__bpProgressIndex  = (window.__bpProgressIndex ?? bpLoadProgress());

function bpGetRewardStars(id){
  return Number(BP_REWARD_STARS[id] || 0) || 0;
}

function bpRunIsClaimed(id){
  return !!(window.__bpClaimedThisRun && window.__bpClaimedThisRun[String(id)]);
}

function bpRunMarkClaimed(id){
  window.__bpClaimedThisRun[String(id)] = true;
  bpSaveClaimed(window.__bpClaimedThisRun);
}

function bpRunReset(){
  // СБРОС ПРОХОДА ОТКЛЮЧЕН (по ТЗ убрали "Начать заново" и полный сброс наград)
}

function bpCooldownRemainingMs(){
  const last = bpLoadLastClaimTs();
  if (!last) return 0;
  const remain = BP_COOLDOWN_MS - (Date.now() - last);
  return remain > 0 ? remain : 0;
}

function bpFormatCooldown(ms){
  const s = Math.ceil(ms / 1000);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;

  if (h > 0) return `${h}ч ${m}м`;
  if (m > 0) return `${m}м ${sec}с`;
  return `${sec}с`;
}

function bpSyncClaimedUI(tl){
  tl = tl || upgradesScreen?.querySelector?.('.bp-timeline');
  if (!tl) return;

  const items = Array.from(tl.querySelectorAll('.bp-item'));
  const curIdx = (window.__bpProgressIndex ?? 0);
  const curRewardId = curIdx + 1;

  items.forEach((it, i) => {
    const rewardId = i + 1;
    const btn = it.querySelector('.bp-card-btn');
    if (!btn) return;

    if (bpRunIsClaimed(rewardId)){
      btn.textContent = 'Получено';
      btn.classList.remove('cooldown');
      return;
    }

    // для активной награды (кроме первой) показываем таймер, если ещё рано
    if (rewardId === curRewardId && rewardId > 1){
      const left = bpCooldownRemainingMs();
      if (left > 0){
        btn.textContent = `Через ${bpFormatCooldown(left)}`;
        btn.classList.add('cooldown');
        return;
      }
    }

    btn.textContent = 'Получить';
    btn.classList.remove('cooldown');
  });
}

/** Переключить пустой режим конкурсов.
 * Примеры:
 *   GD.setContestsEmpty(false) // показать полноценный интерфейс
 *   GD.setContestsEmpty(true)  // снова показать заглушку
 */
GD.setContestsEmpty = function(on){
  GD.contestsEmpty = !!on;
  // если вкладка уже открыта — перерисуем
  const scr = document.getElementById('contestsScreen');
  if (scr && !scr.classList.contains('hide')) {
    renderContests();
  }
};

function renderContests(){
  const contestsScreen = document.getElementById('contestsScreen');
  if (!contestsScreen) return;

  // ——— ПУСТОЙ РЕЖИМ ———
  if (GD.contestsEmpty){
    // ——— ПУСТОЙ РЕЖИМ ———
contestsScreen.innerHTML = `
  <div class="contests-fixed">
    <div class="contests-header">КОНКУРСЫ</div>

    <div class="inventory-empty">ЗДЕСЬ ПОКА НИЧЕГО НЕТ</div>
  </div>
`;
return;
  }

  // ——— ПОЛНЫЙ ИНТЕРФЕЙС ———
contestsScreen.innerHTML = `
  <div class="contests-fixed contests-surface contests-page">
    <div class="contests-header">КОНКУРСЫ</div>
    <div class="contests-list" id="contList"></div>
  </div>
`;


  const list = document.getElementById('contList');

  const buildLink = (username, link) => {
    const u = String(username || "").trim();
    if (link) return link;
    if (u.startsWith("@")) return `https://t.me/${u.slice(1)}`;
    return "";
  };

  (window.CONTESTS_DATA || []).forEach((item, i) => {
    if (i > 0){
      const sep = document.createElement('div');
      sep.className = 'cont-sep';
      list.appendChild(sep);
    }

    const card = document.createElement('div');
    card.className = 'cont-card';
    const imgUrl = item.img || window.FALLBACK_IMG || 'https://via.placeholder.com/512?text=%F0%9F%8E%81';
    const uname  = item.username || "@username";
    const href   = buildLink(uname, item.link);

    card.innerHTML = `
      <div class="cont-img">
        <img src="${imgUrl}" alt="${esc(uname)}"
             onerror="this.src='${window.FALLBACK_IMG || 'https://via.placeholder.com/512?text=%F0%9F%8E%81'}'">
      </div>
      <div class="cont-right">
        ${href
          ? `<a class="cont-username" href="${href}" target="_blank" rel="noopener" title="${esc(uname)}">${esc(uname)}</a>`
          : `<span class="cont-username" title="${esc(uname)}">${esc(uname)}</span>`}
        ${href ? `<button type="button" class="cont-btn">Подробнее</button>` : ``}
      </div>
    `;
    list.appendChild(card);
  });

  list.addEventListener('click', (e) => {
    const userLink = e.target.closest('.cont-username');
    if (userLink && userLink.href){
      e.preventDefault();
      safeOpen(userLink.href);
      return;
    }
    const btn = e.target.closest('.cont-btn');
    if (btn){
      e.preventDefault();
      const card = btn.closest('.cont-card');
      const link = card?.querySelector('.cont-username')?.href;
      if (link) safeOpen(link);
    }
  }, { passive:false });
}



function showContests(){
  hardCloseDetailAndModal();
// гарантируем видимый верхний топбар и корректные отступы
topbarEl?.classList.remove('hide');
restoreTopbarIfNeeded?.();
if (typeof syncTopbarOffset === 'function') syncTopbarOffset();
if (typeof syncTabbarOffset === 'function') syncTabbarOffset();
  cancelPromoEditing?.();

  // прячем «Кейсы», «Профиль» и «Друзья»
  chipbar.classList.add('hide');
  content.classList.add('hide');
  backTop.classList.add('hide');

  profileScreen.classList.add('hide');
  profileScreen.setAttribute('aria-hidden','true');

  friendsScreen.classList.add('hide');
  friendsScreen.setAttribute('aria-hidden','true');
  upgradesScreen.classList.add('hide');
upgradesScreen.setAttribute('aria-hidden','true');


  // показываем экран конкурсов
  contestsScreen.classList.remove('hide');
  contestsScreen.setAttribute('aria-hidden','false');

  // подменяем контент на наш интерфейс конкурсов
  renderContests();

  // активный таб и корректные отступы
  setActiveTab(contestsTab);
  restoreTopbarIfNeeded();
  document.body.classList.remove('friends-active');
  if (typeof syncTopbarOffset === 'function') syncTopbarOffset();
  if (typeof syncTabbarOffset === 'function') syncTabbarOffset();

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function renderUpgrades(){
  // можно использовать уже существующую поверхность, чтобы фон был единый
  upgradesScreen.innerHTML = `
    <div class="contests-surface"></div>
  `;

}

function syncBattlePassMainLine(){
  const tl = upgradesScreen?.querySelector?.('.bp-timeline');
  if (!tl) return;

  const lineGlow = tl.querySelector('.bp-mainline');
  const lineDim  = tl.querySelector('.bp-mainline-dim');
  const wraps = Array.from(tl.querySelectorAll('.bp-line-wrap'));
  const nodes = Array.from(tl.querySelectorAll('.bp-node'));
  if (!lineGlow || !lineDim || wraps.length < 2 || nodes.length < 2) return;

  const tlRect = tl.getBoundingClientRect();
  const firstW = wraps[0].getBoundingClientRect();

  const nodeSize = nodes[0]?.offsetHeight || 14;
  const r = nodeSize / 2;

  const lastNodeRect  = nodes[nodes.length - 1].getBoundingClientRect();
  const centerX = (firstW.left + firstW.width / 2) - tlRect.left;

  const startY      = (firstW.top - tlRect.top) + r; // старт линии оставляем как был
  const lastCenterY = (lastNodeRect.top + lastNodeRect.height / 2) - tlRect.top;

  const idx = Math.min(
    Math.max(0, (window.__bpProgressIndex ?? 0)),
    nodes.length - 1
  );

  const curRect = nodes[idx].getBoundingClientRect();
  const curCenterY = (curRect.top + curRect.height / 2) - tlRect.top;

const fullLen = Math.max(0, lastCenterY - startY);
const glowLen = Math.max(0, curCenterY - startY);
const dimLen  = Math.max(0, lastCenterY - curCenterY);

const glowScale = fullLen ? Math.min(1, Math.max(0, glowLen / fullLen)) : 0;
const dimScale  = fullLen ? Math.min(1, Math.max(0, dimLen  / fullLen)) : 0;

// светящаяся часть ДО текущей точки (растёт сверху вниз)
lineGlow.style.left   = `${centerX}px`;
lineGlow.style.top    = `${startY}px`;
lineGlow.style.height = `${fullLen}px`;
lineGlow.style.transform = `translate3d(-50%,0,0) scaleY(${glowScale})`;

// тусклая часть ПОСЛЕ текущей точки (сжимается снизу вверх)
lineDim.style.left   = `${centerX}px`;
lineDim.style.top    = `${startY}px`;
lineDim.style.height = `${fullLen}px`;
lineDim.style.transform = `translate3d(-50%,0,0) scaleY(${dimScale})`;

}

function syncBattlePassProgressUI(){
  const tl = upgradesScreen?.querySelector?.('.bp-timeline');
  if (!tl) return;

  const items = Array.from(tl.querySelectorAll('.bp-item'));
  const nodes = Array.from(tl.querySelectorAll('.bp-node'));
  if (!items.length || !nodes.length) return;

  const max = Math.min(items.length, nodes.length) - 1;
  const idx = Math.min(Math.max(0, (window.__bpProgressIndex ?? 0)), max);
  window.__bpProgressIndex = idx;

  // если мы на 7-й и она уже получена в этом проходе — подсветку "активной" гасим
  const lastClaimed = (idx === max && bpRunIsClaimed(7));

  items.forEach((it,i)=>{
    const isLocked = i > idx;
    const isActive = !lastClaimed && i === idx;                 // подсвечиваем ДО нажатия
    const isDone   = i < idx || (lastClaimed && i === idx);     // 7-я тоже "потухнет" после получения

    it.classList.toggle('active', isActive);
    it.classList.toggle('done', isDone);
    it.classList.toggle('locked', isLocked);
  });

  nodes.forEach((nd,i)=>{
    const isLocked = i > idx;
    const isActive = !lastClaimed && i === idx;
    const isDone   = i < idx || (lastClaimed && i === idx);

    nd.classList.toggle('active', isActive);
    nd.classList.toggle('done', isDone);
    nd.classList.toggle('locked', isLocked);
  });
}

function renderBattlePass(){
  if (!upgradesScreen) return;

  upgradesScreen.innerHTML = `
    <div class="contests-surface contests-page">
      <div class="contests-header">ПРОПУСК</div>

      <div class="bp-timeline">
  <div class="bp-mainline"></div>
  <div class="bp-mainline-dim"></div>

        <!-- ЭЛЕМЕНТ ПРОГРЕССА 1 -->
        <div class="bp-item done">
          <div class="bp-line-wrap">
            <div class="bp-node done"></div>
            <div class="bp-line"></div>
          </div>

          <div class="bp-card">
            <div class="bp-card-img">
              <img src="assets/images/подарок(пропуск).png" alt="">
            </div>
            <div class="bp-card-footer">
              <div class="bp-card-title">Награда 1</div>
              <div class="bp-card-btn">Получить</div>
            </div>
          </div>
        </div>

        <!-- ЭЛЕМЕНТ ПРОГРЕССА 2 -->
        <div class="bp-item locked">
          <div class="bp-line-wrap">
            <div class="bp-node locked"></div>
            <div class="bp-line"></div>
          </div>

          <div class="bp-card">
            <div class="bp-card-img">
              <img src="assets/images/букет(пропуск).png" alt="">
            </div>
            <div class="bp-card-footer">
              <div class="bp-card-title">Награда 2</div>
              <div class="bp-card-btn">Получить</div>
            </div>
          </div>
        </div>

        <!-- ЭЛЕМЕНТ ПРОГРЕССА 3 -->
        <div class="bp-item locked">
          <div class="bp-line-wrap">
            <div class="bp-node locked"></div>
            <div class="bp-line"></div>
          </div>

          <div class="bp-card">
            <div class="bp-card-img">
              <img src="assets/images/25рублей.png" alt="">
            </div>
            <div class="bp-card-footer">
              <div class="bp-card-title">Награда 3</div>
              <div class="bp-card-btn">Получить</div>
            </div>
          </div>
        </div>

        <!-- ЭЛЕМЕНТ ПРОГРЕССА 4 -->
        <div class="bp-item locked">
          <div class="bp-line-wrap">
            <div class="bp-node locked"></div>
            <div class="bp-line"></div>
          </div>

          <div class="bp-card">
            <div class="bp-card-img">
              <img src="assets/images/мишка(пропуск).png" alt="">
            </div>
            <div class="bp-card-footer">
              <div class="bp-card-title">Награда 4</div>
              <div class="bp-card-btn">Получить</div>
            </div>
          </div>
        </div>

        <!-- ЭЛЕМЕНТ ПРОГРЕССА 5 -->
        <div class="bp-item locked">
          <div class="bp-line-wrap">
            <div class="bp-node locked"></div>
            <div class="bp-line"></div>
          </div>

          <div class="bp-card">
            <div class="bp-card-img">
              <img src="assets/images/алмаз(пропуск).png" alt="">
            </div>
            <div class="bp-card-footer">
              <div class="bp-card-title">Награда 5</div>
              <div class="bp-card-btn">Получить</div>
            </div>
          </div>
        </div>

        <!-- ЭЛЕМЕНТ ПРОГРЕССА 6 -->
       <div class="bp-item locked">
          <div class="bp-line-wrap">
           <div class="bp-node locked"></div>
            <div class="bp-line"></div>
          </div>

          <div class="bp-card">
            <div class="bp-card-img">
              <img src="assets/images/сердце(пропуск).png" alt="">
            </div>
            <div class="bp-card-footer">
              <div class="bp-card-title">Награда 6</div>
              <div class="bp-card-btn">Получить</div>
            </div>
          </div>
        </div>

        <!-- ЭЛЕМЕНТ ПРОГРЕССА 7 -->
        <div class="bp-item locked">
          <div class="bp-line-wrap">
            <div class="bp-node locked"></div>
            <div class="bp-line"></div>
          </div>

          <div class="bp-card">
            <div class="bp-card-img">
              <img src="assets/images/Untitled (74).png" alt="">
            </div>
            <div class="bp-card-footer">
              <div class="bp-card-title">Награда 7</div>
              <div class="bp-card-btn">Получить</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  `;

      // если пропуск ещё не куплен — ЛОЧИМ СКРОЛЛ до покупки, либо включаем предпросмотр
  try{
    if (!bpIsPassUnlocked()){
      const surface = upgradesScreen.querySelector('.contests-surface');
      if (surface){

        const doBuy = ()=>{
          const price = BP_PASS_PRICE;
          const bal = (typeof getStarsBalance === 'function') ? getStarsBalance() : 0;

          if (bal < price){
            if (typeof showInsufficientFunds === 'function'){
              showInsufficientFunds();
            } else if (typeof showFloatingError === 'function'){
              showFloatingError('Недостаточно средств на балансе');
            } else {
              alert('Недостаточно средств на балансе');
            }
            return;
          }

          if (typeof setStarsBalance === 'function'){
            setStarsBalance(bal - price);
          }
          bpSetPassUnlocked(true);
          window.__bpPassPreviewMode = false;

          try{ lockBody(false); }catch(e){}
          renderBattlePass(); // перерисовать без блокировок/кнопок
        };

        // === РЕЖИМ ПРЕДПРОСМОТРА НАГРАД (скролл включён, награды недоступны, липкая кнопка купить) ===
        if (window.__bpPassPreviewMode){
          try{ lockBody(false); }catch(e){}
          surface.style.touchAction = 'pan-y';

          // "Получить" -> "Недоступно" (серые)
          surface.querySelectorAll('.bp-card-btn').forEach(b=>{
            b.textContent = 'Недоступно';
            b.style.background = 'rgba(255,255,255,0.12)';
            b.style.border = '1px solid rgba(255,255,255,0.18)';
            b.style.color = 'rgba(232,239,255,0.55)';
            b.style.cursor = 'not-allowed';
            b.style.pointerEvents = 'none';
          });

          // маленькая желтая кнопка под топбаром, следует за ним при скролле
          const sticky = document.createElement('div');
          sticky.className = 'bp-sticky-buy';
          sticky.style.position = 'fixed';
          sticky.style.left = '50%';
          sticky.style.top = 'calc(var(--topbar-h, 0px) + 10px)';
          sticky.style.transform = 'translateX(-50%)';
          sticky.style.zIndex = '29';
          sticky.innerHTML = `
            <button type="button" class="bp-buy-pass-btn" style="
              padding:8px 14px;
              border-radius:999px;
              border:none;
              background:#ffd94a;
              color:#1b1300;
              font-weight:900;
              font-size:12px;
              letter-spacing:.08em;
              text-transform:uppercase;
              cursor:pointer;
              box-shadow:0 10px 24px rgba(0,0,0,0.35);
            ">КУПИТЬ ЗА ${BP_PASS_PRICE}₽</button>
          `;
          surface.appendChild(sticky);
          sticky.querySelector('.bp-buy-pass-btn')?.addEventListener('click', doBuy);

        } else {
          // === ЗАБЛОКИРОВАНО (скролл ВЫКЛ, вкладка фиксирована вверху, кнопки по центру) ===
          try{ lockBody(true); }catch(e){}
          surface.style.touchAction = 'none';
          window.scrollTo({ top: 0, behavior: 'auto' });

          const overlay = document.createElement('div');
          overlay.className = 'bp-pay-overlay';
          overlay.style.position = 'fixed';
          overlay.style.inset = '0';
          overlay.style.background = 'rgba(0,0,0,0.6)';
          overlay.style.zIndex = '1000';

          // стоп скролл под оверлеем (iOS/тач)
          overlay.addEventListener('wheel', (ev)=> ev.preventDefault(), { passive:false });
          overlay.addEventListener('touchmove', (ev)=> ev.preventDefault(), { passive:false });

          // ЖЕЛТАЯ КНОПКА РОВНО В ЦЕНТРЕ + СЕРАЯ НИЖЕ
        overlay.innerHTML = `
          <div style="
            background:linear-gradient(180deg, rgba(20,26,62,.92), rgba(10,14,32,.90));
            border-radius:24px;
            padding:22px 18px 18px;
            text-align:center;
            max-width:300px;
            width:100%;
            box-shadow:0 18px 50px rgba(5,10,40,.75), 0 0 60px rgba(22,241,255,.06);
            border:1px solid rgba(255,217,74,0.65);
          ">
            <div style="font-weight:900;font-size:16px;margin-bottom:10px;letter-spacing:.3px;">
              Пропуск заблокирован
            </div>
            <div style="font-size:13px;opacity:.88;margin-bottom:16px;line-height:1.35;">
              Оплати пропуск и забирай ежедневные награды.
            </div>

            <button
              type="button"
              class="bp-buy-pass-btn"
              style="
                width:100%;
                padding:14px 18px;
                border-radius:999px;
                border:1px solid rgba(255,228,122,0.85);
                background:linear-gradient(135deg, #ffe64a, #ffb300);
                color:#241400;
                font-weight:900;
                font-size:14px;
                letter-spacing:.08em;
                text-transform:uppercase;
                cursor:pointer;
                box-shadow:
                  0 12px 32px rgba(255,228,122,0.35),
                  0 0 30px rgba(255,228,122,0.55);
              "
            >
              КУПИТЬ ЗА ${BP_PASS_PRICE}₽
            </button>

            <button
              type="button"
              class="bp-preview-rewards-btn"
              style="
                width:100%;
                margin-top:10px;
                padding:12px 18px;
                border-radius:999px;
                border:1px solid rgba(140,170,255,.22);
                background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
                color:#e8efff;
                font-weight:900;
                font-size:13px;
                letter-spacing:.06em;
                text-transform:uppercase;
                cursor:pointer;
                box-shadow:
                  inset 0 0 18px rgba(255,255,255,.04),
                  0 10px 26px rgba(0,0,0,.35);
              "
            >
              Просмотреть награды
            </button>
          </div>
        `;

          surface.appendChild(overlay);

          overlay.querySelector('.bp-buy-pass-btn')?.addEventListener('click', doBuy);

          overlay.querySelector('.bp-preview-rewards-btn')?.addEventListener('click', ()=>{
            window.__bpPassPreviewMode = true;
            try{ lockBody(false); }catch(e){}
            surface.style.touchAction = 'pan-y';
            renderBattlePass(); // убирает затемнение/кнопки, включает скролл, серит "Получить", добавляет липкую кнопку
          });
        }
      }
    } else {
      // куплен — всё штатно
      window.__bpPassPreviewMode = false;
      const surface = upgradesScreen.querySelector('.contests-surface');
      if (surface) surface.style.touchAction = 'pan-y';
      try{ lockBody(false); }catch(e){}
    }
  }catch(e){
    console.warn('BP buy overlay error', e);
  }

// одна цельная линия строго от центра первой до центра последней точки
// прогресс подхватываем из localStorage и подравниваем под "получено"
{
  const tl0 = upgradesScreen?.querySelector?.('.bp-timeline');
  const items0 = tl0 ? Array.from(tl0.querySelectorAll('.bp-item')) : [];
  const max0 = Math.max(0, items0.length - 1);

  let idx0 = Number(window.__bpProgressIndex);
  if (!Number.isFinite(idx0)) idx0 = 0;

  // сколько подряд уже "Получено" (1..N)
  let claimedCount = 0;
  for (let i = 1; i <= items0.length; i++){
    if (bpRunIsClaimed(i)) claimedCount++;
    else break;
  }

  idx0 = Math.max(idx0, Math.min(claimedCount, max0));
  idx0 = Math.min(Math.max(0, idx0), max0);

  window.__bpProgressIndex = idx0;
  bpSaveProgress(idx0);
}

syncBattlePassProgressUI();
bpSyncClaimedUI();

requestAnimationFrame(syncBattlePassMainLine);
setTimeout(syncBattlePassMainLine, 60);

if (!window.__bpMainLineResizeBound){
  window.__bpMainLineResizeBound = true;
  window.addEventListener('resize', ()=> requestAnimationFrame(syncBattlePassMainLine));
}

// тикер для обновления текста таймера, пока открыт "Пропуск"
if (!window.__bpCooldownTicker){
  window.__bpCooldownTicker = setInterval(()=>{
    if (upgradesScreen?.classList.contains('hide')) return;
    const tl = upgradesScreen?.querySelector?.('.bp-timeline');
    if (!tl) return;

    const curId = (window.__bpProgressIndex ?? 0) + 1;
    if (curId > 1 && !bpRunIsClaimed(curId)){
      bpSyncClaimedUI(tl);
    }
  }, 15000); // раз в 15 сек достаточно
}

if (!window.__bpBattlePassClickBound){
  window.__bpBattlePassClickBound = true;

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.bp-card-btn');
    if (!btn) return;

    const item = btn.closest('.bp-item');
    const tl = btn.closest('.bp-timeline');
    if (!item || !tl) return;

    const items = Array.from(tl.querySelectorAll('.bp-item'));
    const idx = items.indexOf(item);
    if (idx === -1) return;

    const max = items.length - 1;
    const cur = (window.__bpProgressIndex ?? 0);

    // жмём только на текущей (активной) награде
    if (idx !== cur) return;

    const rewardId = idx + 1;

    // без пропуска — ничего не получаем (в т.ч. в режиме предпросмотра)
    if (!bpIsPassUnlocked()) return;

    // если уже получено — ничего не делаем
    if (bpRunIsClaimed(rewardId)){
      bpSyncClaimedUI(tl);
      return;
    }

    // 24ч блок: первая награда доступна сразу, остальные — только спустя 24ч после предыдущей
    if (rewardId > 1){
      const left = bpCooldownRemainingMs();
      if (left > 0){
        if (typeof showFloatingError === 'function'){
          showFloatingError(`Следующая награда будет доступна через ${bpFormatCooldown(left)}`);
        }
        bpSyncClaimedUI(tl);
        return;
      }
    }

    // выдаём STARS, если для этой награды они заданы (у тебя это 3 и 7)
    const add = bpGetRewardStars(rewardId);
    if (add > 0){
      setStarsBalance(getStarsBalance() + add);
    }

    // ✅ предметы в инвентарь для наград 1,2,4,5,6
    if (rewardId === 1 || rewardId === 2 || rewardId === 4 || rewardId === 5 || rewardId === 6){
      const imgEl = item.querySelector('.bp-card-img img');
      const imgSrc = (imgEl && (imgEl.getAttribute('src') || imgEl.src)) || FALLBACK_IMG;
      addToInventory(imgSrc);
      showFloatingInfo('Предмет добавлен в инвентарь');
    }

    // фиксируем "получено" + сохраняем
    bpRunMarkClaimed(rewardId);

    // записываем время получения (для кулдауна следующей награды)
    bpSaveLastClaimTs(Date.now());

    // двигаем прогресс как раньше (кроме последней) + сохраняем
    if (cur < max){
      window.__bpProgressIndex = cur + 1;
    }
    bpSaveProgress(window.__bpProgressIndex ?? cur);

    syncBattlePassProgressUI();
    bpSyncClaimedUI(tl);

    requestAnimationFrame(syncBattlePassMainLine);
  });
}
}

// ===== CONFIRM SELL MODAL =====
const confirmModal = document.getElementById('confirmModal');
const confirmYes   = document.getElementById('confirmYes');
const confirmNo    = document.getElementById('confirmNo');
const confirmText  = document.getElementById('confirmText');

let _confirmOpen = false;
let _confirmOnYes = null;
let _confirmLastFocus = null;

// ===== TOPUP MODAL VARIABLES =====
let idx = 0;                // активный слайд
const COUNT = 5;            // всегда 5
let sliding = false;        // блокируем повторные клики во время анимации
let startX = 0, curX = 0;   // свайпы
let touchActive = false;

function openConfirmSell(onYesCb, text){
  if (!confirmModal) return;

  _confirmOnYes = typeof onYesCb === 'function' ? onYesCb : null;
  if (text && confirmText) confirmText.textContent = text;

  _confirmLastFocus = document.activeElement;

  confirmModal.classList.add('show');
  confirmModal.setAttribute('aria-hidden','false');
  _confirmOpen = true;
  lockBody(true);

  setTimeout(()=> (confirmNo || confirmModal).focus(), 0);

  // колбэк вызываем ДО закрытия модалки
  if (confirmYes) {
    confirmYes.onclick = ()=>{
      const cb = _confirmOnYes;
      if (cb) cb();
      closeConfirmModal();
    };
  }
  if (confirmNo) {
    confirmNo.onclick = ()=> closeConfirmModal();
  }

  document.addEventListener('keydown', _confirmEsc, true);
  confirmModal.addEventListener('click', _confirmBackdrop, true);
  document.addEventListener('keydown', _confirmTrapTab, true);
}


function closeConfirmModal(){
  if (!confirmModal) return;
  confirmModal.classList.remove('show');
  confirmModal.setAttribute('aria-hidden','true');
  _confirmOpen = false;

  // Разблокировать скролл, если нет других экранов/модалок
  const dropIsOpen = typeof _modalOpen !== 'undefined' && _modalOpen;
  if (!detail.classList.contains('show') && !dropIsOpen){
    lockBody(false);
  }

  document.removeEventListener('keydown', _confirmEsc, true);
  confirmModal.removeEventListener('click', _confirmBackdrop, true);
  document.removeEventListener('keydown', _confirmTrapTab, true);

  if (_confirmLastFocus && _confirmLastFocus.focus) _confirmLastFocus.focus();
  _confirmOnYes = null;
}

function _confirmEsc(e){
  if (e.key === 'Escape'){
    e.stopPropagation();
    e.preventDefault();
    closeConfirmModal();
  }
}
function _confirmBackdrop(e){
  const card = confirmModal.querySelector('.modal-card');
  if (!card.contains(e.target)){
    e.stopPropagation();
    e.preventDefault();
    // не закрываем кликом по фону
  }
}
function _confirmTrapTab(e){
  if (e.key !== 'Tab' || !_confirmOpen) return;
  const focusables = confirmModal.querySelectorAll('button, [href], [tabindex]:not([tabindex="-1"])');
  const list = Array.from(focusables).filter(el=>!el.disabled && el.offsetParent !== null);
  if (!list.length) return;
  const first = list[0], last = list[list.length-1];
  if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
  else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
}

function sellFromInventory(id, cardEl){
  // небольшая анимация исчезновения
  if (cardEl){
    cardEl.style.transition = 'transform 160ms ease, opacity 160ms ease';
    cardEl.style.opacity = '0';
    cardEl.style.transform = 'scale(.96)';
  }

  // удаляем элемент из массива
  const arr = window.INVENTORY || [];
  const idx = arr.findIndex(it => it.id === id);
  if (idx !== -1){
    arr.splice(idx, 1);
    saveInventory();
  }

  // перерисовать сетку чуть позже, чтобы анимация успела проиграться
  setTimeout(() => {
    renderInventory();
  }, 170);
}


// Навешиваем клики
if (casesTab){
  casesTab.style.cursor = 'pointer';
  casesTab.addEventListener('click', () => {
    tabHaptic();
    showCases();
  });
}
if (profileTab){
  profileTab.style.cursor = 'pointer';
  profileTab.addEventListener('click', () => {
    tabHaptic();
    showProfile();
  });
}
if (friendsTab){
  friendsTab.style.cursor = 'pointer';
  friendsTab.addEventListener('click', () => {
    tabHaptic();
    showFriends();
  });
}
if (contestsTab){
  contestsTab.style.cursor = 'pointer';
  contestsTab.addEventListener('click', () => {
    tabHaptic();
    showContests();
  });
}
if (upgradesTab){
  upgradesTab.style.cursor = 'pointer';
  upgradesTab.addEventListener('click', () => {
    tabHaptic();
    showUpgrades();
  });
}

// Гарантируем, что при первой загрузке мы в "Кейсах"
showCases();

// заранее подгружаем экран "Друзья" в фоне
renderFriends().catch(()=>{});

// сразу после existing const:
const addBtn    = document.getElementById('addBtn');
const quickMenu = document.getElementById('quickMenu');
const plusWrap  = addBtn?.closest('.plus-wrap'); // ← ДОБАВЬ ЭТО

function toggleQuickMenu(show){
  if (!quickMenu || !addBtn) return;
  const on = (typeof show === 'boolean') ? show : !quickMenu.classList.contains('show');
  quickMenu.classList.toggle('show', on);
  quickMenu.setAttribute('aria-hidden', String(!on));
  addBtn.setAttribute('aria-expanded', String(on));
  plusWrap?.classList.toggle('open', on);     // ← ДОБАВЬ ЭТО

  if (on){
    const first = quickMenu.querySelector('.qm-item');
    setTimeout(()=> first?.focus(), 0);
    document.addEventListener('click', onDocClick, true);
    document.addEventListener('keydown', onMenuKeys, true);
  } else {
    document.removeEventListener('click', onDocClick, true);
    document.removeEventListener('keydown', onMenuKeys, true);
    addBtn.focus();
  }
}


function onDocClick(e){
  if (!quickMenu.contains(e.target) && e.target !== addBtn){
    toggleQuickMenu(false);
  }
}

function onMenuKeys(e){
  if (e.key === 'Escape'){ e.preventDefault(); toggleQuickMenu(false); }
  if (e.key === 'ArrowDown' || e.key === 'ArrowUp'){
    e.preventDefault();
    const items = Array.from(quickMenu.querySelectorAll('.qm-item'));
    const i = items.indexOf(document.activeElement);
    const dir = e.key === 'ArrowDown' ? 1 : -1;
    const next = items[(i + dir + items.length) % items.length] || items[0];
    next?.focus();
  }
}

addBtn?.addEventListener('click', ()=> toggleQuickMenu());

quickMenu?.addEventListener('click', (e)=>{
  console.log('🟡 Quick menu clicked');
  const btn = e.target.closest('.qm-item'); 
  if (!btn) {
    console.log('No menu item clicked');
    return;
  }

  // ===== SETTINGS SCREEN LOGIC =====
const settingsScreen = document.getElementById('settingsScreen');
const settingsBack   = document.getElementById('settingsBack');
const topbarEl       = document.querySelector('.topbar');
const tabbarEl       = document.querySelector('.tabbar');

function showSettings(){
  if (!settingsScreen) return;

  // скрываем все другие экраны как обычно
  try{
    document.querySelectorAll('.app .screen, .app .hide').forEach(el=>{
      if (el !== settingsScreen) el.classList.add('hide');
    });
  }catch(e){}

  settingsScreen.classList.remove('hide');
  settingsScreen.setAttribute('aria-hidden','false');

  // прячем верхний топбар
  if (topbarEl) topbarEl.style.display = 'none';
}

function hideSettings(){
  if (!settingsScreen || settingsScreen.classList.contains('hide')) return;
  settingsScreen.classList.add('hide');
  settingsScreen.setAttribute('aria-hidden','true');

  // возвращаем топбар
  if (topbarEl) topbarEl.style.display = '';
}

// назад -> главное меню "Кейсы"
settingsBack?.addEventListener('click', ()=>{
  hideSettings();
  if (typeof showCases === 'function') showCases();
});

// если жмут по таббару — выкидываем из настроек на выбранную вкладку
tabbarEl?.addEventListener('click', ()=>{
  hideSettings();
}, true);

  const action = btn.dataset.action;
  console.log('Menu action:', action);
  toggleQuickMenu(false);

  switch(action){
    case 'daily':
      document.querySelector('.chipbar .chip')?.click();
      window.scrollTo({ top: 0, behavior:'smooth' });
      break;

case 'topup':
  topupOpen();     // просто открываем модалку пополнения, TON НЕ трогаем
  break;

    case 'settings':
      showSettings();
      break;
  }
});

// ===== TOPUP MODAL - ИСПРАВЛЕННАЯ ВЕРСИЯ =====
let currentSlide = 0;
const totalSlides = 3;
let isAnimating = false;
let touchStartX = 0;
let touchEndX = 0;
// какой способ оплаты выбран
// 0-й слайд — звезды, 1-й — TON → Stars
let currentPaymentMethod = 'stars'; // 'stars' | 'ton' | 'bank'

function initTopupModal() {
    console.log('🔄 Инициализация топ-ап модалки');

    // ===== МАССИВ С URL КАРТИНОК ДЛЯ СЛАЙДОВ =====
    // ЗАМЕНИТЕ ЭТИ URL НА СВОИ ИЗОБРАЖЕНИЯ!
    const slideImages = [
  'assets/images/20251030_1539_Белый текст по центру_remix_01k8thzzsgf4jbcyf41pwnff8y.png',  // Первый слайд
  'assets/images/Untitled (48).png',  // Второй слайд  
  'assets/images/Untitled (50).png'   // Третий слайд
];
    
    // Добавляем изображения в слайды
    const slides = document.querySelectorAll('#topupSlider .slide');
    slides.forEach((slide, index) => {
        // Создаем элемент изображения
        const img = document.createElement('img');
        img.className = 'slide-img';
        img.src = slideImages[index];
        img.alt = `Способ оплаты ${index + 1}`;
        img.loading = 'lazy';
        
        // Обработчик ошибок загрузки изображения
        img.onerror = function() {
            console.error(`❌ Ошибка загрузки изображения для слайда ${index + 1}: ${this.src}`);
            this.style.display = 'none'; // Скрываем если не загрузилось
        };
        
        // Очищаем слайд и добавляем изображение
        slide.innerHTML = '';
        slide.appendChild(img);
    });

    
    // Кнопка закрытия
    const closeBtn = document.querySelector('.topup-close');
    if (closeBtn) {
        closeBtn.addEventListener('click', topupCloseModal);
        console.log('✅ Кнопка закрытия настроена');
    }

    // Стрелки навигации
    const prevBtn = document.querySelector('#topupSlider .nav.prev');
    const nextBtn = document.querySelector('#topupSlider .nav.next');
    
    if (prevBtn) {
        prevBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            goToSlide(currentSlide - 1);
        });
        console.log('✅ Кнопка "назад" настроена');
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            goToSlide(currentSlide + 1);
        });
        console.log('✅ Кнопка "вперед" настроена');
    }

    // Точки навигации
    const dots = document.querySelectorAll('#topupDots .dot');
    dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
            if (!isAnimating) {
                goToSlide(index);
            }
        });
    });
    console.log('✅ Точки навигации настроены');

// Кнопка подтверждения
const confirmBtn = document.getElementById('topupConfirm');
if (confirmBtn) {
  confirmBtn.addEventListener('click', () => {
    // 0-й слайд — пополнение звёздами (как и было)
    if (currentSlide === 0) {
      currentPaymentMethod = 'stars';
      topupAmountOpenModal();
      return;
    }

    // 1-й слайд — пополнение через TON → Stars
    if (currentSlide === 1) {
      currentPaymentMethod = 'ton';
      topupAmountOpenModal();
      return;
    }

        // ✅ 2-й индекс / 3-й слайд — Cardlink / SBP
    if (currentSlide === 2) {
      currentPaymentMethod = 'bank';
      topupAmountOpenModal();
      return;
    }

    // Остальные способы пока заглушка
    alert(`Выбран способ оплаты #${currentSlide + 1}. Функция пополнения баланса будет реализована позже`);
    topupCloseModal();
  });
}

    // Инициализация свайпов
    initSwipe();
    
    // Начальная позиция
    updateSlider();
}

function initSwipe() {
    const slider = document.querySelector('#topupSlider .viewport');
    if (!slider) return;

    slider.addEventListener('touchstart', (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        touchStartX = e.touches[0].clientX;
        touchEndX = touchStartX;
    }, { passive: true });

    slider.addEventListener('touchmove', (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        touchEndX = e.touches[0].clientX;
    }, { passive: true });

    slider.addEventListener('touchend', () => {
        if (isAnimating) return;
        
        const diff = touchStartX - touchEndX;
        const minSwipeDistance = 50;

        if (Math.abs(diff) > minSwipeDistance) {
            if (diff > 0) {
                goToSlide(currentSlide + 1);
            } else {
                goToSlide(currentSlide - 1);
            }
        }
    }, { passive: true });
}

function goToSlide(slideIndex) {
    if (isAnimating) {
        console.log('⏳ Анимация уже выполняется, пропускаем');
        return;
    }

    let newIndex = slideIndex;
    if (newIndex < 0) newIndex = totalSlides - 1;
    if (newIndex >= totalSlides) newIndex = 0;

    if (newIndex === currentSlide) {
        console.log('📍 Уже на этом слайде');
        return;
    }

    console.log(`🔄 Переход со слайда ${currentSlide} на слайд ${newIndex}`);
    currentSlide = newIndex;
    updateSlider();
}

function updateSlider() {
    const track = document.querySelector('#topupSlider .track');
    if (!track) {
        console.error('❌ Трек слайдера не найден');
        return;
    }

    isAnimating = true;
    
    const offset = -currentSlide * 100;
    track.style.transform = `translateX(${offset}%)`;
    
    updateDots();
    
    const onTransitionEnd = () => {
        isAnimating = false;
        track.removeEventListener('transitionend', onTransitionEnd);
    };
    
    track.addEventListener('transitionend', onTransitionEnd);
    
    setTimeout(() => {
        if (isAnimating) {
            isAnimating = false;
            track.removeEventListener('transitionend', onTransitionEnd);
        }
    }, 500);
}

function updateDots() {
    const dots = document.querySelectorAll('#topupDots .dot');
    dots.forEach((dot, index) => {
        const isActive = index === currentSlide;
        dot.classList.toggle('active', isActive);
        dot.setAttribute('aria-selected', isActive.toString());
    });
}

function topupOpen() {
    console.log('🔵 Открытие модалки пополнения баланса');
    
    const topupModal = document.getElementById('topupModal');
    if (!topupModal) {
        console.error('❌ Модалка не найдена');
        return;
    }

    currentSlide = 0;
    isAnimating = false;
    
    topupModal.classList.add('show');
    topupModal.setAttribute('aria-hidden', 'false');
    
    lockBody(true);
    
    setTimeout(() => {
        updateSlider();
    }, 50);
    
    topupModal.addEventListener('click', onBackdropClick, { passive: false });
    document.addEventListener('keydown', onEscKey, true);
    
    console.log('✅ Модалка открыта');
}

function topupCloseModal() {
    console.log('🔴 Закрытие модалки пополнения баланса');
    
    const topupModal = document.getElementById('topupModal');
    if (!topupModal) return;
    
    topupModal.classList.remove('show');
    topupModal.setAttribute('aria-hidden', 'true');
    
    lockBody(false);
    
    topupModal.removeEventListener('click', onBackdropClick, { passive: false });
    document.removeEventListener('keydown', onEscKey, true);
}

function onBackdropClick(e) {
    const card = document.querySelector('.topup-card');
    if (!card || card.contains(e.target)) return;
    
    e.preventDefault();
    e.stopPropagation();
    topupCloseModal();
}

function onEscKey(e) {
    if (e.key === 'Escape') {
        e.preventDefault();
        topupCloseModal();
    }
}

// ===== TOPUP AMOUNT MODAL =====
let isErrorVisible = false;
let errorTimeout = null;

function showFloatingError(message) {
  if (isErrorVisible) return;
  isErrorVisible = true;

  // Удаляем предыдущий
  const existing = document.querySelector('.floating-error');
  if (existing) existing.remove();

  const err = document.createElement('div');
  err.className = 'floating-error';
  err.textContent = message;
  document.body.appendChild(err);

  // Запускаем анимацию появления
  setTimeout(() => err.classList.add('show'), 10);

  // Авто-скрытие через 3 секунды
  errorTimeout = setTimeout(() => {
    err.classList.remove('show');
    setTimeout(() => {
      if (err.parentNode) err.parentNode.removeChild(err);
      isErrorVisible = false;
    }, 400);
  }, 3000);
}

let isInfoVisible = false;
let infoTimeout = null;

function showFloatingInfo(message) {
  if (isInfoVisible) return;
  isInfoVisible = true;

  // Удаляем предыдущий
  const existing = document.querySelector('.floating-info');
  if (existing) existing.remove();

  const box = document.createElement('div');
  box.className = 'floating-info';
  box.textContent = message;
  document.body.appendChild(box);

  setTimeout(() => box.classList.add('show'), 10);

  infoTimeout = setTimeout(() => {
    box.classList.remove('show');
    setTimeout(() => {
      if (box.parentNode) box.parentNode.removeChild(box);
      isInfoVisible = false;
    }, 400);
  }, 2000);
}

function validateAmount(input) {
  const value = input.value.trim();
  
  // Проверяем что введены только цифры и не пусто
  const onlyNumbers = /^\d+$/.test(value);
  
  if (!onlyNumbers || value === '') {
    return {
      valid: false,
      message: "Некорректная сумма"
    };
  }
  
  if (parseInt(value) === 0) {
    return {
      valid: false,
      message: "Сумма должна быть больше нуля"
    };
  }
  
  return {
    valid: true,
    value: parseInt(value)
  };
}

// === Баланс звёзд в топбаре ===
const LS_STARS_KEY = 'gd_stars_balance';
const starsEl = document.getElementById('rubBalance'); // <span id="stars">0</span>

function getStarsBalance() {
  // 1) localStorage если есть, иначе из DOM
  try {
    const v = parseInt(localStorage.getItem(LS_STARS_KEY) || '', 10);
    if (Number.isFinite(v)) return v;
  } catch (_) {}
  return parseInt(starsEl?.textContent || '0', 10) || 0;
}

function setStarsBalance(n) {
  const v = Math.max(0, parseInt(n, 10) || 0);
  if (starsEl) starsEl.textContent = String(v);
  try { localStorage.setItem(LS_STARS_KEY, String(v)); } catch (_) {}
}

// ← при загрузке синхронизируем DOM с localStorage,
//   чтобы если ранее уже пополняли, значение восстановилось
setStarsBalance(getStarsBalance());

// ===== Покупка "прокрута": парсинг цены, списание, алерт "Пополнить" =====
function parseCasePriceStars() {
  const el = document.getElementById('detailPrice');
  const raw = (el?.textContent || '').trim().toUpperCase();
  if (!raw || raw === '—') return 0;                 // нет цены — не списаем
  if (raw.includes('БЕСПЛАТ')) return 0;            // "БЕСПЛАТНО" — не списаем
  if (raw.includes('ЗОЛОТО'))  return 0;            // "за ЗОЛОТО" — пропускаем
  // Ожидаем форматы вида "250 ⭐", "3500⭐", "2000 *" и т.п.
  const m = raw.match(/\d+/);
  return m ? parseInt(m[0], 10) : 0;
}

// Красное уведомление: "Недостаточно средств" + синяя "Пополнить"
function showInsufficientFunds() {
  const html = `Недостаточно средств · <button class="err-topup" type="button">Пополнить</button>`;

  // Сносим предыдущее всплывающее, если есть
  document.querySelectorAll('.floating-error').forEach(n => n.remove());

  const box = document.createElement('div');
  box.className = 'floating-error';
  box.innerHTML = html;
  document.body.appendChild(box);

  // открыть модалку пополнения при клике
  box.querySelector('.err-topup')?.addEventListener('click', (e) => {
    e.preventDefault();
    try { topupOpen(); } catch(_) {}
  });

  // анимация появления/скрытия — как в showFloatingError()
  requestAnimationFrame(() => box.classList.add('show'));
  setTimeout(() => {
    box.classList.remove('show');
    setTimeout(() => box.remove(), 400);
  }, 3000);
}

// Пытаемся списать со звёзд баланс — true если можно крутить
function tryChargeSpin() {
  const price = parseCasePriceStars();
  if (price <= 0) return true;                       // бесплатный/золото — крутить можно

  const bal = getStarsBalance();
  if (bal < price) {
    showInsufficientFunds();
    return false;
  }

  setStarsBalance(bal - price);                      // мгновенное списание (DOM+LS)
  // Если нужно — здесь добавь fetch на бэкенд для фиксации списания
  // fetch(`${window.API_BASE}/api/spins/charge`, { ... })

  return true;
}

// === Синхронизация баланса со сервером поверх localStorage ===
(() => {
  try {
    const tg = window.Telegram && window.Telegram.WebApp;
    const userId = tg?.initDataUnsafe?.user?.id;
    if (!userId) return;

    // ВАЖНО: у тебя API_BASE уже без /api на конце.
    // Эндпоинт у нас /api/user-balance → добавляем его здесь.
    fetch(`${window.API_BASE}/api/user-balance?user_id=${userId}`)
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(data => {
        if (data && typeof data.stars === 'number') {
          // кладём серверный баланс и в DOM, и в localStorage
          // не уменьшаем локальный баланс, пока бэк не догонит
setStarsBalance(Math.max(getStarsBalance(), Number(data?.stars) || 0));
        }
      })
      .catch(e => console.warn('Balance fetch failed:', e));
  } catch (e) {
    console.warn('Balance init failed:', e);
  }
})();

// === Обработка успешной оплаты звёздами ===
(function(){
  const tg = window.Telegram && window.Telegram.WebApp;
  if (!tg || !tg.onEvent) return;

 tg.onEvent('invoiceClosed', (ev) => {
  if (typeof hideTopupLoader === 'function') hideTopupLoader();
    if (ev?.status === 'paid') {
      // Берём сумму последней оплаты (Telegram API перед этим сам выставляет)
      const last = parseInt(localStorage.getItem('gd_last_topup_amount') || '0', 10) || 0;

      // Текущий баланс из localStorage
      const current = parseInt(localStorage.getItem('gd_stars_balance') || '0', 10) || 0;

      // Прибавляем и сохраняем
      const updated = current + last;
      localStorage.setItem('gd_stars_balance', String(updated));

      // Обновляем отображение в интерфейсе
      if (typeof setStarsBalance === 'function') setStarsBalance(updated);

      // Чистим временные данные
      localStorage.removeItem('gd_last_topup_amount');

      // Хаптик на успех
      try { tg.HapticFeedback?.notificationOccurred('success'); } catch(e) {}
    }
  });
})();


// === Глобальный reset баланса до 0 для всех, затем обычная работа ===
(function initStarsBalanceWithGlobalReset(){
  const LS_BAL = 'gd_stars_balance';
  const LS_RESET_FLAG = 'gd_balance_reset_v1'; // увеличить суффикс, если захочешь повторить сброс

  // Один раз обнуляем баланс у всех
  if (localStorage.getItem(LS_RESET_FLAG) !== 'done') {
    localStorage.setItem(LS_BAL, '0');
    localStorage.setItem(LS_RESET_FLAG, 'done');
  }

  // Рисуем текущее значение (после сброса это 0; далее — сохранённые пополнения)
  const current = parseInt(localStorage.getItem(LS_BAL), 10) || 0;
  setStarsBalance(current);
})();

// Минимальное время показа загрузки после нажатия "ПОПОЛНИТЬ" (в мс)
const TOPUP_LOADER_MIN_MS = 700; // меняй это число под себя

// === Глобальный лоадер для пополнения ===
function showTopupLoader(){
  const el = document.getElementById('loaderOverlay');
  if (!el) return;
  el.classList.add('show');
  el.setAttribute('aria-hidden', 'false');
}

function hideTopupLoader(){
  const el = document.getElementById('loaderOverlay');
  if (!el) return;
  el.classList.remove('show');
  el.setAttribute('aria-hidden', 'true');
}

async function handleAmountSubmit() {
  const input = document.getElementById('amountInput');
  const validation = validateAmount(input);
  if (!validation.valid) {
    showFloatingError(validation.message);
    return false;
  }

  const amount = validation.value;

  // 1) сразу показываем кибер-загрузку и запоминаем момент старта
  const loaderShownAt = Date.now();
  showTopupLoader();

  // 2) сохраняем сумму, чтобы потом понять, сколько начислять
  try {
    localStorage.setItem('gd_last_topup_amount', String(amount));
  } catch (_) {}

  // 3) запрос к твоему бэку -> получаем invoice_url
  try {
    const resp = await fetch(`${window.API_BASE}/api/payments/create-stars-invoice`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ amount })
    });
    const data = await resp.json();

    if (!resp.ok || !data.invoice_url) {
      console.error('Create invoice error:', data);
      showFloatingError('Не удалось создать счёт');
      hideTopupLoader(); // ошибка — убираем загрузку сразу
      return false;
    }

    const tg = window.Telegram && window.Telegram.WebApp;

    // 5) открываем окно оплаты Телеги (БЕЗ Stars.open — он глючит на повторных вызовах)
    if (tg?.openInvoice) {
      tg.openInvoice(data.invoice_url); 
    } else {
      // запасной вариант в браузере
      window.open(data.invoice_url, '_blank');
    }

    // 4) закрываем модалку суммы ПОСЛЕ старта открытия инвойса
    topupAmountCloseModal();

    // 6) считаем, сколько уже времени крутится лоадер
    const elapsed = Date.now() - loaderShownAt;
    const remaining = Math.max(0, TOPUP_LOADER_MIN_MS - elapsed);

    // 7) убираем лоадер через оставшееся до минимума время
    setTimeout(() => {
      hideTopupLoader();
    }, remaining);

    return true;
  } catch (e) {
    console.error(e);
    showFloatingError('Сеть недоступна');
    hideTopupLoader(); // при сетевой ошибке тоже убираем
    return false;
  }
}

// ДЕЛАЕМ АСИНХРОННОЙ
async function handleTonSubmit() {
  const input   = document.getElementById('amountInput');
  const errorEl = document.getElementById('amountError');
  if (!input) return false;

  const raw = (input.value || '').trim();

  // Проверка: введена ли целая сумма
  if (!raw || !/^\d+$/.test(raw)) {
    if (errorEl) {
      errorEl.textContent = 'Некорректная сумма';
      errorEl.style.display = 'block';
    }
    return false;
  }

  const ton = parseInt(raw, 10);

  // Минимум
  if (ton < TON_MIN) {
    if (errorEl) {
      errorEl.textContent = `Минимальный депозит ${TON_MIN} TON`;
      errorEl.style.display = 'block';
    }
    return false;
  }

  // Максимум
  if (ton > TON_MAX) {
    if (errorEl) {
      errorEl.textContent = `Максимальный депозит ${formatRu(TON_MAX)} TON`;
      errorEl.style.display = 'block';
    }
    return false;
  }

  // Убираем ошибку
  if (errorEl) {
    errorEl.style.display = 'none';
    errorEl.textContent = '';
  }

  // Сколько звёзд должно прилететь за этот TON-депозит
  const stars = ton * TON_TO_STARS_RATE;

  // Просто для отладки/логики
  window.lastTonTopup = { ton, stars };

   // Проверяем, инициализирован ли TON Connect
  if (!window.tonConnectUI) {
    console.error('TonConnectUI не инициализирован');
    if (typeof showFloatingError === 'function') {
      showFloatingError('TON Connect не инициализирован');
    } else {
      alert('TON Connect не инициализирован');
    }
    return false;
  }

  // ✅ Ставим флаг ожидания оплаты
  window.tonTopupPending = true;

  const savedAddr = localStorage.getItem(LS_TON_WALLET);
  const hasLiveWallet = !!window.tonConnectUI?.wallet;

  // ✅ если кошелек уже привязан/есть сессия — сразу шлём транзакцию
  if (hasLiveWallet || savedAddr) {
    try {
      const ok = await sendTonTopup();
      return ok;
    } finally {
      renderTonWalletLine();
    }
  }

  // ✅ иначе — первый раз привязываем
  try {
    await window.tonConnectUI.openModal();
    // когда кошелёк подключится, onStatusChange вызовет sendTonTopup()
  } catch (e) {
    console.warn('openModal cancelled', e);
    window.tonTopupPending = false;
  }

  return false;

  // Сколько звёзд должно прилететь за этот TON-депозит
const starsToAdd = ton * TON_TO_STARS_RATE;
window.lastTonTopup = { ton, stars: starsToAdd };

  // ✅ Если кошелёк НЕ подключён — открываем привязку и выходим.
  // onStatusChange сам продолжит оплату через sendTonTopup()
  if (!window.tonConnectUI.wallet) {
    window.tonTopupPending = true;
    try {
      await window.tonConnectUI.openModal();
    } catch (e) {
      console.warn('openModal cancelled', e);
      window.tonTopupPending = false;
    }
    return false;
  }

  // ✅ Если кошелёк уже подключён — сразу отправляем оплату
  window.tonTopupPending = true;
  await sendTonTopup();  // отправит транзакцию на ton из input
  return true;
}

// ✅ Cardlink / SBP
const CARDLINK_BASE_URL = 'https://ВАШ_CARDLINK_URL/checkout'; 
// пример: https://pay.cardlink.ru/xxxxxxx  (подставь свой)

function buildCardlinkUrl(amount) {
  // если у тебя другой формат параметров — поменяй тут
  const url = new URL(CARDLINK_BASE_URL);
  url.searchParams.set('amount', String(amount));
  url.searchParams.set('currency', 'RUB');
  return url.toString();
}

function openBankPayModal(amount) {
  const modal = document.getElementById('bankPayModal');
  const frame = document.getElementById('bankPayFrame');
  if (!modal || !frame) return;

  frame.src = buildCardlinkUrl(amount);
  modal.classList.add('show');
  modal.setAttribute('aria-hidden', 'false');
}

function closeBankPayModal() {
  const modal = document.getElementById('bankPayModal');
  const frame = document.getElementById('bankPayFrame');
  if (!modal) return;

  modal.classList.remove('show');
  modal.setAttribute('aria-hidden', 'true');
  if (frame) frame.src = '';
}

// кнопка закрытия
document.getElementById('bankPayCloseBtn')
  ?.addEventListener('click', closeBankPayModal);

  async function handleBankSubmit() {
  const input = document.getElementById('amountInput');
  const errorEl = document.getElementById('amountError');
  if (!input) return false;

  const raw = (input.value || '').trim();
  if (!raw || !/^\d+$/.test(raw)) {
    if (errorEl) {
      errorEl.textContent = 'Некорректная сумма';
      errorEl.style.display = 'block';
    }
    return false;
  }

  const amount = parseInt(raw, 10);

  if (amount < STARS_MIN) {
    if (errorEl) {
      errorEl.textContent = `Минимальная сумма ${STARS_MIN}`;
      errorEl.style.display = 'block';
    }
    return false;
  }

  if (amount > STARS_MAX) {
    if (errorEl) {
      errorEl.textContent = `Максимальная сумма ${formatRu(STARS_MAX)}`;
      errorEl.style.display = 'block';
    }
    return false;
  }

  topupAmountCloseModal();

  // ✅ открываем Cardlink-меню с "Оплатить ..." и QR
  openBankPayModal(amount);

  return true;
}

// ✅ Лимиты для Stars и Cardlink (одинаковые)
const STARS_MIN = 1;
const STARS_MAX = 100000;

const TON_TO_STARS_RATE = 200;
const TON_MIN = 10;
const TON_MAX = 100000;

// Куда летят TON за пополнение (ЗАМЕНИ на свой адрес!)
const TON_RECEIVER_ADDRESS = 'EQB4Sh-FL-1VWxPDao7l3T-5iKXXuxk5VneNrQ7nehdNk5dP'; // TODO: сюда твой TON-адрес

// ===== TON WALLET UI HELPERS =====
const LS_TON_WALLET = window.TON_WALLET_LS_KEY || 'gd_ton_wallet_addr';

function normalizeTonAddr(addr){
  if (!addr) return '';

  const s = String(addr);

  // Если TonConnectUI умеет конвертить в user-friendly — используем
  try {
    if (window.tonConnectUI?.utils?.toUserFriendlyAddress) {
      return window.tonConnectUI.utils.toUserFriendlyAddress(s);
    }
    if (window.TON_CONNECT_UI?.toUserFriendlyAddress) {
      return window.TON_CONNECT_UI.toUserFriendlyAddress(s);
    }
  } catch(e){ /* ignore */ }

  // Фолбэк: если уже UQ/EQ — оставляем
  return s;
}

// формат строго "UQB4...k8qK"
function shortTonAddr(addr){
  const friendly = normalizeTonAddr(addr);
  if (!friendly) return '';
  if (friendly.length <= 10) return friendly;
  return friendly.slice(0,4) + '...' + friendly.slice(-4);
}

function renderTonWalletLine(){
  const line = document.getElementById('tonWalletLine');
  const textEl = document.getElementById('tonWalletShort');
  if (!line || !textEl) return;

  const addr = localStorage.getItem(LS_TON_WALLET);
  if (addr && currentPaymentMethod === 'ton'){
    textEl.textContent = shortTonAddr(addr);
    line.style.display = 'flex';
  } else {
    line.style.display = 'none';
  }
}

// крестик “отвязать”
document.getElementById('tonWalletUnlink')?.addEventListener('click', async (e)=>{
  e.preventDefault();
  e.stopPropagation();

  localStorage.removeItem(LS_TON_WALLET);
  try { await window.tonConnectUI?.disconnect(); } catch(_){}

  renderTonWalletLine();
});

function topupAmountOpenModal() {
  console.log('🔵 Открытие модалки ввода суммы');
  
  const amountModal = document.getElementById('topupAmountModal');
  if (!amountModal) {
    console.error('❌ Модалка ввода суммы не найдена');
    return;
  }
  
  const input   = document.getElementById('amountInput');
  const errorEl = document.getElementById('amountError');
  const metaEl  = document.getElementById('tonMeta');

  // Сбрасываем ошибки
  if (errorEl) {
    errorEl.style.display = 'none';
    errorEl.textContent = '';
  }

  if (input) {
    if (currentPaymentMethod === 'ton') {
      input.placeholder = 'Введите сумму в TON';
      input.value = String(TON_MIN);          // стартуем с 10 TON
      input.dataset.lastValidTon = String(TON_MIN);
    } else {
      input.placeholder = 'Сумма пополнения';
      input.value = '';
      delete input.dataset.lastValidTon;
    }
  }

  // ✅ Стартовое значение инпута
if (input) {
  if (currentPaymentMethod === 'ton') {
    input.value = String(TON_MIN);
    input.dataset.lastValidTon = String(TON_MIN);
  } else {
    input.value = String(STARS_MIN);
    input.dataset.lastValidStars = String(STARS_MIN);
  }
}

  // Показать/спрятать блок с «Вы получите … Stars»
if (metaEl) {
  metaEl.style.display = currentPaymentMethod === 'ton' ? 'flex' : 'none';
}

  // Обновляем текст «Вы получите … Stars»
  updateTonPreview();

  // ✅ показываем/прячем линию кошелька
  renderTonWalletLine();

  amountModal.classList.add('show');
  amountModal.setAttribute('aria-hidden', 'false');

  setTimeout(() => {
    if (input) input.focus();
  }, 100);
  
  amountModal.addEventListener('click', onAmountBackdropClick, { passive: false });
  document.addEventListener('keydown', onAmountEscKey, true);
  
  console.log('✅ Модалка ввода суммы открыта');
}

function formatRu(num) {
  try {
    return num.toLocaleString('ru-RU');
  } catch (_) {
    // fallback, если что
    return String(num);
  }
}

function updateTonPreview() {
  const metaEl   = document.getElementById('tonMeta');
  const textEl   = document.getElementById('tonReceiveText');
  const input    = document.getElementById('amountInput');

  if (!metaEl || !textEl || !input) return;

  if (currentPaymentMethod !== 'ton') {
    metaEl.style.display = 'none';
    return;
  }

  metaEl.style.display = 'flex';

  const raw = (input.value || '').trim();
  const onlyDigits = raw && /^\d+$/.test(raw);
  let ton = onlyDigits ? parseInt(raw, 10) : 0;

  if (!ton) {
    ton = TON_MIN; // если пусто или криво — показываем расчёт от минималки
  }

  const stars = ton * TON_TO_STARS_RATE; // математику не трогаем
textEl.textContent = `Вы получите ${formatRu(stars)}₽`;
}

function topupAmountCloseModal() {
  console.log('🔴 Закрытие модалки ввода суммы');
  
  const amountModal = document.getElementById('topupAmountModal');
  if (!amountModal) return;
  
  amountModal.classList.remove('show');
  amountModal.setAttribute('aria-hidden', 'true');
  
  amountModal.removeEventListener('click', onAmountBackdropClick, { passive: false });
  document.removeEventListener('keydown', onAmountEscKey, true);
  
  // Очищаем таймер если есть
  if (errorTimeout) {
    clearTimeout(errorTimeout);
    errorTimeout = null;
  }
}

function onAmountBackdropClick(e) {
  const card = document.querySelector('#topupAmountModal .modal-card');
  if (!card || card.contains(e.target)) return;
  
  e.preventDefault();
  e.stopPropagation();
  topupAmountCloseModal();
}

function onAmountEscKey(e) {
  if (e.key === 'Escape') {
    e.preventDefault();
    topupAmountCloseModal();
  }
}

function initAmountModal() {
  console.log('🔄 Инициализация модалки ввода суммы');
  
  const input      = document.getElementById('amountInput');
  const confirmBtn = document.getElementById('confirmAmountBtn');
  const cancelBtn  = document.getElementById('cancelAmountBtn');

  // Валидация в реальном времени + обновление превью
  if (input) {
    input.addEventListener('input', function(e) {
      const el      = e.target;
      const errorEl = document.getElementById('amountError');
      const isTon   = (currentPaymentMethod === 'ton');
      let   value   = el.value;

      // Плейсхолдер
      if (value.length > 0) {
        el.placeholder = isTon ? 'Введите сумму в TON' : '';
      } else {
        el.placeholder = isTon ? 'Введите сумму в TON' : 'Сумма пополнения';
      }

      // === РЕЖИМ TON → STARS ===
      if (isTon) {
        // Оставляем только цифры
        value = value.replace(/\D/g, '');
        if (value !== el.value) el.value = value;

        const prev = el.dataset.lastValidTon ?? '';

        // Поле пустое — разрешаем, но напоминаем про минимум
        if (value === '') {
          if (errorEl) {
            errorEl.textContent = `Минимальный депозит ${TON_MIN} TON`;
            errorEl.style.display = 'block';
          }
          el.dataset.lastValidTon = '';
          updateTonPreview();
          return;
        }

        const num = parseInt(value, 10);

        // Меньше минимума — не даём ввести, откат к предыдущему
        if (num < TON_MIN) {
          if (errorEl) {
            errorEl.textContent = `Минимальный депозит ${TON_MIN} TON`;
            errorEl.style.display = 'block';
          }
          el.value = prev;       // цифра не появляется в поле
          updateTonPreview();
          return;
        }

        // Больше максимума — не даём ввести, откат
        if (num > TON_MAX) {
          if (errorEl) {
            errorEl.textContent = `Максимальный депозит ${formatRu(TON_MAX)} TON`;
            errorEl.style.display = 'block';
          }
          el.value = prev;
          updateTonPreview();
          return;
        }

        // Всё ок, число в диапазоне
        if (errorEl) {
          errorEl.style.display = 'none';
          errorEl.textContent = '';
        }
        el.dataset.lastValidTon = String(num);
        el.value = String(num);  // убираем ведущие нули
        updateTonPreview();
        return;
      }

     // === Обычный режим (Stars + Bank) ===
value = value.replace(/\D/g, '');
if (value !== el.value) el.value = value;

const prev = el.dataset.lastValidStars ?? String(STARS_MIN);

// ✅ теперь пустое поле разрешаем (ничего не подставляем)
if (value === '') {
  if (errorEl) {
    errorEl.style.display = 'none';
    errorEl.textContent = '';
  }
  // lastValidStars не трогаем
  return;
}

const num = parseInt(value, 10);

// ✅ ниже минимума — просто показываем ошибку, но НЕ фиксируем значение
if (num < STARS_MIN) {
  if (errorEl) {
    errorEl.textContent = `Минимальная сумма ${STARS_MIN}`;
    errorEl.style.display = 'block';
  }
  // lastValidStars не обновляем, чтобы работал max-кламп
  return;
}

// выше максимума — режем до 50 000 (КАК БЫЛО)
if (num > STARS_MAX) {
  if (errorEl) {
    errorEl.textContent = `Максимальная сумма ${formatRu(STARS_MAX)}`;
    errorEl.style.display = 'block';
  }
  el.value = String(STARS_MAX);
  el.dataset.lastValidStars = String(STARS_MAX);
  return;
}

// всё ок
el.dataset.lastValidStars = String(num);
if (errorEl) {
  errorEl.style.display = 'none';
  errorEl.textContent = '';
}

      // На всякий случай обновим превью (в Stars-режиме оно просто спрячется)
      updateTonPreview();
    });
    
    // Обработка Enter
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (currentPaymentMethod === 'ton') {
          handleTonSubmit();
        } else {
          handleAmountSubmit(); // старый сценарий звёзд
        }
      }
    });
    
    // Восстанавливаем placeholder при потере фокуса если пусто
    input.addEventListener('blur', function(e) {
      if (e.target.value === '') {
        e.target.placeholder = (currentPaymentMethod === 'ton')
          ? 'Введите сумму в TON'
          : 'Сумма пополнения';
      }
    });
  }
  
  // Кнопка подтверждения
  if (confirmBtn) {
    confirmBtn.addEventListener('click', function() {
  if (currentPaymentMethod === 'ton') {
    handleTonSubmit();
  } else if (currentPaymentMethod === 'bank') {
    handleBankSubmit();
  } else {
    handleAmountSubmit(); // stars
  }
});
  }
  
  // Кнопка отмены
  if (cancelBtn) {
    cancelBtn.addEventListener('click', topupAmountCloseModal);
  }
  
  console.log('✅ Модалка ввода суммы инициализирована');
}

// Автоматическая инициализация
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTopupModal);
    document.addEventListener('DOMContentLoaded', initAmountModal);
} else {
    initTopupModal();
    initAmountModal();
}

// === Пополнение после оплаты ===
(function(){
  const tg = window.Telegram && window.Telegram.WebApp;
  if (!tg || !tg.onEvent) return;

 tg.onEvent('invoiceClosed', (ev) => {
    if (ev?.status === 'paid') {
      // Сколько звёзд оплатили — хранится в этом ключе
      const last = parseInt(localStorage.getItem('gd_last_topup_amount') || '0', 10) || 0;

      // Текущий баланс из localStorage
      const current = parseInt(localStorage.getItem('gd_stars_balance') || '0', 10) || 0;

      // Новый баланс
      const updated = current + last;

      // Сохраняем и обновляем интерфейс
      localStorage.setItem('gd_stars_balance', String(updated));
      if (typeof setStarsBalance === 'function') setStarsBalance(updated);

      // Очищаем временные данные и вибрация успеха
      localStorage.removeItem('gd_last_topup_amount');
      try { tg.HapticFeedback?.notificationOccurred('success'); } catch(_) {}
    }
  });
})();


async function sendTonTopup() {
  if (!window.tonConnectUI || !window.lastTonTopup) {
    console.warn('Нет tonConnectUI или данных о пополнении');
    return false;
  }

  const { ton, stars } = window.lastTonTopup;

  // 1) нормализуем ввод (запятая/строка)
  const tonValue = Number(String(ton).replace(",", "."));
  if (!Number.isFinite(tonValue) || tonValue <= 0) {
    showFloatingError?.("Некорректная сумма TON");
    return false;
  }

  // 2) конверт в нанотон через BigInt + защита от нуля
  const amountNanoBI = BigInt(Math.round(tonValue * 1e9));
  if (amountNanoBI <= 0n) {
    showFloatingError?.("Слишком маленькая сумма TON");
    return false;
  }
  const amountNano = amountNanoBI.toString();

  const tx = {
    validUntil: Math.floor(Date.now() / 1000) + 600,
    messages: [
      {
        address: TON_RECEIVER_ADDRESS.trim(),
        amount: amountNano
      }
    ]
  };

  try {
    console.log('[TON TX]', tx);
    const result = await window.tonConnectUI.sendTransaction(tx);
    console.log('[TON TX result]', result);

    applyTonStarsTopup(stars);

    try {
      topupAmountCloseModal();
      topupCloseModal();
    } catch (e) {
      console.warn('Не удалось закрыть модалки после TON', e);
    }

    showFloatingSuccess?.(`Оплата ${tonValue} TON отправлена ✅ Начислено ${formatRu(stars)}₽`);
    return true;

  } catch (e) {
    console.error('Ошибка при отправке транзакции TON:', e);
    showFloatingError?.('Платёж TON отменён или не выполнен');
    return false;

  } finally {
    window.tonTopupPending = false;
    // ВАЖНО: НЕ дисконнектим сразу — Telegram Wallet часто падает из-за этого
    // await window.tonConnectUI.disconnect();
  }
}

</script>

<script>
// ====== КОНСТАНТЫ ======
var tg = window.Telegram && window.Telegram.WebApp;
var LS_BAL  = 'gd_stars_balance';
var LS_LAST = 'gd_last_topup_amount';

// ====== УТИЛИТЫ БАЛАНСА ======
function getStarsBalance() {
  var n = parseInt(localStorage.getItem(LS_BAL) || '0', 10);
  return (isFinite(n) && n > 0) ? n : 0;
}
function setStarsBalance(n) {
  n = Math.max(0, parseInt(n || 0, 10) || 0);
  var el = document.getElementById('rubBalance');
  if (el) el.textContent = String(n);
  localStorage.setItem(LS_BAL, String(n));
  console.log('[stars] UI+LS =>', n);
}

// Восстановить цифру при загрузке
document.addEventListener('DOMContentLoaded', function () {
  setStarsBalance(getStarsBalance());
});

// ЕДИНАЯ ТОЧКА ПРИМЕНЕНИЯ ПОПОЛНЕНИЯ
function applyTopup(amountMaybe) {
  var stored = localStorage.getItem(LS_LAST);
  var last = parseInt(((amountMaybe !== undefined && amountMaybe !== null) ? amountMaybe : stored) || '0', 10) || 0;
  if (!last) return;
  var next = getStarsBalance() + last;
  setStarsBalance(next);
  localStorage.removeItem(LS_LAST);
  console.log('[stars] +', last, '=>', next);
}

// ===== ДОБАВЛЕНО: пополнение звёзд после оплаты TON =====
function applyTonStarsTopup(starsAmount) {
  var stars = parseInt(starsAmount, 10) || 0;
  if (!stars) return;

  var current = getStarsBalance();
  var next = current + stars;

  setStarsBalance(next);
  console.log('[ton] +', stars, '=>', next);
}
// ===== КОНЕЦ ДОБАВЛЕННОГО БЛОКА =====

// ОБЁРТКА ДЛЯ ОТКРЫТИЯ ИНВОЙСА
function openStarsInvoice(amount, invoiceUrlOrSlug) {
  amount = Math.max(0, parseInt(amount, 10) || 0);
  localStorage.setItem(LS_LAST, String(amount));
  console.log('[stars] saved last topup =', amount);

  if (tg && typeof tg.openInvoice === 'function') {
    tg.openInvoice(invoiceUrlOrSlug, function (status) {
      console.log('[stars] openInvoice callback status =', status);
      if (status === 'paid') applyTopup(amount);
    });
  } else {
    console.warn('[stars] tg.openInvoice недоступен. Вероятно, запуск не внутри Telegram WebApp.');
  }
}

// ДУБЛЁР: СОБЫТИЕ invoiceClosed
if (tg && typeof tg.onEvent === 'function') {
  tg.onEvent('invoiceClosed', function (ev) {
    console.log('[stars] invoiceClosed event =', ev);
    if (ev && ev.status === 'paid') applyTopup();
  });
}

// Экспорт "API"
window.Stars = {
  get: getStarsBalance,
  set: setStarsBalance,
  open: openStarsInvoice,
  apply: applyTopup
};

// Готовность WebApp
try { if (tg && tg.ready) tg.ready(); } catch (e) {}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.querySelector('.landing-login-btn');
  const TELEGRAM_MINIAPP_URL = 'https://t.me/Glitchdrop_bot/GlitchDrop'; // <-- твоя рабочая ссылка

  if (!btn) return;

  // Прячем кнопку внутри Telegram mini-app
  const isInTelegram = !!window.Telegram?.WebApp?.initDataUnsafe?.user;
  if (isInTelegram) {
    document.body.classList.add('in-telegram');
    return;
  }

  // На сайте: обычный переход
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = TELEGRAM_MINIAPP_URL;
  });
});

// === КОНФИГУРАЦИЯ МОДЕРАТОРА ===
// ЗДЕСЬ МОЖНО ПОМЕНЯТЬ USERNAME МОДЕРАТОРА
const MODERATOR_USERNAME = 'Glitchdrop_bot'; // Замени на нужный username (без @)

// === ФУНКЦИОНАЛ МОДАЛКИ ВЫВОДА ===
const withdrawModal = document.getElementById('withdrawModal');
const moderatorUsernameEl = document.getElementById('moderatorUsername');
const withdrawCloseBtn = document.getElementById('withdrawCloseBtn');

// Инициализация модалки вывода
function initWithdrawModal() {
  // Устанавливаем username модератора
  if (moderatorUsernameEl) {
    moderatorUsernameEl.textContent = `(@${MODERATOR_USERNAME})`;
    
    // Добавляем обработчик клика на username
    moderatorUsernameEl.addEventListener('click', function() {
      const tgUrl = `https://t.me/${MODERATOR_USERNAME}`;
      safeOpen(tgUrl);
    });
  }

  // Обработчик кнопки закрытия
  if (withdrawCloseBtn) {
    withdrawCloseBtn.addEventListener('click', closeWithdrawModal);
  }

  // Закрытие по клику на фон
  withdrawModal.addEventListener('click', function(e) {
    if (e.target === withdrawModal) {
      closeWithdrawModal();
    }
  });

  // Закрытие по ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !withdrawModal.classList.contains('hide')) {
      closeWithdrawModal();
    }
  });
}

// Открытие модалки вывода
function openWithdrawModal() {
  if (!withdrawModal) return;
  
  withdrawModal.classList.add('show');
  withdrawModal.setAttribute('aria-hidden', 'false');
  lockBody(true);
  
  // Фокусировка на кнопке закрытия
  setTimeout(() => withdrawCloseBtn?.focus(), 0);
}

// Закрытие модалки вывода
function closeWithdrawModal() {
  if (!withdrawModal) return;
  
  withdrawModal.classList.remove('show');
  withdrawModal.setAttribute('aria-hidden', 'true');
  
  // Разблокируем скролл только если нет других открытых модалок
  const dropIsOpen = typeof _modalOpen !== 'undefined' && _modalOpen;
  const confirmIsOpen = typeof _confirmOpen !== 'undefined' && _confirmOpen;
  
  if (!detail.classList.contains('show') && !dropIsOpen && !confirmIsOpen) {
    lockBody(false);
  }
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
  initWithdrawModal();
});

/* =========================
   HIDE LOADER WHEN READY
   ========================= */
(function(){
  const loader = document.getElementById('app-loader');
  if(!loader) return;

  const prevOverflow = document.body.style.overflow;
  document.body.style.overflow = 'hidden';

  window.addEventListener('load', () => {
    loader.classList.add('loaded');

    setTimeout(() => {
      loader.remove();
      document.body.style.overflow = prevOverflow || '';
    }, 260);
  });
})();

</script>

<script>
(function () {
  const tg = window.Telegram && window.Telegram.WebApp;
  const u  = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
  if (!tg || !u) return; // не в Telegram Mini App

  try { tg.ready(); tg.expand && tg.expand(); } catch (_) {}

  // Подстановка ID во все #userId
  function paint(uid8) {
    if (!uid8 || uid8 === '00000000') return;
    document.querySelectorAll('#userId').forEach(el => {
      el.textContent = 'ID ' + uid8;
    });
  }

  // 🔹 КЭШ в памяти: получаем UID один раз
  let uid8Cached = null;

  async function resolveAndPaint() {
    try {
      uid8Cached = await GD.ensureUid8(u.id);  // ← кешируем ОДИН раз
      paint(uid8Cached);
    } catch (e) {
      console.warn('ensureUid8/paint failed', e);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', resolveAndPaint, { once: true });
  } else {
    resolveAndPaint();
  }

  // 🔹 Лёгкий observer: больше НЕ зовём ensureUid8, только перерисовываем по известному uid
  let repaintScheduled = false;
  const mo = new MutationObserver(() => {
    if (repaintScheduled) return;
    repaintScheduled = true;
    setTimeout(() => {
      paint(uid8Cached);
      repaintScheduled = false;
    }, 80);
  });

  // Наблюдаем за body (меньше шума, чем documentElement)
  mo.observe(document.body, { childList: true, subtree: true });

  // Через 3 секунды отключаем observer, чтобы не мешал UI
  setTimeout(() => mo.disconnect(), 3000);
})();

(function(){
  const tg = window.Telegram && window.Telegram.WebApp;
  const userId = tg?.initDataUnsafe?.user?.id;
  if (!userId) return;

  fetch(`${window.API_BASE}/api/user-balance?user_id=${userId}`)
    .then(r => r.json())
    .then(data => {
      if (data && typeof data.stars === 'number') {
        // кладём серверный баланс в UI и localStorage твоими же функциями/ключами
        setStarsBalance(data.stars);
      }
    })
    .catch(err => console.warn('Balance fetch failed', err));
})();

</script>
</body>
</html>
